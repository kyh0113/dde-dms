<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="oracle.yp_zwc_upc">

<select id="select_cb_working_master_v" resultType="HashMap">
/* oracle.yp_zwc_upc.select_cb_working_master_v */
SELECT
	A.CODE,
	A.CODE_NAME
FROM TBL_WORKING_MASTER A
WHERE 1=1
AND A.USE_YN = 'Y'
AND SUBSTR(A.CODE, 1, 1) = 'V'
AND A.ENTERPRISE_GUBUN IN ('1', '2') -- 조업 및 정비 거래처
ORDER BY A.BASE_YYYY, TO_NUMBER(REGEXP_REPLACE(A.CODE, '[^0-9]'))
</select>

<select id="select_tbl_working_ent_cost" resultType="HashMap">
/* oracle.yp_zwc_upc.select_tbl_working_ent_cost */
SELECT *
FROM (
	SELECT
		A.BASE_YYYY,
		A.VENDOR_CODE,
		A.COST_CODE,
		A.COST_AMOUNT
	FROM TBL_WORKING_ENT_COST A
	WHERE 1=1
	AND A.BASE_YYYY = #{BASE_YYYY}
	AND A.VENDOR_CODE = #{VENDOR_CODE}
)
PIVOT(
	MAX(NVL(COST_AMOUNT, 0))
	FOR COST_CODE IN ('C1' AS C1, 'C2' AS C2, 'C3' AS C3, 'C4' AS C4, 'C5' AS C5, 'C6' AS C6, 'C7' AS C7, 'C8' AS C8, 'C9' AS C9, 'C10' AS C10, 'C11' AS C11, 'C12' AS C12, 'C13' AS C13)
)
ORDER BY BASE_YYYY, VENDOR_CODE
</select>

<update id="save_zwc_upc_create">
/* oracle.yp_zwc_upc.save_zwc_upc_create */
MERGE INTO TBL_WORKING_ENT_COST A
USING (
	SELECT
		#{BASE_YYYY} AS BASE_YYYY,
		#{VENDOR_CODE} AS VENDOR_CODE,
		#{COST_CODE} AS COST_CODE
	FROM DUAL
) B
ON (
		A.BASE_YYYY = B.BASE_YYYY
	AND A.VENDOR_CODE = B.VENDOR_CODE
	AND A.COST_CODE = B.COST_CODE
)
WHEN NOT MATCHED THEN
INSERT (
	BASE_YYYY,
	VENDOR_CODE,
	COST_CODE,
	COST_AMOUNT,
	REG_EMP,
	REG_DATE
) VALUES (
	#{BASE_YYYY},
	#{VENDOR_CODE},
	#{COST_CODE},
	TO_NUMBER(REPLACE(#{COST_AMOUNT}, ',', '')),
	#{s_emp_code},
	SYSDATE
)
WHEN MATCHED THEN
UPDATE SET
	COST_AMOUNT = TO_NUMBER(REPLACE(#{COST_AMOUNT}, ',', '')),
	UPD_EMP = #{s_emp_code},
	UPD_DATE = SYSDATE
</update>

<update id="save_zwc_upc_create_price">
/* oracle.yp_zwc_upc.save_zwc_upc_create_price */
MERGE INTO TBL_WORKING_ENT_UNIT_PRICE A
USING (
	/* TBL_WORKING_ENT_UNIT_PRICE 테이블 INSERT를 위한 SELECT 쿼리 */
	SELECT 
		H.BASE_YYYY,
		H.CODE,
		#{VENDOR_CODE} AS VENDOR_CODE,
		G.WORKTYPE_CODE, 
		G.UNIT_PRICE_AMOUNT, 
		G.COST_SUM,
		ROUND(G.UNIT_PRICE_AMOUNT + G.COST_SUM, -2) AS FINAL_UNIT_PRICE, -- 100단위 반올림
		#{s_emp_code},
		SYSDATE
	FROM (
			/* 기준정보의 거래처는 연도가 없으므로 조회조건 파라미터의 연도를 가상으로 설정하여 조회 : 연도와 거래처 정보를 셋팅 */
			SELECT
				#{BASE_YYYY} AS BASE_YYYY,
				CODE,
				CODE_NAME
			FROM TBL_WORKING_MASTER
			WHERE CODE = #{VENDOR_CODE}
		) H 
	LEFT OUTER JOIN 
		(
			SELECT 
				F.BASE_YYYY, F.WORKTYPE_CODE, MAX(F.UNIT_PRICE_AMOUNT) AS UNIT_PRICE_AMOUNT, SUM(F.VALUE) AS COST_SUM
			FROM
			(
				SELECT 
					/* 근무형태별 단가에 거래처별 경비항목을 조인하고, 계산식을 적용하여 값들을 구한다 */
					A.BASE_YYYY, A.WORKTYPE_CODE, A.UNIT_PRICE_AMOUNT, A.PAY_AMOUNT, C.COST_AMOUNT2, D.COST_AMOUNT3, B.COST_CODE, B.COST_AMOUNT,
					CASE WHEN B.COST_CODE ='C1' THEN 0 
 						 WHEN B.COST_CODE ='C2' THEN ROUND((A.PAY_AMOUNT * B.COST_AMOUNT) / 100, 0) /* 2020-10-21 jamerl - 조용래 : 수식변경 - 근무형태별 임금을 단가로 변경  재변경 21.08.03 jjd*/
<!--						 WHEN B.COST_CODE ='C2' THEN ROUND((A.UNIT_PRICE_AMOUNT * B.COST_AMOUNT) / 100, 0) /* 2020-10-21 jamerl - 조용래 : 수식변경 - 근무형태별 임금을 단가로 변경 */ -->
						 WHEN B.COST_CODE ='C3' THEN B.COST_AMOUNT
						 WHEN B.COST_CODE ='C4' THEN B.COST_AMOUNT
						 WHEN B.COST_CODE ='C5' THEN B.COST_AMOUNT
						 WHEN B.COST_CODE ='C6' THEN ROUND(B.COST_AMOUNT / 12 / C.COST_AMOUNT2, 0) /* 2020-10-23 jamerl - 조용래 : 수식변경 - 12 나누기 부활 */
<!-- 						 WHEN B.COST_CODE ='C6' THEN ROUND(B.COST_AMOUNT / C.COST_AMOUNT2, 0) /* 2020-10-21 jamerl - 조용래 : 수식변경 - 12 나누기 제거 */ -->
						 WHEN B.COST_CODE ='C7' THEN ROUND((B.COST_AMOUNT * D.COST_AMOUNT3) / 12 / C.COST_AMOUNT2) /* 2020-10-23 jamerl - 조용래 : 수식변경 - 12 나누기 부활 */
<!-- 						 WHEN B.COST_CODE ='C7' THEN ROUND((B.COST_AMOUNT * D.COST_AMOUNT3) / C.COST_AMOUNT2, 0) /* 2020-10-21 jamerl - 조용래 : 수식변경 - 12 나누기 제거 */ -->
						 WHEN B.COST_CODE ='C8' THEN 0
						 WHEN B.COST_CODE ='C9' THEN ROUND(B.COST_AMOUNT / C.COST_AMOUNT2, 0)
						 WHEN B.COST_CODE ='C10' THEN ROUND(B.COST_AMOUNT / C.COST_AMOUNT2, 0)
						 WHEN B.COST_CODE ='C11' THEN B.COST_AMOUNT /* 2020-09-24 jamerl - 조용래대리 : 단위 '%'를 '원'으로 변경, 따라서 입력한 값을 그대로 사용 */
						 WHEN B.COST_CODE ='C12' THEN ROUND((B.COST_AMOUNT * E.COST_AMOUNT4) / 12 / C.COST_AMOUNT2, 0) /* 2020-10-23 jamerl - 조용래 : 수식변경 - 12 나누기 부활 */
<!-- 						 WHEN B.COST_CODE ='C12' THEN ROUND((B.COST_AMOUNT * E.COST_AMOUNT4) / C.COST_AMOUNT2, 0) /* 2020-10-21 jamerl - 조용래 : 수식변경 - 12 나누기 제거 */ -->
						 WHEN B.COST_CODE ='C13' THEN 0
					ELSE 0 END AS VALUE
				FROM
				(
					SELECT BASE_YYYY, WORKTYPE_CODE, UNIT_PRICE_AMOUNT, PAY_AMOUNT
					FROM TBL_WORKING_UNIT_PRICE
					WHERE BASE_YYYY  = #{BASE_YYYY}
				) A
				LEFT OUTER JOIN 
				(
					/* 각 거래처별 경비항목 SELECT */
					SELECT BASE_YYYY, COST_CODE, COST_AMOUNT
					FROM TBL_WORKING_ENT_COST
					WHERE BASE_YYYY  = #{BASE_YYYY}
					AND VENDOR_CODE = #{VENDOR_CODE}
				) B
				ON A.BASE_YYYY = B.BASE_YYYY
				LEFT OUTER JOIN 
				(
					/* 인원 : 계산식에서 사용하기 위해 별도로 JOIN */
					SELECT BASE_YYYY, COST_AMOUNT AS COST_AMOUNT2
					FROM TBL_WORKING_ENT_COST
					WHERE BASE_YYYY  = #{BASE_YYYY}
					AND VENDOR_CODE = #{VENDOR_CODE}
					AND COST_CODE IN ('C1')
				) C
				ON A.BASE_YYYY = C.BASE_YYYY
				LEFT OUTER JOIN 
				(
					/* 법정교육인원 : 계산식에서 사용하기 위해 별도로 JOIN */
					SELECT BASE_YYYY, COST_AMOUNT AS COST_AMOUNT3
					FROM TBL_WORKING_ENT_COST
					WHERE BASE_YYYY  = #{BASE_YYYY}
					AND VENDOR_CODE = #{VENDOR_CODE}
					AND COST_CODE IN ('C8')
				) D
				ON A.BASE_YYYY = D.BASE_YYYY
				LEFT OUTER JOIN 
				(
					/* 유해화학물질교육인원 : 계산식에서 사용하기 위해 별도로 JOIN */
					SELECT BASE_YYYY, COST_AMOUNT AS COST_AMOUNT4
					FROM TBL_WORKING_ENT_COST
					WHERE BASE_YYYY  = #{BASE_YYYY}
					AND VENDOR_CODE = #{VENDOR_CODE}
					AND COST_CODE IN ('C13')
				) E
				ON A.BASE_YYYY = E.BASE_YYYY
				ORDER BY A.WORKTYPE_CODE, TO_NUMBER(REGEXP_REPLACE(B.COST_CODE, '[^0-9]')) 
			) F
			GROUP BY F.BASE_YYYY, F.WORKTYPE_CODE
		) G
	ON H.BASE_YYYY = G.BASE_YYYY
) B
ON (
		A.BASE_YYYY = B.BASE_YYYY
	AND A.VENDOR_CODE = B.VENDOR_CODE
	AND A.WORKTYPE_CODE = B.WORKTYPE_CODE
)
WHEN NOT MATCHED THEN
INSERT (
	BASE_YYYY,
	VENDOR_CODE,
	WORKTYPE_CODE,
	UNIT_PRICE,
	COST_SUM,
	FINAL_UNIT_PRICE,
	REG_EMP,
	REG_DATE
) VALUES (
	B.BASE_YYYY,
	B.VENDOR_CODE,
	B.WORKTYPE_CODE,
	B.UNIT_PRICE_AMOUNT,
	B.COST_SUM,
	B.FINAL_UNIT_PRICE,
	#{s_emp_code},
	SYSDATE
)
WHEN MATCHED THEN
UPDATE SET
	UNIT_PRICE = B.UNIT_PRICE_AMOUNT,
	COST_SUM = B.COST_SUM,
	FINAL_UNIT_PRICE = B.FINAL_UNIT_PRICE,
	UPD_EMP = #{s_emp_code},
	UPD_DATE = SYSDATE
</update>

<update id="save_zwc_upc_create_price_dt">
/* oracle.yp_zwc_upc.save_zwc_upc_create_price_dt */
MERGE INTO TBL_WORKING_ENT_UNIT_PRICE_DT A
USING (
	-- TBL_WORKING_ENT_UNIT_PRICE_DT 테이블 INSERT를 위한 SELECT 쿼리 
	SELECT 
		F.BASE_YYYY, F.VENDOR_CODE, F.VENDOR_NAME, G.WORKTYPE_CODE, G.COST_CODE, G.VALUE, G.ITEM1, G.ITEM2, G.ITEM3, G.ITEM4
	FROM (
			-- 기준정보의 거래처는 연도가 없으므로 조회조건 파라미터의 연도를 가상으로 설정하여 조회 : 연도와 거래처 정보를 셋팅
			SELECT
				#{BASE_YYYY} AS BASE_YYYY, CODE AS VENDOR_CODE, CODE_NAME AS VENDOR_NAME
			FROM TBL_WORKING_MASTER
			WHERE CODE = #{VENDOR_CODE}
		) F 
	LEFT OUTER JOIN 
		(
			SELECT 
			-- 근무형태별 단가에 거래처별 경비항목을 조인하고, 계산식을 적용하여 값들을 구한다
			A.BASE_YYYY, A.WORKTYPE_CODE, A.PAY_AMOUNT, C.COST_AMOUNT2, D.COST_AMOUNT3, B.COST_CODE, B.COST_AMOUNT,
			CASE WHEN B.COST_CODE ='C1' THEN 0
<!-- 				 WHEN B.COST_CODE ='C2' THEN ROUND((A.UNIT_PRICE_AMOUNT * B.COST_AMOUNT) / 100, 0) /* 2020-10-21 jamerl - 조용래 : 수식변경 - 근무형태별 임금을 단가로 변경 */  -->  <!-- /* 2021-08-03 jjd - 수식변경 (김경준 요청) -->
				 WHEN B.COST_CODE ='C2' THEN ROUND((A.PAY_AMOUNT * B.COST_AMOUNT) / 100, 0)
				 WHEN B.COST_CODE ='C3' THEN B.COST_AMOUNT
				 WHEN B.COST_CODE ='C4' THEN B.COST_AMOUNT
				 WHEN B.COST_CODE ='C5' THEN B.COST_AMOUNT
				 WHEN B.COST_CODE ='C6' THEN ROUND(B.COST_AMOUNT / 12 / C.COST_AMOUNT2, 0) /* 2020-10-21 jamerl - 조용래 : 수식변경 - 12 나누기 부활 */
<!-- 				 WHEN B.COST_CODE ='C6' THEN ROUND(B.COST_AMOUNT / C.COST_AMOUNT2, 0) /* 2020-10-21 jamerl - 조용래 : 수식변경 - 12 나누기 제거 */ -->
				 WHEN B.COST_CODE ='C7' THEN ROUND((B.COST_AMOUNT * D.COST_AMOUNT3) / 12 / C.COST_AMOUNT2, 0) /* 2020-10-23 jamerl - 조용래 : 수식변경 - 12 나누기 부활 */
<!-- 				 WHEN B.COST_CODE ='C7' THEN ROUND((B.COST_AMOUNT * D.COST_AMOUNT3) / C.COST_AMOUNT2, 0) /* 2020-10-21 jamerl - 조용래 : 수식변경 - 12 나누기 제거 */ -->
				 WHEN B.COST_CODE ='C8' THEN 0
				 WHEN B.COST_CODE ='C9' THEN ROUND(B.COST_AMOUNT / C.COST_AMOUNT2, 0)
				 WHEN B.COST_CODE ='C10' THEN ROUND(B.COST_AMOUNT / C.COST_AMOUNT2, 0)
				 WHEN B.COST_CODE ='C11' THEN B.COST_AMOUNT /* 2020-09-24 jamerl - 조용래대리 : 단위 '%'를 '원'으로 변경, 따라서 입력한 값을 그대로 사용 */
				 WHEN B.COST_CODE ='C12' THEN ROUND((B.COST_AMOUNT * E.COST_AMOUNT4) / 12 / C.COST_AMOUNT2, 0) /* 2020-10-21 jamerl - 조용래 : 수식변경 - 12 나누기 부활 */
<!-- 				 WHEN B.COST_CODE ='C12' THEN ROUND((B.COST_AMOUNT * E.COST_AMOUNT4) / C.COST_AMOUNT2, 0) /* 2020-10-21 jamerl - 조용래 : 수식변경 - 12 나누기 제거 */ -->
				 WHEN B.COST_CODE ='C13' THEN 0
			ELSE 0 END AS VALUE,
			CASE WHEN B.COST_CODE ='C1' THEN B.COST_AMOUNT
<!--				 WHEN B.COST_CODE ='C2' THEN A.UNIT_PRICE_AMOUNT -->
				 WHEN B.COST_CODE ='C2' THEN A.PAY_AMOUNT  <!-- /* 2021-08-03 jjd - 수식변경 (김경준 요청) -->
				 WHEN B.COST_CODE ='C3' THEN B.COST_AMOUNT
				 WHEN B.COST_CODE ='C4' THEN B.COST_AMOUNT
				 WHEN B.COST_CODE ='C5' THEN B.COST_AMOUNT
				 WHEN B.COST_CODE ='C6' THEN B.COST_AMOUNT
				 WHEN B.COST_CODE ='C7' THEN B.COST_AMOUNT
				 WHEN B.COST_CODE ='C8' THEN B.COST_AMOUNT
				 WHEN B.COST_CODE ='C9' THEN B.COST_AMOUNT
				 WHEN B.COST_CODE ='C10' THEN B.COST_AMOUNT
				 WHEN B.COST_CODE ='C11' THEN B.COST_AMOUNT
				 WHEN B.COST_CODE ='C12' THEN B.COST_AMOUNT
				 WHEN B.COST_CODE ='C13' THEN B.COST_AMOUNT
			ELSE 0 END AS ITEM1,
			CASE WHEN B.COST_CODE ='C1' THEN 0
				 WHEN B.COST_CODE ='C2' THEN B.COST_AMOUNT 
				 WHEN B.COST_CODE ='C3' THEN 0
				 WHEN B.COST_CODE ='C4' THEN 0
				 WHEN B.COST_CODE ='C5' THEN 0
				 WHEN B.COST_CODE ='C5' THEN 0
				 WHEN B.COST_CODE ='C6' THEN 12
				 WHEN B.COST_CODE ='C7' THEN D.COST_AMOUNT3
				 WHEN B.COST_CODE ='C8' THEN 0
				 WHEN B.COST_CODE ='C9' THEN C.COST_AMOUNT2
				 WHEN B.COST_CODE ='C10' THEN C.COST_AMOUNT2
				 WHEN B.COST_CODE ='C11' THEN 0
				 WHEN B.COST_CODE ='C12' THEN E.COST_AMOUNT4
				 WHEN B.COST_CODE ='C13' THEN 0
			ELSE 0 END AS ITEM2,
			CASE WHEN B.COST_CODE ='C1' THEN 0 
				 WHEN B.COST_CODE ='C2' THEN 0 
				 WHEN B.COST_CODE ='C3' THEN 0
				 WHEN B.COST_CODE ='C4' THEN 0
				 WHEN B.COST_CODE ='C5' THEN 0
				 WHEN B.COST_CODE ='C6' THEN C.COST_AMOUNT2
				 WHEN B.COST_CODE ='C7' THEN 12
				 WHEN B.COST_CODE ='C8' THEN 0
				 WHEN B.COST_CODE ='C9' THEN 0
				 WHEN B.COST_CODE ='C10' THEN 0
				 WHEN B.COST_CODE ='C11' THEN 0
				 WHEN B.COST_CODE ='C12' THEN 12
				 WHEN B.COST_CODE ='C13' THEN 0
			ELSE 0 END AS ITEM3,
			CASE WHEN B.COST_CODE ='C1' THEN 0
				 WHEN B.COST_CODE ='C2' THEN 0 
				 WHEN B.COST_CODE ='C3' THEN 0
				 WHEN B.COST_CODE ='C4' THEN 0
				 WHEN B.COST_CODE ='C5' THEN 0
				 WHEN B.COST_CODE ='C6' THEN 0
				 WHEN B.COST_CODE ='C7' THEN C.COST_AMOUNT2
				 WHEN B.COST_CODE ='C8' THEN 0
				 WHEN B.COST_CODE ='C9' THEN 0
				 WHEN B.COST_CODE ='C10' THEN 0
				 WHEN B.COST_CODE ='C11' THEN 0
				 WHEN B.COST_CODE ='C12' THEN C.COST_AMOUNT2
				 WHEN B.COST_CODE ='C13' THEN 0
			ELSE 0 END AS ITEM4
		FROM
		(
			SELECT BASE_YYYY, WORKTYPE_CODE, PAY_AMOUNT, UNIT_PRICE_AMOUNT
			FROM TBL_WORKING_UNIT_PRICE
			WHERE BASE_YYYY  = #{BASE_YYYY}
		) A
		LEFT OUTER JOIN 
		(
			-- 각 거래처별 경비항목 SELECT
			SELECT BASE_YYYY, COST_CODE, COST_AMOUNT
			FROM TBL_WORKING_ENT_COST
			WHERE BASE_YYYY  = #{BASE_YYYY}
			AND VENDOR_CODE = #{VENDOR_CODE}
		) B
		ON A.BASE_YYYY = B.BASE_YYYY
		LEFT OUTER JOIN 
		(
			-- 인원 : 계산식에서 사용하기 위해 별도로 JOIN
			SELECT BASE_YYYY, COST_AMOUNT AS COST_AMOUNT2
			FROM TBL_WORKING_ENT_COST
			WHERE BASE_YYYY  = #{BASE_YYYY}
			AND VENDOR_CODE = #{VENDOR_CODE}
			AND COST_CODE IN ('C1')
		) C
		ON A.BASE_YYYY = C.BASE_YYYY
		LEFT OUTER JOIN 
		(
			-- 법정교육인원 : 계산식에서 사용하기 위해 별도로 JOIN
			SELECT BASE_YYYY, COST_AMOUNT AS COST_AMOUNT3
			FROM TBL_WORKING_ENT_COST
			WHERE BASE_YYYY  = #{BASE_YYYY}
			AND VENDOR_CODE = #{VENDOR_CODE}
			AND COST_CODE IN ('C8')
		) D
		ON A.BASE_YYYY = D.BASE_YYYY
		LEFT OUTER JOIN 
		(
			-- 법정교육인원 : 계산식에서 사용하기 위해 별도로 JOIN
			SELECT BASE_YYYY, COST_AMOUNT AS COST_AMOUNT4
			FROM TBL_WORKING_ENT_COST
			WHERE BASE_YYYY  = #{BASE_YYYY}
			AND VENDOR_CODE = #{VENDOR_CODE}
			AND COST_CODE IN ('C13')
		) E
		ON A.BASE_YYYY = E.BASE_YYYY
		ORDER BY A.WORKTYPE_CODE, TO_NUMBER(REGEXP_REPLACE(B.COST_CODE, '[^0-9]')) 
	) G
	ON F.BASE_YYYY = G.BASE_YYYY
) B
ON (
		A.BASE_YYYY = B.BASE_YYYY
	AND A.VENDOR_CODE = B.VENDOR_CODE
	AND A.WORKTYPE_CODE = B.WORKTYPE_CODE
	AND A.COST_CODE = B.COST_CODE
)
WHEN NOT MATCHED THEN
INSERT (
	BASE_YYYY,
	VENDOR_CODE,
	WORKTYPE_CODE,
	COST_CODE,
	VALUE,
	ITEM1,
	ITEM2,
	ITEM3,
	ITEM4,
	REG_EMP,
	REG_DATE
) VALUES (
	B.BASE_YYYY,
	B.VENDOR_CODE,
	B.WORKTYPE_CODE,
	B.COST_CODE,
	B.VALUE,
	B.ITEM1,
	B.ITEM2,
	B.ITEM3,
	B.ITEM4,
	#{s_emp_code},
	SYSDATE
)
WHEN MATCHED THEN
UPDATE SET
	VALUE = B.VALUE,
	ITEM1 = B.ITEM1,
	ITEM2 = B.ITEM2,
	ITEM3 = B.ITEM3,
	ITEM4 = B.ITEM4,
	UPD_EMP = #{s_emp_code},
	UPD_DATE = SYSDATE
</update>

<select id="select_cb_working_master_w" resultType="HashMap">
/* oracle.yp_zwc_upc.select_cb_working_master_w */
SELECT
	A.CODE,
	A.CODE_NAME
FROM TBL_WORKING_MASTER A
WHERE 1=1
AND A.USE_YN = 'Y'
AND SUBSTR(A.CODE, 1, 1) = 'W'
ORDER BY A.BASE_YYYY, TO_NUMBER(REGEXP_REPLACE(A.CODE, '[^0-9]'))
</select>

<select id="select_zwc_upc_list_cnt" resultType="Double">
/* oracle.yp_zwc_upc.select_zwc_upc_list_cnt */
SELECT COUNT(*) AS cnt 
    FROM(
    WITH TEMP AS(
         SELECT 
            A.BASE_YYYY,  
            A.VENDOR_CODE,
            B.CODE_NAME as VENDOR_NAME,
            A.WORKTYPE_CODE,
            A.FINAL_UNIT_PRICE
        FROM TBL_WORKING_ENT_UNIT_PRICE A
        INNER JOIN TBL_WORKING_MASTER B
        ON A.VENDOR_CODE = B.CODE
        WHERE  A.BASE_YYYY = #{BASE_YYYY}
		<if test='VENDOR_CODE != null'>
		AND A.VENDOR_CODE = #{VENDOR_CODE}
		</if>
    )
    SELECT *
    FROM TEMP
    PIVOT(
        SUM(FINAL_UNIT_PRICE)
        FOR WORKTYPE_CODE IN ('W1' AS W1, 'W2' AS W2, 'W3' AS W3, 'W4' AS W4, 'W5' AS W5, 'W6' AS E6, 'W7' AS W7)
    )
)
</select>

<select id="select_zwc_upc_list" resultType="java.util.LinkedHashMap">
/* oracle.yp_zwc_upc.select_zwc_upc_list */
SELECT 
    A.BASE_YYYY,  
    A.VENDOR_CODE,
    B.CODE_NAME as VENDOR_NAME,
    A.WORKTYPE_CODE,
    C.CODE_NAME as WORKTYPE_NAME,
    A.FINAL_UNIT_PRICE
FROM TBL_WORKING_ENT_UNIT_PRICE A
INNER JOIN TBL_WORKING_MASTER B
ON A.VENDOR_CODE = B.CODE
INNER JOIN TBL_WORKING_MASTER C
ON A.WORKTYPE_CODE = C.CODE
WHERE  A.BASE_YYYY =  #{BASE_YYYY}
<if test='VENDOR_CODE != null'>
AND A.VENDOR_CODE = #{VENDOR_CODE}
</if>
ORDER BY TO_NUMBER(REGEXP_REPLACE(A.VENDOR_CODE, '[^0-9]')), TO_NUMBER(REGEXP_REPLACE(A.WORKTYPE_CODE, '[^0-9]'))
</select>

<select id="select_zwc_upc_vendor_list" resultType="java.util.LinkedHashMap">
/* oracle.yp_zwc_upc.select_zwc_upc_vendor_list */
SELECT 
    max(A.BASE_YYYY) as BASE_YYYY,  
    max(A.VENDOR_CODE) as VENDOR_CODE,
    max(B.CODE_NAME) as VENDOR_NAME
FROM TBL_WORKING_ENT_UNIT_PRICE A
INNER JOIN TBL_WORKING_MASTER B
ON A.VENDOR_CODE = B.CODE
WHERE  A.BASE_YYYY =  #{BASE_YYYY}
<if test='VENDOR_CODE != null'>
AND A.VENDOR_CODE = #{VENDOR_CODE}
</if>
GROUP BY VENDOR_CODE
ORDER BY TO_NUMBER(REGEXP_REPLACE(VENDOR_CODE, '[^0-9]'))
</select>

<select id="select_zwc_upc_detail_list" resultType="HashMap">
/* oracle.yp_zwc_upc.select_zwc_upc_detail_list */
SELECT M.*
FROM (
		SELECT
		TO_NUMBER(REGEXP_REPLACE(A.COST_CODE, '[^0-9]')) AS SRT,
		CASE
			WHEN A.COST_CODE = 'C12' THEN 2 
			WHEN A.COST_CODE = 'C13' THEN 2
			WHEN A.COST_CODE = 'C9' THEN 3
			WHEN A.COST_CODE = 'C10' THEN 3
			WHEN A.COST_CODE = 'C11' THEN 3
			ELSE 1
		END AS SRT_SUB,
		A.BASE_YYYY,
		A.VENDOR_CODE,
		A.WORKTYPE_CODE,
		A.COST_CODE,
		B.CODE_NAME as COST_NAME,
		VALUE,
		ITEM1,
		ITEM2,
		ITEM3,
		ITEM4
	FROM TBL_WORKING_ENT_UNIT_PRICE_DT A
	LEFT OUTER JOIN TBL_WORKING_MASTER B
	ON A.COST_CODE = B.CODE
	LEFT OUTER JOIN TBL_WORKING_MASTER C
	ON A.VENDOR_CODE = C.CODE
	LEFT OUTER JOIN TBL_WORKING_MASTER D
	ON A.WORKTYPE_CODE = D.CODE
	WHERE A.BASE_YYYY = #{BASE_YYYY}
	AND A.VENDOR_CODE = #{VENDOR_CODE}
	AND A.WORKTYPE_CODE = #{WORKTYPE_CODE}
	
	UNION ALL
	
	SELECT
		9999 AS SRT,
		4 AS SRT_SUB,
		#{BASE_YYYY} as BASE_YYYY,
		#{VENDOR_CODE} as VENDOR_CODE,
		#{WORKTYPE_CODE} as WORKTYPE_CODE,
		'danga' as COST_CODE,
		'단가' as COST_NAME,
		A.FINAL_UNIT_PRICE   as VALUE,
		A.UNIT_PRICE as ITEM1,
		A.COST_SUM as ITEM2,
		0 as ITEM3,
		0 as ITEM4
	FROM TBL_WORKING_ENT_UNIT_PRICE A
	WHERE  A.BASE_YYYY = #{BASE_YYYY}
	AND A.VENDOR_CODE = #{VENDOR_CODE}
	AND A.WORKTYPE_CODE = #{WORKTYPE_CODE}
) M
WHERE 1=1
ORDER BY M.SRT_SUB, M.SRT
</select>

</mapper>