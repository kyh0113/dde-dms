<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="oracle.Login">	
	<select id="ChkId" resultType="Integer">
		/* oracle.Login.ChkId ICM */
		SELECT	
			COUNT(1)
		FROM COM_USER
		WHERE EMP_CODE = #{uid}
	</select>
	
	<select id="ChkIdPwd" resultType="com.vicurus.it.core.common.util.LowerKeyMap">
		/* oracle.Login.ChkIdPwd ICM */
		SELECT	
			    usr.emp_code,
			    usr.emp_name,
			    usr.authogrp_code,
			    usr.dept_code,
			    usr.position_code,
			    case when  PASSWORD_ENC='vLFfghR5tNV3K9DKhmwArV+SbjWAcgZZzIDTnJ0JgCo=' then 'N' else 'Y' end as pwddateyn,
				usr.nowuse_yn,
			    usr.status,
			    case when to_char(SYSDATE,'MM') = '01' or to_char(SYSDATE,'MM') = '02' or to_char(SYSDATE,'MM') = '03' then '1'
					 when to_char(SYSDATE,'MM') = '04' or to_char(SYSDATE,'MM') = '05' or to_char(SYSDATE,'MM') = '06' then '2'
					 when to_char(SYSDATE,'MM') = '07' or to_char(SYSDATE,'MM') = '08' or to_char(SYSDATE,'MM') = '09' then '3'
					 else '4' end as current_month,
				case when substr(nvl(usr.pwchg_date,''),6, 2) = '01' or substr(nvl(usr.pwchg_date,''),6, 2) = '02' or substr(nvl(usr.pwchg_date,''),6, 2) = '03' then '1'
					 when substr(nvl(usr.pwchg_date,''),6, 2) = '04' or substr(nvl(usr.pwchg_date,''),6, 2) = '05' or substr(nvl(usr.pwchg_date,''),6, 2) = '06' then '2'
					 when substr(nvl(usr.pwchg_date,''),6, 2) = '07' or substr(nvl(usr.pwchg_date,''),6, 2) = '08' or substr(nvl(usr.pwchg_date,''),6, 2) = '09' then '3'
					 when substr(nvl(usr.pwchg_date,''),6, 2) = '10' or substr(nvl(usr.pwchg_date,''),6, 2) = '11' or substr(nvl(usr.pwchg_date,''),6, 2) = '12' then '4'
					 else '0' end as quarter_period,
				nvl(usr.pwchg_date,'') as pwchg_date,
				nvl(substr(replace(LOGIN_DATETIME,'-',''),1,8),'') as login_date,
				nvl(to_char(sysdate, 'YYYYMMDD'),'') as today_date,
				nvl(usr.login_ip, '') as login_ip,
				TRUNC(SYSDATE) - TO_DATE(substr(replace(login_datetime,'-',''),1,8), 'YYYYMMDD') as diff_day,
				nvl(auth.init_page, '/') as init_page
		FROM COM_USER usr
		left outer join COM_AUTH auth
		on usr.AUTHOGRP_CODE   = auth.AUTH_ID
		WHERE usr.PASSWORD_ENC = #{upwd} 
		AND   usr.EMP_CODE     = #{uid}		
	</select>
	
	<update id="resetPassword">
	/* oracle.Login.resetPassword */
	update COM_USER
	set password     = #{new_password},
		password_enc = #{upwd},
	    pwchg_date   = to_char(sysdate, 'YYYY-MM-DD')
	where emp_code   = #{emp_code}
	</update>
	
	<update id="InitLoginFailCnt">
	/* oracle.Login.InitLoginFailCnt */
	update COM_USER
	set pwerr_cnt      = 0,
	    login_datetime = TO_CHAR(SYSTIMESTAMP,'YYYYMMDDHH24MIDDSSFF1'),
	    login_ip       = #{ip}
	where emp_code     = #{emp_code}
	</update>
	
	<update id="LoginFail">
	/* oracle.Login.LoginFail */
	update COM_USER
	set pwerr_cnt           = pwerr_cnt + 1,
	    login_fail_datetime = TO_CHAR(SYSTIMESTAMP,'YYYYMMDDHH24MIDDSSFF1')	--로그인실패일시를 담는컬럼
	where emp_code          = #{uid}
	</update>
	
	<select id="GetLoginFailCnt" resultType="Integer">
	/* oracle.Login.GetLoginFailCnt */
	select pwerr_cnt
	from COM_USER
	where 1 = 1
	and emp_code = #{uid}
	</select>
</mapper>