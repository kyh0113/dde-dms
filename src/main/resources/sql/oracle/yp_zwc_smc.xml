<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="oracle.yp_zwc_smc">

<select id="select_zwc_smc_cnt" resultType="double">
/* oracle.yp_zwc_smc.select_zwc_smc_cnt */
SELECT
	COUNT(*) AS CNT
FROM (
	SELECT
		#{BASE_YYYY} AS BASE_YYYY,
		S.CODE AS VENDOR_CODE
	FROM TBL_WORKING_MASTER S
	WHERE 1=1
	AND S.USE_YN = 'Y'
	AND SUBSTR(S.CODE, 1, 1) = 'V'
	AND S.ENTERPRISE_GUBUN IN ('1', '2') -- 조업 및 정비 거래처
) A
LEFT OUTER JOIN TBL_WORKING_SAVE_MONEY_COST B
	ON A.BASE_YYYY = B.BASE_YYYY
	AND A.VENDOR_CODE = B.VENDOR_CODE
WHERE 1=1
AND A.BASE_YYYY = #{BASE_YYYY}
<if test='VENDOR_CODE != null'>
AND A.VENDOR_CODE = #{VENDOR_CODE}
</if>
</select>

<select id="select_zwc_smc" resultType="HashMap">
/* oracle.yp_zwc_smc.select_zwc_smc */
SELECT
	A.BASE_YYYY,
	A.VENDOR_CODE,
	(SELECT S.CODE_NAME FROM TBL_WORKING_MASTER S WHERE SUBSTR(S.CODE, 1, 1) = 'V' AND S.CODE = A.VENDOR_CODE) AS VENDOR_NAME,
	NVL(B.MONTH1, 0) AS MONTH1,
	NVL(B.MONTH2, 0) AS MONTH2,
	NVL(B.MONTH3, 0) AS MONTH3,
	NVL(B.MONTH4, 0) AS MONTH4,
	NVL(B.MONTH5, 0) AS MONTH5,
	NVL(B.MONTH6, 0) AS MONTH6,
	NVL(B.MONTH7, 0) AS MONTH7,
	NVL(B.MONTH8, 0) AS MONTH8,
	NVL(B.MONTH9, 0) AS MONTH9,
	NVL(B.MONTH10, 0) AS MONTH10,
	NVL(B.MONTH11, 0) AS MONTH11,
	NVL(B.MONTH12, 0) AS MONTH12
FROM (
	SELECT
		#{BASE_YYYY} AS BASE_YYYY,
		S.CODE AS VENDOR_CODE
	FROM TBL_WORKING_MASTER S
	WHERE 1=1
	AND S.USE_YN = 'Y'
	AND SUBSTR(S.CODE, 1, 1) = 'V'
	AND S.ENTERPRISE_GUBUN IN ('1', '2') -- 조업 및 정비 거래처
) A
LEFT OUTER JOIN TBL_WORKING_SAVE_MONEY_COST B
	ON A.BASE_YYYY = B.BASE_YYYY
	AND A.VENDOR_CODE = B.VENDOR_CODE
WHERE 1=1
AND A.BASE_YYYY = #{BASE_YYYY}
<if test='VENDOR_CODE != null'>
AND A.VENDOR_CODE = #{VENDOR_CODE}
</if>
</select>

<select id="select_cb_working_master_v" resultType="HashMap">
/* oracle.yp_zwc_smc.select_cb_working_master_v */
SELECT
	A.CODE,
	A.CODE_NAME
FROM TBL_WORKING_MASTER A
WHERE 1=1
AND A.USE_YN = 'Y'
AND SUBSTR(A.CODE, 1, 1) = 'V'
AND A.ENTERPRISE_GUBUN IN ('1', '2') -- 조업 및 정비 거래처
ORDER BY A.BASE_YYYY, TO_NUMBER(REGEXP_REPLACE(A.CODE, '[^0-9]'))
</select>

<update id="merge_zwc_smc">
/* oracle.yp_zwc_smc.merge_zwc_smc */
MERGE INTO TBL_WORKING_SAVE_MONEY_COST A
USING (
	SELECT
		#{BASE_YYYY} AS BASE_YYYY,
		#{VENDOR_CODE} AS VENDOR_CODE,
		#{MONTH1} AS MONTH1,
		#{MONTH2} AS MONTH2,
		#{MONTH3} AS MONTH3,
		#{MONTH4} AS MONTH4,
		#{MONTH5} AS MONTH5,
		#{MONTH6} AS MONTH6,
		#{MONTH7} AS MONTH7,
		#{MONTH8} AS MONTH8,
		#{MONTH9} AS MONTH9,
		#{MONTH10} AS MONTH10,
		#{MONTH11} AS MONTH11,
		#{MONTH12} AS MONTH12,
		#{s_emp_code} AS REG_EMP,
		SYSDATE AS REG_DATE,
		#{s_emp_code} AS UPD_EMP,
		SYSDATE AS UPD_DATE
	FROM DUAL
) B
ON (
		A.BASE_YYYY = B.BASE_YYYY
	AND A.VENDOR_CODE = B.VENDOR_CODE
)
WHEN NOT MATCHED THEN
INSERT (
	BASE_YYYY,
	VENDOR_CODE,
	MONTH1,
	MONTH2,
	MONTH3,
	MONTH4,
	MONTH5,
	MONTH6,
	MONTH7,
	MONTH8,
	MONTH9,
	MONTH10,
	MONTH11,
	MONTH12,
	REG_EMP,
	REG_DATE
) VALUES (
	B.BASE_YYYY,
	B.VENDOR_CODE,
	B.MONTH1,
	B.MONTH2,
	B.MONTH3,
	B.MONTH4,
	B.MONTH5,
	B.MONTH6,
	B.MONTH7,
	B.MONTH8,
	B.MONTH9,
	B.MONTH10,
	B.MONTH11,
	B.MONTH12,
	B.REG_EMP,
	B.REG_DATE
)
WHEN MATCHED THEN
UPDATE SET
	MONTH1 = B.MONTH1,
	MONTH2 = B.MONTH2,
	MONTH3 = B.MONTH3,
	MONTH4 = B.MONTH4,
	MONTH5 = B.MONTH5,
	MONTH6 = B.MONTH6,
	MONTH7 = B.MONTH7,
	MONTH8 = B.MONTH8,
	MONTH9 = B.MONTH9,
	MONTH10 = B.MONTH10,
	MONTH11 = B.MONTH11,
	MONTH12 = B.MONTH12,
	UPD_EMP = B.UPD_EMP,
	UPD_DATE = B.UPD_DATE
</update>

</mapper>