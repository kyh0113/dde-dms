<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="oracle.yp_zwc_ipt2">

<select id="select_cb_tbl_working_subc" resultType="HashMap">
/* oracle.yp_zwc_ipt2.select_cb_tbl_working_subc */
SELECT
	A.BASE_YYYY,
	A.CONTRACT_CODE AS CODE,
	'(' || A.BASE_YYYY || ') ' || A.CONTRACT_NAME AS CODE_NAME
FROM TBL_WORKING_SUBC A
WHERE 1=1
<if test="VENDOR_CODE != null">
AND A.VENDOR_CODE = #{VENDOR_CODE}
</if>
<if test="BASE_YYYY != null">
AND A.BASE_YYYY = #{BASE_YYYY}
</if>
ORDER BY A.BASE_YYYY, TO_NUMBER(REGEXP_REPLACE(A.CONTRACT_CODE, '[^0-9]'))
</select>

<select id="select_cb_working_master_v" resultType="HashMap">
/* oracle.yp_zwc_ipt2.select_cb_working_master_v */
SELECT
	A.CODE,
	A.CODE_NAME
FROM TBL_WORKING_MASTER A
WHERE 1=1
AND A.USE_YN = 'Y'
AND SUBSTR(A.CODE, 1, 1) = 'V'
AND A.ENTERPRISE_GUBUN IN ('1', '2') -- 조업 및 정비 거래처
ORDER BY A.BASE_YYYY, TO_NUMBER(REGEXP_REPLACE(A.CODE, '[^0-9]'))
</select>

<select id="select_cb_tbl_working_subc_approval" resultType="HashMap">
/* oracle.yp_zwc_ipt2.select_cb_tbl_working_subc_approval */
SELECT
	A.BASE_YYYY,
	A.CONTRACT_CODE AS CODE,
	'(' || A.BASE_YYYY || ') ' || A.CONTRACT_NAME AS CODE_NAME
FROM TBL_WORKING_SUBC A
WHERE 1=1
<if test="VENDOR_CODE != null">
AND A.VENDOR_CODE = #{VENDOR_CODE}
</if>
<if test="BASE_YYYY != null">
AND A.BASE_YYYY = #{BASE_YYYY}
</if>
ORDER BY A.BASE_YYYY, TO_NUMBER(REGEXP_REPLACE(A.CONTRACT_CODE, '[^0-9]'))
</select>

<select id="select_zwc_ipt2_daily_create_worker_popup_list" resultType="HashMap">
/* oracle.yp_zwc_ipt2.select_zwc_ipt2_daily_create_worker_popup_list */
SELECT
	  a.SUBC_CODE
	, b.SUBC_NAME
	, a.WORKTYPE_CODE
	, CASE a.WORKTYPE_CODE WHEN 'W1' THEN '상갑반' ELSE '교대근무' END AS WORKTYPE_NAME
FROM TBL_WORKING_SUBCWORKER_MAP a
INNER JOIN TBL_ENTERPRISE_ACCESS_CONTROL b
	ON a.SUBC_CODE = b.SUBC_CODE
WHERE 1=1
AND a.BASE_YYYY = #{BASE_YYYY}
AND a.VENDOR_CODE = #{VENDOR_CODE}
AND a.CONTRACT_CODE = #{CONTRACT_CODE}
</select>

<select id="select_zwc_ipt2_daily_create_worker_popup_list_cnt" resultType="double">
/* oracle.yp_zwc_ipt2.select_zwc_ipt2_daily_create_worker_popup_list_cnt */
SELECT COUNT(*)
FROM TBL_WORKING_SUBCWORKER_MAP a
INNER JOIN TBL_ENTERPRISE_ACCESS_CONTROL b
	ON a.SUBC_CODE = b.SUBC_CODE
WHERE 1=1
AND a.BASE_YYYY = #{BASE_YYYY}
AND a.VENDOR_CODE = #{VENDOR_CODE}
AND a.CONTRACT_CODE = #{CONTRACT_CODE}
</select>

<select id="select_tbl_working_daily_report" resultType="HashMap">
/* oracle.yp_zwc_ipt2.select_tbl_working_daily_report */
SELECT
	  M.BASE_YYYY
	, M.VENDOR_CODE
	, M.CONTRACT_CODE
	, M.BASE_YYYYMMDD
	, M.SUBC_CODE_PK
	, M.SUBC_CODE
	, M.VENDOR_NAME
	, M.CONTRACT_NAME
	, M.SUBC_NAME
	, M.WORKTYPE_CODE
	, M.DATA_TYPE
	, M.DATA_STATUS
	, M.A_START_DATE
	, M.A_START_DATE_TIME
	, M.A_END_DATE
	, M.A_END_DATE_TIME
	, M.EXTENSION_HOUR
	, M.HOLIDAY_HOUR
	, M.NIGHT_HOUR
	, M.LATE_HOUR
	, M.COMMENTS
	, M.CONFIRM_YN
FROM (
	SELECT
		  a.BASE_YYYY
		, a.VENDOR_CODE
		, a.CONTRACT_CODE
		, a.BASE_YYYYMMDD
		, a.SUBC_CODE AS SUBC_CODE_PK
		, a.SUBC_CODE
		, a.VENDOR_NAME
		, a.CONTRACT_NAME
		, a.SUBC_NAME
		, a.WORKTYPE_CODE
		, a.DATA_TYPE
		, a.DATA_STATUS
		, TO_CHAR( a.A_START_DATE, 'YYYY/MM/DD' ) AS A_START_DATE
		, TO_CHAR( a.A_START_DATE, 'HH24:MI' ) AS A_START_DATE_TIME
		, TO_CHAR( a.A_END_DATE, 'YYYY/MM/DD' ) AS A_END_DATE
		, TO_CHAR( a.A_END_DATE, 'HH24:MI' ) AS A_END_DATE_TIME
	--	, CASE a.WORKTYPE_CODE
	--		WHEN 'W1' THEN TO_DATE( '${BASE_YYYYMMDD}' || '17:00:00', 'YYYY-MM-DD HH24:MI:SS' )
	--		WHEN 'W2' THEN TO_DATE( '${BASE_YYYYMMDD}' || '15:00:00', 'YYYY-MM-DD HH24:MI:SS' ) 
	--		WHEN 'W3' THEN TO_DATE( '${BASE_YYYYMMDD}' || '23:00:00', 'YYYY-MM-DD HH24:MI:SS' )
	--		WHEN 'W4' THEN TO_DATE( '${BASE_YYYYMMDD}' || '07:00:00', 'YYYY-MM-DD HH24:MI:SS' ) + 1
	--		ELSE TO_DATE( '${BASE_YYYYMMDD}' || '17:00:00', 'YYYY-MM-DD HH24:MI:SS' )
	--	END AS EXTENSION_HOUR_TG
	--	, CASE a.WORKTYPE_CODE
	--		WHEN 'W1' THEN ( a.A_END_DATE -   TO_DATE( '${BASE_YYYYMMDD}' || '17:00:00', 'YYYY-MM-DD HH24:MI:SS' )       ) * 24
	--		WHEN 'W2' THEN ( a.A_END_DATE -   TO_DATE( '${BASE_YYYYMMDD}' || '15:00:00', 'YYYY-MM-DD HH24:MI:SS' )       ) * 24
	--		WHEN 'W3' THEN ( a.A_END_DATE -   TO_DATE( '${BASE_YYYYMMDD}' || '23:00:00', 'YYYY-MM-DD HH24:MI:SS' )       ) * 24
	--		WHEN 'W4' THEN ( a.A_END_DATE - ( TO_DATE( '${BASE_YYYYMMDD}' || '07:00:00', 'YYYY-MM-DD HH24:MI:SS' ) + 1 ) ) * 24
	--		ELSE 0
	--	END AS EXTENSION_HOUR_GB
		/* 연장 : 퇴근시간과 기준시간 비교, 차이 시간 + 0.5(30분단위, 30분~59분 케이스만 적용) */
		, CASE a.WORKTYPE_CODE
			WHEN 'W1' THEN
				CASE WHEN ( a.A_END_DATE -		TO_DATE( #{BASE_YYYYMMDD} || '17:00:00', 'YYYY-MM-DD HH24:MI:SS' )			) * 24 >= 0
					THEN TRUNC( ( a.A_END_DATE - TO_DATE( #{BASE_YYYYMMDD} || '17:00:00', 'YYYY-MM-DD HH24:MI:SS' )			) * 24 ) + CASE WHEN TO_CHAR( a.A_END_DATE, 'MI' ) BETWEEN '30' AND '59' THEN 0.5 ELSE 0 END
				ELSE 0 END
			WHEN 'W2' THEN 
				CASE WHEN ( a.A_END_DATE -		TO_DATE( #{BASE_YYYYMMDD} || '15:00:00', 'YYYY-MM-DD HH24:MI:SS' )			) * 24 >= 0
					THEN TRUNC( ( a.A_END_DATE - TO_DATE( #{BASE_YYYYMMDD} || '15:00:00', 'YYYY-MM-DD HH24:MI:SS' )			) * 24 ) + CASE WHEN TO_CHAR( a.A_END_DATE, 'MI' ) BETWEEN '30' AND '59' THEN 0.5 ELSE 0 END
				ELSE 0 END 
			WHEN 'W3' THEN 
				CASE WHEN ( a.A_END_DATE -		TO_DATE( #{BASE_YYYYMMDD} || '23:00:00', 'YYYY-MM-DD HH24:MI:SS' )			) * 24 >= 0
					THEN TRUNC( ( a.A_END_DATE - TO_DATE( #{BASE_YYYYMMDD} || '23:00:00', 'YYYY-MM-DD HH24:MI:SS' )			) * 24 ) + CASE WHEN TO_CHAR( a.A_END_DATE, 'MI' ) BETWEEN '30' AND '59' THEN 0.5 ELSE 0 END
				ELSE 0 END
			WHEN 'W4' THEN 
				CASE WHEN ( a.A_END_DATE - (	TO_DATE( #{BASE_YYYYMMDD} || '07:00:00', 'YYYY-MM-DD HH24:MI:SS' ) + 1 )	) * 24 >= 0
					THEN TRUNC( ( a.A_END_DATE - ( TO_DATE( #{BASE_YYYYMMDD} || '07:00:00', 'YYYY-MM-DD HH24:MI:SS' ) + 1 )	) * 24 ) + CASE WHEN TO_CHAR( a.A_END_DATE, 'MI' ) BETWEEN '30' AND '59' THEN 0.5 ELSE 0 END
				ELSE 0 END
			ELSE 0.0
		END AS EXTENSION_HOUR
		/* 휴일 : 출근일이 토요일, 일요일이면 1 아니면 0, 공휴일 정보 개발일 기준 없으므로 로직에서 제외 */
		, CASE WHEN TO_CHAR( a.A_START_DATE, 'D' ) IN ('1','7') THEN 1 ELSE 0 END AS HOLIDAY_HOUR
		/* 야간 : 퇴근시간과 기준시간 비교, 금일 22시부터 퇴근시간까지 모든시간 계산( 최대 익일 06시 ) */
		, ROUND( CASE
			WHEN TO_DATE( #{BASE_YYYYMMDD} || '22:00:00', 'YYYY-MM-DD HH24:MI:SS' ) >= a.A_END_DATE
				THEN 0
			ELSE
			CASE 
				WHEN TO_DATE( #{BASE_YYYYMMDD} || '06:00:00', 'YYYY-MM-DD HH24:MI:SS' ) + 1 >= a.A_END_DATE
					THEN ( a.A_END_DATE - TO_DATE( #{BASE_YYYYMMDD} || '22:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24
				ELSE ( ( TO_DATE( #{BASE_YYYYMMDD} || '06:00:00', 'YYYY-MM-DD HH24:MI:SS' ) + 1 ) - TO_DATE( #{BASE_YYYYMMDD} || '22:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24
			END
		END, 3 ) AS NIGHT_HOUR
		/* 지각 : 출근시간과 근무시간 비교, 최대 4시간까지 분단위로 계산 */
		, ROUND( CASE a.WORKTYPE_CODE
			WHEN 'W1' THEN
				CASE WHEN ( TO_DATE( TO_CHAR( a.A_START_DATE, 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '08:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24 * 60 > 0
					THEN
					CASE
						WHEN ( TO_DATE( TO_CHAR( a.A_START_DATE, 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '08:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24 > 4 THEN 4
						ELSE ( TO_DATE( TO_CHAR( a.A_START_DATE, 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '08:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24
					END
				ELSE 0 END
			WHEN 'W2' THEN 
				CASE WHEN ( TO_DATE( TO_CHAR( a.A_START_DATE, 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '07:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24 * 60 > 0
					THEN
					CASE
						WHEN ( TO_DATE( TO_CHAR( a.A_START_DATE, 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '07:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24 > 4 THEN 4
						ELSE ( TO_DATE( TO_CHAR( a.A_START_DATE, 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '07:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24
					END
				ELSE 0 END 
			WHEN 'W3' THEN 
				CASE WHEN ( TO_DATE( TO_CHAR( a.A_START_DATE, 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '15:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24 * 60 > 0
					THEN
					CASE
						WHEN ( TO_DATE( TO_CHAR( a.A_START_DATE, 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '15:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24 > 4 THEN 4
						ELSE ( TO_DATE( TO_CHAR( a.A_START_DATE, 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '15:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24
					END
				ELSE 0 END
			WHEN 'W4' THEN 
				CASE WHEN ( TO_DATE( TO_CHAR( a.A_START_DATE, 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '23:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24 * 60 > 0
					THEN
					CASE
						WHEN ( TO_DATE( TO_CHAR( a.A_START_DATE, 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '23:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24 > 4 THEN 4
						ELSE ( TO_DATE( TO_CHAR( a.A_START_DATE, 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '23:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24
					END
				ELSE 0 END
			ELSE 0.0
		END, 3 ) AS LATE_HOUR
		, a.COMMENTS
		, a.CONFIRM_YN
	FROM (
		SELECT
			  NVL2( f.BASE_YYYY, f.BASE_YYYY, d.BASE_YYYY ) AS BASE_YYYY
			, NVL2( f.BASE_YYYY, f.BASE_YYYYMMDD, a.DT ) AS BASE_YYYYMMDD
			, NVL2( f.BASE_YYYY, f.VENDOR_CODE, d.VENDOR_CODE ) AS VENDOR_CODE
			, e.CODE_NAME AS VENDOR_NAME
			, NVL2( f.BASE_YYYY, f.CONTRACT_CODE, d.CONTRACT_CODE ) AS CONTRACT_CODE
			, '(' || d.BASE_YYYY || ') ' || d.CONTRACT_NAME AS CONTRACT_NAME
			, NVL2( f.BASE_YYYY, 'N', 'Y' ) AS DATA_STATUS -- 처리구분 - Y : INSERT, N : UPDATE
			, NVL2( f.BASE_YYYY, f.WORKTYPE_CODE,
				CASE 
					WHEN c.WORKTYPE_CODE = 'W1'
						THEN 'W1'
					WHEN TO_CHAR( a.A_START_DATE, 'YYYYMMDDHH24' ) BETWEEN TO_CHAR( TO_DATE( #{BASE_YYYYMMDD}, 'YYYY-MM-DD'), 'YYYYMMDD') || '05' AND TO_CHAR( TO_DATE( #{BASE_YYYYMMDD}, 'YYYY-MM-DD'), 'YYYYMMDD') || '11'
						THEN 'W2'
					WHEN TO_CHAR( a.A_START_DATE, 'YYYYMMDDHH24' ) BETWEEN TO_CHAR( TO_DATE( #{BASE_YYYYMMDD}, 'YYYY-MM-DD'), 'YYYYMMDD') || '13' AND TO_CHAR( TO_DATE( #{BASE_YYYYMMDD}, 'YYYY-MM-DD'), 'YYYYMMDD') || '19'
						THEN 'W3'
					WHEN TO_CHAR( a.A_START_DATE, 'YYYYMMDDHH24' ) BETWEEN TO_CHAR( TO_DATE( #{BASE_YYYYMMDD}, 'YYYY-MM-DD'), 'YYYYMMDD') || '21' AND TO_CHAR( TO_DATE( #{BASE_YYYYMMDD}, 'YYYY-MM-DD') + 1, 'YYYYMMDD') || '03'
						THEN 'W4'
					ELSE ''
				END
			) AS WORKTYPE_CODE -- W1 ~ W4 구간 나눠야 함
			, NVL2( f.BASE_YYYY, f.SUBC_CODE, c.SUBC_CODE ) AS SUBC_CODE
			, ( SELECT s.SUBC_NAME FROM TBL_ENTERPRISE_ACCESS_CONTROL s WHERE s.SUBC_CODE = NVL2( f.BASE_YYYY, f.SUBC_CODE, c.SUBC_CODE ) ) AS SUBC_NAME
			, NVL2( f.BASE_YYYY, f.A_START_DATE, a.A_START_DATE ) AS A_START_DATE
			, NVL2( f.BASE_YYYY, f.A_END_DATE, a.A_END_DATE ) AS A_END_DATE
	--		, TO_CHAR( NVL2( f.BASE_YYYY, f.A_START_DATE, a.A_START_DATE ), 'YYYY-MM-DD HH24:MI' ) AS A_START_DATE
	--		, TO_CHAR(NVL2( f.BASE_YYYY, f.A_END_DATE, a.A_END_DATE ), 'YYYY-MM-DD HH24:MI' ) AS A_END_DATE
			, NVL2( f.BASE_YYYY, f.EXTENSION_HOUR, 0 ) AS EXTENSION_HOUR
			, NVL2( f.BASE_YYYY, f.HOLIDAY_HOUR, 0 ) AS HOLIDAY_HOUR
			, NVL2( f.BASE_YYYY, f.NIGHT_HOUR, 0 ) AS NIGHT_HOUR
			, NVL2( f.BASE_YYYY, f.LATE_HOUR, 0 ) AS LATE_HOUR
			, NVL2( f.BASE_YYYY, f.COMMENTS, CHR(32) ) AS COMMENTS
			, NVL2( f.BASE_YYYY, f.DATA_TYPE, 'A' ) AS DATA_TYPE -- M: 추가데이터, A: 태그데이터
			, NVL2( f.BASE_YYYY, f.CONFIRM_YN, 'N' ) AS CONFIRM_YN -- 확정여부(수정불가)
		FROM (
			SELECT
				  a.DT
				, a.COMPANY_ID
				, a.SABUN
				, MAX( a.USER_NAME ) AS USER_NAME
				, MAX( a.CARD_NO ) AS CARD_NO
				, MAX( a.A_START_DATE ) AS A_START_DATE
				, CASE
					WHEN TO_CHAR( MAX( a.A_START_DATE ), 'YYYYMMDDHH24MISS' )<![CDATA[<]]>TO_CHAR( MIN( a.A_END_DATE ), 'YYYYMMDDHH24MISS' ) THEN MIN( a.A_END_DATE )
					WHEN TO_CHAR( MAX( a.A_START_DATE ), 'YYYYMMDDHH24MISS' ) > TO_CHAR( MIN( a.A_END_DATE ), 'YYYYMMDDHH24MISS' ) THEN MAX( a.A_END_DATE )
					ELSE NULL
				END AS A_END_DATE
			FROM (
				SELECT
					  a.ACCESS_STATUS AS access_status
					, TO_CHAR( TO_DATE( #{BASE_YYYYMMDD}, 'YYYY-MM-DD'), 'YYYYMMDD' ) AS dt
					, a.COMPANY_ID AS company_id
					, a.SABUN AS sabun
					, a.USER_NAME AS user_name
					, a.CARD_NO AS CARD_NO
					, a.A_START_DATE AS a_start_date
					, a.A_END_DATE AS a_end_date
					, a.REG_DATE AS reg_date
				FROM TBL_ACCESS a -- 출근 정보
				WHERE 1=1
				AND TO_CHAR( a.REG_DATE, 'YYYY-MM-DD' ) BETWEEN  TO_CHAR( TO_DATE( #{BASE_YYYYMMDD}, 'YYYY-MM-DD'), 'YYYY-MM-DD' ) AND to_char( TO_DATE( #{BASE_YYYYMMDD}, 'YYYY-MM-DD') + 1, 'YYYY-MM-DD' )
				AND (
					TO_CHAR( a.A_START_DATE, 'YYYY-MM-DD' ) = #{BASE_YYYYMMDD} OR
					TO_CHAR( a.A_END_DATE, 'YYYY-MM-DD' ) = #{BASE_YYYYMMDD} OR
					( TO_CHAR( a.A_END_DATE, 'YYYY-MM-DD' ) = TO_CHAR( TO_DATE( #{BASE_YYYYMMDD}, 'YYYY-MM-DD') + 1, 'YYYY-MM-DD' ) )
				)
			) a
			WHERE 1=1
			GROUP BY a.DT, a.COMPANY_ID, a.SABUN
		) a
		INNER JOIN TBL_ENTERPRISE_ACCESS_CONTROL b -- 작업자 정보
			ON a.SABUN = b.SUBC_CODE
		INNER JOIN TBL_WORKING_SUBCWORKER_MAP c -- 계약-작업자 매핑
			ON b.SUBC_CODE = c.SUBC_CODE
		INNER JOIN TBL_WORKING_SUBC d -- 계약
			ON c.BASE_YYYY = d.BASE_YYYY
			AND c.VENDOR_CODE = d.VENDOR_CODE
			AND c.CONTRACT_CODE = d.CONTRACT_CODE
			AND d.VENDOR_CODE = #{VENDOR_CODE}
			AND d.BASE_YYYY = #{BASE_YYYY}
			AND d.CONTRACT_CODE = #{CONTRACT_CODE}
		INNER JOIN TBL_WORKING_MASTER e
			ON c.VENDOR_CODE = e.CODE
			AND substr(e.CODE, 1, 1) = 'V'
		LEFT OUTER JOIN TBL_WORKING_DAILY_REPORT_NEW f
			ON d.BASE_YYYY = f.BASE_YYYY
			AND a.DT = f.BASE_YYYYMMDD
			AND d.VENDOR_CODE = f.VENDOR_CODE
			AND d.CONTRACT_CODE = f.CONTRACT_CODE
			AND a.SABUN = f.SUBC_CODE
			AND f.DATA_TYPE = 'A'
		WHERE 1=1
		AND a.A_START_DATE IS NOT NULL
		AND a.A_END_DATE IS NOT NULL
	) a
	WHERE 1=1
	AND NOT EXISTS (
		SELECT 1 FROM TBL_WORKING_DAILY_REPORT_NEW s
		WHERE a.BASE_YYYY = s.BASE_YYYY
		AND a.VENDOR_CODE = s.VENDOR_CODE
		AND a.CONTRACT_CODE = s.CONTRACT_CODE
		AND a.BASE_YYYYMMDD = s.BASE_YYYYMMDD
		AND a.SUBC_CODE = s.SUBC_CODE
		AND s.DATA_TYPE = 'M'
	) -- 태그데이터가 존재하더라도 추가데이터가 저장되어 있으면 데이터 제외
	AND a.WORKTYPE_CODE IS NOT NULL -- 근무유형 특정되지 않는 데이터 제외
		UNION ALL
	SELECT
		  g.BASE_YYYY
		, g.VENDOR_CODE
		, g.CONTRACT_CODE
		, g.BASE_YYYYMMDD
		, g.SUBC_CODE AS SUBC_CODE_PK
		, g.SUBC_CODE
		, ( SELECT s.CODE_NAME FROM TBL_WORKING_MASTER s WHERE s.CODE = g.VENDOR_CODE ) AS VENDOR_NAME
		, ( SELECT '(' || s.BASE_YYYY || ') ' || s.CONTRACT_NAME FROM TBL_WORKING_SUBC s WHERE s.BASE_YYYY = g.BASE_YYYY AND s.VENDOR_CODE = g.VENDOR_CODE AND s.CONTRACT_CODE = g.CONTRACT_CODE ) AS CONTRACT_NAME
		, ( SELECT s.SUBC_NAME FROM TBL_ENTERPRISE_ACCESS_CONTROL s WHERE s.SUBC_CODE = g.SUBC_CODE ) AS SUBC_NAME
		, g.WORKTYPE_CODE
		, g.DATA_TYPE
		, 'N' AS DATA_STATUS
		, TO_CHAR( g.A_START_DATE, 'YYYY/MM/DD' ) AS A_START_DATE
		, TO_CHAR( g.A_START_DATE, 'HH24:MI' ) AS A_START_DATE_TIME
		, TO_CHAR( g.A_END_DATE, 'YYYY/MM/DD' ) AS A_END_DATE
		, TO_CHAR( g.A_END_DATE, 'HH24:MI' ) AS A_END_DATE_TIME
		, g.EXTENSION_HOUR
		, g.HOLIDAY_HOUR
		, g.NIGHT_HOUR
		, g.LATE_HOUR
		, g.COMMENTS
		, g.CONFIRM_YN
	FROM TBL_WORKING_DAILY_REPORT_NEW g
	WHERE 1=1
	AND g.BASE_YYYY = #{BASE_YYYY}
	AND g.VENDOR_CODE = #{VENDOR_CODE}
	AND g.CONTRACT_CODE = #{CONTRACT_CODE}
	AND g.BASE_YYYYMMDD = TO_CHAR( TO_DATE( #{BASE_YYYYMMDD}, 'YYYY-MM-DD'), 'YYYYMMDD' )
	AND g.DATA_TYPE = 'M'
) M
ORDER BY M.SUBC_NAME
</select>

<select id="select_tbl_working_daily_report_cnt" resultType="double">
/* oracle.yp_zwc_ipt2.select_tbl_working_daily_report_cnt */
SELECT SUM( CNT )
FROM (
	SELECT COUNT(*) AS CNT
	FROM (
		SELECT
			  NVL2( f.BASE_YYYY, f.BASE_YYYY, d.BASE_YYYY ) AS BASE_YYYY
			, NVL2( f.BASE_YYYY, f.BASE_YYYYMMDD, a.DT ) AS BASE_YYYYMMDD
			, NVL2( f.BASE_YYYY, f.VENDOR_CODE, d.VENDOR_CODE ) AS VENDOR_CODE
			, e.CODE_NAME AS VENDOR_NAME
			, NVL2( f.BASE_YYYY, f.CONTRACT_CODE, d.CONTRACT_CODE ) AS CONTRACT_CODE
			, '(' || d.BASE_YYYY || ') ' || d.CONTRACT_NAME AS CONTRACT_NAME
			, NVL2( f.BASE_YYYY, 'N', 'Y' ) AS DATA_STATUS -- 처리구분 - Y : INSERT, N : UPDATE
			, NVL2( f.BASE_YYYY, f.WORKTYPE_CODE,
				CASE 
					WHEN c.WORKTYPE_CODE = 'W1'
						THEN 'W1'
					WHEN TO_CHAR( a.A_START_DATE, 'YYYYMMDDHH24' ) BETWEEN TO_CHAR( TO_DATE( #{BASE_YYYYMMDD}, 'YYYY-MM-DD'), 'YYYYMMDD') || '05' AND TO_CHAR( TO_DATE( #{BASE_YYYYMMDD}, 'YYYY-MM-DD'), 'YYYYMMDD') || '11'
						THEN 'W2'
					WHEN TO_CHAR( a.A_START_DATE, 'YYYYMMDDHH24' ) BETWEEN TO_CHAR( TO_DATE( #{BASE_YYYYMMDD}, 'YYYY-MM-DD'), 'YYYYMMDD') || '13' AND TO_CHAR( TO_DATE( #{BASE_YYYYMMDD}, 'YYYY-MM-DD'), 'YYYYMMDD') || '19'
						THEN 'W3'
					WHEN TO_CHAR( a.A_START_DATE, 'YYYYMMDDHH24' ) BETWEEN TO_CHAR( TO_DATE( #{BASE_YYYYMMDD}, 'YYYY-MM-DD'), 'YYYYMMDD') || '21' AND TO_CHAR( TO_DATE( #{BASE_YYYYMMDD}, 'YYYY-MM-DD') + 1, 'YYYYMMDD') || '03'
						THEN 'W4'
					ELSE ''
				END
			) AS WORKTYPE_CODE -- W1 ~ W4 구간 나눠야 함
			, NVL2( f.BASE_YYYY, f.SUBC_CODE, c.SUBC_CODE ) AS SUBC_CODE
			, ( SELECT s.SUBC_NAME FROM TBL_ENTERPRISE_ACCESS_CONTROL s WHERE s.SUBC_CODE = NVL2( f.BASE_YYYY, f.SUBC_CODE, c.SUBC_CODE ) ) AS SUBC_NAME
			, NVL2( f.BASE_YYYY, f.A_START_DATE, a.A_START_DATE ) AS A_START_DATE
			, NVL2( f.BASE_YYYY, f.A_END_DATE, a.A_END_DATE ) AS A_END_DATE
	--		, TO_CHAR( NVL2( f.BASE_YYYY, f.A_START_DATE, a.A_START_DATE ), 'YYYY-MM-DD HH24:MI' ) AS A_START_DATE
	--		, TO_CHAR(NVL2( f.BASE_YYYY, f.A_END_DATE, a.A_END_DATE ), 'YYYY-MM-DD HH24:MI' ) AS A_END_DATE
			, NVL2( f.BASE_YYYY, f.EXTENSION_HOUR, 0 ) AS EXTENSION_HOUR
			, NVL2( f.BASE_YYYY, f.HOLIDAY_HOUR, 0 ) AS HOLIDAY_HOUR
			, NVL2( f.BASE_YYYY, f.NIGHT_HOUR, 0 ) AS NIGHT_HOUR
			, NVL2( f.BASE_YYYY, f.LATE_HOUR, 0 ) AS LATE_HOUR
			, NVL2( f.BASE_YYYY, f.COMMENTS, CHR(32) ) AS COMMENTS
			, NVL2( f.BASE_YYYY, f.DATA_TYPE, 'A' ) AS DATA_TYPE -- M: 추가데이터, A: 태그데이터
			, NVL2( f.BASE_YYYY, f.CONFIRM_YN, 'N' ) AS CONFIRM_YN -- 확정여부(수정불가)
		FROM (
			SELECT
				  a.DT
				, a.COMPANY_ID
				, a.SABUN
				, MAX( a.USER_NAME ) AS USER_NAME
				, MAX( a.CARD_NO ) AS CARD_NO
				, MAX( a.A_START_DATE ) AS A_START_DATE
				, CASE
					WHEN TO_CHAR( MAX( a.A_START_DATE ), 'YYYYMMDDHH24MISS' )<![CDATA[<]]>TO_CHAR( MIN( a.A_END_DATE ), 'YYYYMMDDHH24MISS' ) THEN MIN( a.A_END_DATE )
					WHEN TO_CHAR( MAX( a.A_START_DATE ), 'YYYYMMDDHH24MISS' ) > TO_CHAR( MIN( a.A_END_DATE ), 'YYYYMMDDHH24MISS' ) THEN MAX( a.A_END_DATE )
					ELSE NULL
				END AS A_END_DATE
			FROM (
				SELECT
					  a.ACCESS_STATUS AS access_status
					, TO_CHAR( TO_DATE( #{BASE_YYYYMMDD}, 'YYYY-MM-DD'), 'YYYYMMDD' ) AS dt
					, a.COMPANY_ID AS company_id
					, a.SABUN AS sabun
					, a.USER_NAME AS user_name
					, a.CARD_NO AS CARD_NO
					, a.A_START_DATE AS a_start_date
					, a.A_END_DATE AS a_end_date
					, a.REG_DATE AS reg_date
				FROM TBL_ACCESS a -- 출근 정보
				WHERE 1=1
				AND TO_CHAR( a.REG_DATE, 'YYYY-MM-DD' ) BETWEEN  TO_CHAR( TO_DATE( #{BASE_YYYYMMDD}, 'YYYY-MM-DD'), 'YYYY-MM-DD' ) AND to_char( TO_DATE( #{BASE_YYYYMMDD}, 'YYYY-MM-DD') + 1, 'YYYY-MM-DD' )
				AND (
					TO_CHAR( a.A_START_DATE, 'YYYY-MM-DD' ) = #{BASE_YYYYMMDD} OR
					TO_CHAR( a.A_END_DATE, 'YYYY-MM-DD' ) = #{BASE_YYYYMMDD} OR
					( TO_CHAR( a.A_END_DATE, 'YYYY-MM-DD' ) = TO_CHAR( TO_DATE( #{BASE_YYYYMMDD}, 'YYYY-MM-DD') + 1, 'YYYY-MM-DD' ) )
				)
			) a
			WHERE 1=1
			GROUP BY a.DT, a.COMPANY_ID, a.SABUN
		) a
		INNER JOIN TBL_ENTERPRISE_ACCESS_CONTROL b -- 작업자 정보
			ON a.SABUN = b.SUBC_CODE
		INNER JOIN TBL_WORKING_SUBCWORKER_MAP c -- 계약-작업자 매핑
			ON b.SUBC_CODE = c.SUBC_CODE
		INNER JOIN TBL_WORKING_SUBC d -- 계약
			ON c.BASE_YYYY = d.BASE_YYYY
			AND c.VENDOR_CODE = d.VENDOR_CODE
			AND c.CONTRACT_CODE = d.CONTRACT_CODE
			AND d.VENDOR_CODE = #{VENDOR_CODE}
			AND d.BASE_YYYY = #{BASE_YYYY}
			AND d.CONTRACT_CODE = #{CONTRACT_CODE}
		INNER JOIN TBL_WORKING_MASTER e
			ON c.VENDOR_CODE = e.CODE
			AND substr(e.CODE, 1, 1) = 'V'
		LEFT OUTER JOIN TBL_WORKING_DAILY_REPORT_NEW f
			ON d.BASE_YYYY = f.BASE_YYYY
			AND a.DT = f.BASE_YYYYMMDD
			AND d.VENDOR_CODE = f.VENDOR_CODE
			AND d.CONTRACT_CODE = f.CONTRACT_CODE
		WHERE 1=1
		AND a.A_START_DATE IS NOT NULL
		AND a.A_END_DATE IS NOT NULL
	) a
	WHERE 1=1
	AND NOT EXISTS (
		SELECT 1 FROM TBL_WORKING_DAILY_REPORT_NEW s
		WHERE a.BASE_YYYY = s.BASE_YYYY
		AND a.VENDOR_CODE = s.VENDOR_CODE
		AND a.CONTRACT_CODE = s.CONTRACT_CODE
		AND a.BASE_YYYYMMDD = s.BASE_YYYYMMDD
		AND a.SUBC_CODE = s.SUBC_CODE
		AND s.DATA_TYPE = 'M'
	) -- 태그데이터가 존재하더라도 추가데이터가 저장되어 있으면 데이터 제외
	AND a.WORKTYPE_CODE IS NOT NULL -- 근무유형 특정되지 않는 데이터 제외
		UNION ALL
	SELECT COUNT(*) AS CNT
	FROM TBL_WORKING_DAILY_REPORT_NEW g
	WHERE 1=1
	AND g.BASE_YYYY = #{BASE_YYYY}
	AND g.VENDOR_CODE = #{VENDOR_CODE}
	AND g.CONTRACT_CODE = #{CONTRACT_CODE}
	AND g.BASE_YYYYMMDD = TO_CHAR( TO_DATE( #{BASE_YYYYMMDD}, 'YYYY-MM-DD'), 'YYYYMMDD' )
	AND g.DATA_TYPE = 'M'
) X
</select>

<delete id="delete_tbl_working_daily_report">
/* oracle.yp_zwc_ipt2.delete_tbl_working_daily_report */
DELETE FROM TBL_WORKING_DAILY_REPORT_NEW a
WHERE 1=1
AND a.BASE_YYYY = #{BASE_YYYY}
AND a.VENDOR_CODE = #{VENDOR_CODE}
AND a.CONTRACT_CODE = #{CONTRACT_CODE}
AND a.BASE_YYYYMMDD = #{BASE_YYYYMMDD}
AND a.SUBC_CODE = #{SUBC_CODE_PK}
</delete>

<select id="insert_count_tbl_working_daily_report" resultType="int">
/* oracle.yp_zwc_ipt2.insert_count_tbl_working_daily_report */
SELECT COUNT(*)
FROM TBL_WORKING_DAILY_REPORT_NEW a
WHERE 1=1
AND a.BASE_YYYY = #{BASE_YYYY}
AND a.VENDOR_CODE = #{VENDOR_CODE}
AND a.CONTRACT_CODE = #{CONTRACT_CODE}
AND a.BASE_YYYYMMDD = #{BASE_YYYYMMDD}
AND a.SUBC_CODE = #{SUBC_CODE_PK}
</select>

<insert id="insert_tbl_working_daily_report">
/* oracle.yp_zwc_ipt2.insert_tbl_working_daily_report - [DATA_TYPE : '${DATA_TYPE}'] (A: 태그데이터, M: 추가데이터) */
INSERT INTO TBL_WORKING_DAILY_REPORT_NEW (
	  BASE_YYYY
	, VENDOR_CODE
	, CONTRACT_CODE
	, WORKTYPE_CODE
	, BASE_YYYYMMDD
	, SUBC_CODE
	, A_START_DATE
	, A_END_DATE
	, EXTENSION_HOUR
	, HOLIDAY_HOUR
	, NIGHT_HOUR
	, LATE_HOUR
	, COMMENTS
	, DATA_TYPE
	, CONFIRM_YN
	, REG_EMP
	, REG_DATE
) VALUES (
	  #{BASE_YYYY}
	, #{VENDOR_CODE}
	, #{CONTRACT_CODE}
	, #{WORKTYPE_CODE}
	, TO_CHAR( TO_DATE( #{BASE_YYYYMMDD}, 'YYYY-MM-DD' ), 'YYYYMMDD')
	, #{SUBC_CODE}
	, TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' )
	, TO_DATE( #{A_END_DATE} || #{A_END_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' )
	, CASE #{WORKTYPE_CODE}
		WHEN 'W1' THEN
			CASE WHEN ( TO_DATE( #{A_END_DATE} || #{A_END_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ) -		TO_DATE( #{BASE_YYYYMMDD} || '17:00:00', 'YYYY-MM-DD HH24:MI:SS' )			) * 24 >= 0
				THEN TRUNC( ( TO_DATE( #{A_END_DATE} || #{A_END_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '17:00:00', 'YYYY-MM-DD HH24:MI:SS' )			) * 24 ) + CASE WHEN TO_CHAR( TO_DATE( #{A_END_DATE} || #{A_END_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'MI' ) BETWEEN '30' AND '59' THEN 0.5 ELSE 0 END
			ELSE 0 END
		WHEN 'W2' THEN 
			CASE WHEN ( TO_DATE( #{A_END_DATE} || #{A_END_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ) -		TO_DATE( #{BASE_YYYYMMDD} || '15:00:00', 'YYYY-MM-DD HH24:MI:SS' )			) * 24 >= 0
				THEN TRUNC( ( TO_DATE( #{A_END_DATE} || #{A_END_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '15:00:00', 'YYYY-MM-DD HH24:MI:SS' )			) * 24 ) + CASE WHEN TO_CHAR( TO_DATE( #{A_END_DATE} || #{A_END_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'MI' ) BETWEEN '30' AND '59' THEN 0.5 ELSE 0 END
			ELSE 0 END 
		WHEN 'W3' THEN 
			CASE WHEN ( TO_DATE( #{A_END_DATE} || #{A_END_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ) -		TO_DATE( #{BASE_YYYYMMDD} || '23:00:00', 'YYYY-MM-DD HH24:MI:SS' )			) * 24 >= 0
				THEN TRUNC( ( TO_DATE( #{A_END_DATE} || #{A_END_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '23:00:00', 'YYYY-MM-DD HH24:MI:SS' )			) * 24 ) + CASE WHEN TO_CHAR( TO_DATE( #{A_END_DATE} || #{A_END_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'MI' ) BETWEEN '30' AND '59' THEN 0.5 ELSE 0 END
			ELSE 0 END
		WHEN 'W4' THEN 
			CASE WHEN ( TO_DATE( #{A_END_DATE} || #{A_END_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - (	TO_DATE( #{BASE_YYYYMMDD} || '07:00:00', 'YYYY-MM-DD HH24:MI:SS' ) + 1 )	) * 24 >= 0
				THEN TRUNC( ( TO_DATE( #{A_END_DATE} || #{A_END_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - ( TO_DATE( #{BASE_YYYYMMDD} || '07:00:00', 'YYYY-MM-DD HH24:MI:SS' ) + 1 )	) * 24 ) + CASE WHEN TO_CHAR( TO_DATE( #{A_END_DATE} || #{A_END_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'MI' ) BETWEEN '30' AND '59' THEN 0.5 ELSE 0 END
			ELSE 0 END
		ELSE 0.0
	END /* EXTENSION_HOUR */
	, CASE WHEN TO_CHAR( TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'D' ) IN ('1','7') THEN 1 ELSE 0 END /* HOLIDAY_HOUR */
	, ROUND( CASE
		WHEN TO_DATE( #{BASE_YYYYMMDD} || '22:00:00', 'YYYY-MM-DD HH24:MI:SS' ) >= TO_DATE( #{A_END_DATE} || #{A_END_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' )
			THEN 0
		ELSE
		CASE 
			WHEN TO_DATE( #{BASE_YYYYMMDD} || '06:00:00', 'YYYY-MM-DD HH24:MI:SS' ) + 1 >= TO_DATE( #{A_END_DATE} || #{A_END_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' )
				THEN ( TO_DATE( #{A_END_DATE} || #{A_END_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - 
					CASE WHEN TO_DATE( #{BASE_YYYYMMDD} || '22:00:00', 'YYYY-MM-DD HH24:MI:SS' ) >= TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' )
						THEN TO_DATE( #{BASE_YYYYMMDD} || '22:00:00', 'YYYY-MM-DD HH24:MI:SS' )
						ELSE TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' )
					END
				 ) * 24
			ELSE ( ( TO_DATE( #{BASE_YYYYMMDD} || '06:00:00', 'YYYY-MM-DD HH24:MI:SS' ) + 1 ) - 
				CASE WHEN TO_DATE( #{BASE_YYYYMMDD} || '22:00:00', 'YYYY-MM-DD HH24:MI:SS' ) >= TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' )
					THEN TO_DATE( #{BASE_YYYYMMDD} || '22:00:00', 'YYYY-MM-DD HH24:MI:SS' )
					ELSE TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' )
				END 
			) * 24
		END
	END, 3 ) /* NIGHT_HOUR */
	, ROUND( CASE #{WORKTYPE_CODE}
		WHEN 'W1' THEN
			CASE WHEN ( TO_DATE( TO_CHAR( TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '08:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24 * 60 > 0
				THEN
				CASE
					WHEN ( TO_DATE( TO_CHAR( TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '08:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24 > 4 THEN 4
					ELSE ( TO_DATE( TO_CHAR( TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '08:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24
				END
			ELSE 0 END
		WHEN 'W2' THEN 
			CASE WHEN ( TO_DATE( TO_CHAR( TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '07:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24 * 60 > 0
				THEN
				CASE
					WHEN ( TO_DATE( TO_CHAR( TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '07:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24 > 4 THEN 4
					ELSE ( TO_DATE( TO_CHAR( TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '07:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24
				END
			ELSE 0 END 
		WHEN 'W3' THEN 
			CASE WHEN ( TO_DATE( TO_CHAR( TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '15:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24 * 60 > 0
				THEN
				CASE
					WHEN ( TO_DATE( TO_CHAR( TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '15:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24 > 4 THEN 4
					ELSE ( TO_DATE( TO_CHAR( TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '15:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24
				END
			ELSE 0 END
		WHEN 'W4' THEN 
			CASE WHEN ( TO_DATE( TO_CHAR( TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '23:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24 * 60 > 0
				THEN
				CASE
					WHEN ( TO_DATE( TO_CHAR( TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '23:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24 > 4 THEN 4
					ELSE ( TO_DATE( TO_CHAR( TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '23:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24
				END
			ELSE 0 END
		ELSE 0.0
	END, 3 ) /* LATE_HOUR */
	, #{COMMENTS}
	, #{DATA_TYPE}
	, 'N'
	, #{s_emp_code}
	, SYSDATE
)
</insert>

<update id="update_tbl_working_daily_report">
/* oracle.yp_zwc_ipt2.update_tbl_working_daily_report - [DATA_TYPE : '${DATA_TYPE}'] (A: 태그데이터, M: 추가데이터) */
UPDATE TBL_WORKING_DAILY_REPORT_NEW a SET
	  a.COMMENTS = #{COMMENTS}
	, a.SUBC_CODE = #{SUBC_CODE}
	, a.WORKTYPE_CODE = #{WORKTYPE_CODE}
	, a.A_START_DATE = TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' )
	, a.A_END_DATE = TO_DATE( #{A_END_DATE} || #{A_END_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' )
	, a.EXTENSION_HOUR = 
		CASE #{WORKTYPE_CODE}
			WHEN 'W1' THEN
				CASE WHEN ( TO_DATE( #{A_END_DATE} || #{A_END_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ) -		TO_DATE( #{BASE_YYYYMMDD} || '17:00:00', 'YYYY-MM-DD HH24:MI:SS' )			) * 24 >= 0
					THEN TRUNC( ( TO_DATE( #{A_END_DATE} || #{A_END_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '17:00:00', 'YYYY-MM-DD HH24:MI:SS' )			) * 24 ) + CASE WHEN TO_CHAR( TO_DATE( #{A_END_DATE} || #{A_END_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'MI' ) BETWEEN '30' AND '59' THEN 0.5 ELSE 0 END
				ELSE 0 END
			WHEN 'W2' THEN 
				CASE WHEN ( TO_DATE( #{A_END_DATE} || #{A_END_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ) -		TO_DATE( #{BASE_YYYYMMDD} || '15:00:00', 'YYYY-MM-DD HH24:MI:SS' )			) * 24 >= 0
					THEN TRUNC( ( TO_DATE( #{A_END_DATE} || #{A_END_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '15:00:00', 'YYYY-MM-DD HH24:MI:SS' )			) * 24 ) + CASE WHEN TO_CHAR( TO_DATE( #{A_END_DATE} || #{A_END_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'MI' ) BETWEEN '30' AND '59' THEN 0.5 ELSE 0 END
				ELSE 0 END 
			WHEN 'W3' THEN 
				CASE WHEN ( TO_DATE( #{A_END_DATE} || #{A_END_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ) -		TO_DATE( #{BASE_YYYYMMDD} || '23:00:00', 'YYYY-MM-DD HH24:MI:SS' )			) * 24 >= 0
					THEN TRUNC( ( TO_DATE( #{A_END_DATE} || #{A_END_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '23:00:00', 'YYYY-MM-DD HH24:MI:SS' )			) * 24 ) + CASE WHEN TO_CHAR( TO_DATE( #{A_END_DATE} || #{A_END_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'MI' ) BETWEEN '30' AND '59' THEN 0.5 ELSE 0 END
				ELSE 0 END
			WHEN 'W4' THEN 
				CASE WHEN ( TO_DATE( #{A_END_DATE} || #{A_END_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - (	TO_DATE( #{BASE_YYYYMMDD} || '07:00:00', 'YYYY-MM-DD HH24:MI:SS' ) + 1 )	) * 24 >= 0
					THEN TRUNC( ( TO_DATE( #{A_END_DATE} || #{A_END_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - ( TO_DATE( #{BASE_YYYYMMDD} || '07:00:00', 'YYYY-MM-DD HH24:MI:SS' ) + 1 )	) * 24 ) + CASE WHEN TO_CHAR( TO_DATE( #{A_END_DATE} || #{A_END_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'MI' ) BETWEEN '30' AND '59' THEN 0.5 ELSE 0 END
				ELSE 0 END
			ELSE 0.0
		END /* EXTENSION_HOUR */
	, a.HOLIDAY_HOUR = CASE WHEN TO_CHAR( TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'D' ) IN ('1','7') THEN 1 ELSE 0 END /* HOLIDAY_HOUR */
	, a.NIGHT_HOUR = 
		ROUND( CASE
			WHEN TO_DATE( #{BASE_YYYYMMDD} || '22:00:00', 'YYYY-MM-DD HH24:MI:SS' ) >= TO_DATE( #{A_END_DATE} || #{A_END_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' )
				THEN 0
			ELSE
			CASE 
				WHEN TO_DATE( #{BASE_YYYYMMDD} || '06:00:00', 'YYYY-MM-DD HH24:MI:SS' ) + 1 >= TO_DATE( #{A_END_DATE} || #{A_END_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' )
					THEN ( TO_DATE( #{A_END_DATE} || #{A_END_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - 
						CASE WHEN TO_DATE( #{BASE_YYYYMMDD} || '22:00:00', 'YYYY-MM-DD HH24:MI:SS' ) >= TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' )
							THEN TO_DATE( #{BASE_YYYYMMDD} || '22:00:00', 'YYYY-MM-DD HH24:MI:SS' )
							ELSE TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' )
						END
					 ) * 24
				ELSE ( ( TO_DATE( #{BASE_YYYYMMDD} || '06:00:00', 'YYYY-MM-DD HH24:MI:SS' ) + 1 ) - 
					CASE WHEN TO_DATE( #{BASE_YYYYMMDD} || '22:00:00', 'YYYY-MM-DD HH24:MI:SS' ) >= TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' )
						THEN TO_DATE( #{BASE_YYYYMMDD} || '22:00:00', 'YYYY-MM-DD HH24:MI:SS' )
						ELSE TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' )
					END 
				) * 24
			END
		END, 3 ) /* NIGHT_HOUR */
	, a.LATE_HOUR = 
		ROUND( CASE #{WORKTYPE_CODE}
			WHEN 'W1' THEN
				CASE WHEN ( TO_DATE( TO_CHAR( TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '08:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24 * 60 > 0
					THEN
					CASE
						WHEN ( TO_DATE( TO_CHAR( TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '08:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24 > 4 THEN 4
						ELSE ( TO_DATE( TO_CHAR( TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '08:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24
					END
				ELSE 0 END
			WHEN 'W2' THEN 
				CASE WHEN ( TO_DATE( TO_CHAR( TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '07:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24 * 60 > 0
					THEN
					CASE
						WHEN ( TO_DATE( TO_CHAR( TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '07:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24 > 4 THEN 4
						ELSE ( TO_DATE( TO_CHAR( TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '07:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24
					END
				ELSE 0 END 
			WHEN 'W3' THEN 
				CASE WHEN ( TO_DATE( TO_CHAR( TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '15:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24 * 60 > 0
					THEN
					CASE
						WHEN ( TO_DATE( TO_CHAR( TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '15:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24 > 4 THEN 4
						ELSE ( TO_DATE( TO_CHAR( TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '15:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24
					END
				ELSE 0 END
			WHEN 'W4' THEN 
				CASE WHEN ( TO_DATE( TO_CHAR( TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '23:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24 * 60 > 0
					THEN
					CASE
						WHEN ( TO_DATE( TO_CHAR( TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '23:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24 > 4 THEN 4
						ELSE ( TO_DATE( TO_CHAR( TO_DATE( #{A_START_DATE} || #{A_START_DATE_TIME} || ':00', 'YYYY-MM-DD HH24:MI:SS' ), 'YYYY-MM-DD HH24:MI' ) || ':00', 'YYYY-MM-DD HH24:MI:SS' ) - TO_DATE( #{BASE_YYYYMMDD} || '23:00:00', 'YYYY-MM-DD HH24:MI:SS' ) ) * 24
					END
				ELSE 0 END
			ELSE 0.0
		END, 3 ) /* LATE_HOUR */
	, a.UPD_EMP = #{s_emp_code}
	, a.UPD_DATE = SYSDATE
WHERE 1=1
AND a.BASE_YYYY = #{BASE_YYYY}
AND a.VENDOR_CODE = #{VENDOR_CODE}
AND a.CONTRACT_CODE = #{CONTRACT_CODE}
AND a.BASE_YYYYMMDD = #{BASE_YYYYMMDD}
AND a.SUBC_CODE = #{SUBC_CODE_PK}
</update>

<update id="confirm_tbl_working_daily_report">
/* oracle.yp_zwc_ipt2.confirm_tbl_working_daily_report */
UPDATE TBL_WORKING_DAILY_REPORT_NEW a SET
	  a.CONFIRM_YN = 'Y'
	, a.CONFIRM_EMP = #{s_emp_code}
	, a.CONFIRM_DT = SYSDATE
WHERE 1=1
AND a.BASE_YYYY = #{BASE_YYYY}
AND a.VENDOR_CODE = #{VENDOR_CODE}
AND a.CONTRACT_CODE = #{CONTRACT_CODE}
AND a.BASE_YYYYMMDD = #{BASE_YYYYMMDD}
AND a.SUBC_CODE = #{SUBC_CODE_PK}
</update>

<select id="select_tbl_working_daily_approval_cnt" resultType="double">
/* oracle.yp_zwc_ipt2.select_tbl_working_daily_approval_cnt */
SELECT
	COUNT(*) AS CNT
FROM (
	SELECT
		A.BASE_YYYY, A.VENDOR_CODE, A.CONTRACT_CODE, CAL.BASE_YYYYMMDD
	FROM TBL_WORKING_SUBC A
	INNER JOIN (
		SELECT BASE_YYYYMMDD
		FROM (
			SELECT TO_CHAR(TO_DATE(REPLACE(#{BASE_YYYY_S}, '/', ''),'YYYYMMDD') + (LEVEL-1),'YYYYMMDD') AS BASE_YYYYMMDD
			FROM DUAL CONNECT BY LEVEL <![CDATA[<=]]> (TO_DATE(REPLACE(#{BASE_YYYY_E}, '/', ''),'YYYYMMDD') - TO_DATE(REPLACE(#{BASE_YYYY_S}, '/', ''),'YYYYMMDD') + 1)
		) S
		WHERE 1=1
	) CAL
		ON 1=1
	WHERE 1=1
	AND A.BASE_YYYY = SUBSTR(#{BASE_YYYY_S}, 1, 4) -- 조회조건 시작일자 4자리 잘라서 사용
	<!-- 계약등록시 부서와 로그인시 부서 체계가 서로 상이함 - 정해지기 전까지 주석처리 -->
	<if test="DEPT_CODE != null">
	AND A.DEPT_CODE = #{DEPT_CODE}
	</if>
	<if test="VENDOR_CODE != null">
	AND A.VENDOR_CODE = #{VENDOR_CODE}
	</if>
	<if test="CONTRACT_CODE != null">
	AND A.CONTRACT_CODE = #{CONTRACT_CODE}
	AND A.BASE_YYYY = #{BASE_YYYY}
	</if>
)
</select>

<select id="select_tbl_working_daily_approval" resultType="HashMap">
/* oracle.yp_zwc_ipt2.select_tbl_working_daily_approval */
SELECT
	NVL(B.GUBUN, '0') AS GUBUN,
	NVL(B.GUBUN, '0') AS GUBUN_ORI,
	CASE WHEN NVL( c.CNT, 0 ) > 0 THEN 'Y' ELSE 'N' END DT_EXIST, /* 2022-01-21 jamerl - 협력사 확정데이터 유무 확인 */
	A.BASE_YYYY,
	A.VENDOR_CODE,
	A.CONTRACT_CODE,
	A.WORKING_GUBUN AS WORKING_GUBUN,
	CAL.BASE_YYYYMMDD AS BASE_YYYYMMDD_VIEW,
	B.BASE_YYYYMMDD AS BASE_YYYYMMDD,
	A.CONTRACT_NAME AS CONTRACT_NAME,
	A.GUBUN_CODE AS GUBUN_CODE,
	(SELECT S.CODE_NM FROM COM_CODE_DETAIL S WHERE S.CODE = 'YP_SUBC_GUBUN' AND S.CODE_VALUE = A.GUBUN_CODE) AS GUBUN_NAME,
	A.UNIT_CODE AS UNIT_CODE,
	(SELECT S.CODE_NAME FROM TBL_WORKING_MASTER S WHERE SUBSTR(S.CODE, 1, 1) = 'U' AND S.CODE = A.UNIT_CODE) AS UNIT_NAME,
	B.EXTENSION_HOUR AS EXTENSION_HOUR,
	B.HOLIDAY_HOUR AS HOLIDAY_HOUR,
	B.NIGHT_HOUR AS NIGHT_HOUR,
	B.LATE_HOUR AS LATE_HOUR,
	B.SATURDAY_HOUR AS SATURDAY_HOUR,
	/* 2020-10-19 jamerl - 태그업체 테이블 준비되기 전까지 보정공수 합을 사용하도록 조치 */
	B.MANHOUR AS MANHOUR,
	B.COLLECTION_MANHOUR AS COLLECTION_MANHOUR,
	B.WORKLOAD_DT AS WORKLOAD_DT,
	B.COLLECTION_WORKLOAD AS COLLECTION_WORKLOAD,
	B.WORKLOAD AS WORKLOAD,
	B.TEAM_LEADER_CONFIRM
FROM TBL_WORKING_SUBC A
INNER JOIN (
	SELECT BASE_YYYYMMDD
	FROM (
		SELECT TO_CHAR(TO_DATE(REPLACE(#{BASE_YYYY_S}, '/', ''),'YYYYMMDD') + (LEVEL-1),'YYYYMMDD') AS BASE_YYYYMMDD
		FROM DUAL CONNECT BY LEVEL <![CDATA[<=]]> (TO_DATE(REPLACE(#{BASE_YYYY_E}, '/', ''),'YYYYMMDD') - TO_DATE(REPLACE(#{BASE_YYYY_S}, '/', ''),'YYYYMMDD') + 1)
	) S
	WHERE 1=1
) CAL
	ON 1=1
LEFT OUTER JOIN TBL_WORKING_DAILY_REPORT B
	ON A.BASE_YYYY = B.BASE_YYYY
	AND A.VENDOR_CODE = B.VENDOR_CODE
	AND A.CONTRACT_CODE = B.CONTRACT_CODE
	AND CAL.BASE_YYYYMMDD = B.BASE_YYYYMMDD
LEFT OUTER JOIN (
	SELECT c.BASE_YYYY, c.VENDOR_CODE, c.CONTRACT_CODE, c.BASE_YYYYMMDD, COUNT( 1 ) AS CNT
	FROM TBL_WORKING_DAILY_REPORT_NEW c
	WHERE 1=1
	AND c.BASE_YYYY = SUBSTR(#{BASE_YYYY_S}, 1, 4)
<if test="VENDOR_CODE != null">
	AND c.VENDOR_CODE = #{VENDOR_CODE}
</if>
<if test="CONTRACT_CODE != null">
	AND c.CONTRACT_CODE = #{CONTRACT_CODE}
</if>
	GROUP BY c.BASE_YYYY, c.VENDOR_CODE, c.CONTRACT_CODE, c.BASE_YYYYMMDD
) c /* 2022-01-21 jamerl - 협력사 확정데이터 유무 확인 */
	ON a.BASE_YYYY = c.BASE_YYYY
	AND a.VENDOR_CODE = c.VENDOR_CODE
	AND a.CONTRACT_CODE = c.CONTRACT_CODE
	AND CAL.BASE_YYYYMMDD = c.BASE_YYYYMMDD
WHERE 1=1
AND A.BASE_YYYY = SUBSTR(#{BASE_YYYY_S}, 1, 4) -- 조회조건 시작일자 4자리 잘라서 사용
<!-- 계약등록시 부서와 로그인시 부서 체계가 서로 상이함 - 정해지기 전까지 주석처리 -->
<if test="COST_CODE != null">
AND A.COST_CODE = #{COST_CODE}
</if>
<if test="DEPT_CODE != null">
AND A.DEPT_CODE = #{DEPT_CODE}
</if>
<if test="VENDOR_CODE != null">
AND A.VENDOR_CODE = #{VENDOR_CODE}
</if>
<if test="CONTRACT_CODE != null">
AND A.CONTRACT_CODE = #{CONTRACT_CODE}
AND A.BASE_YYYY = #{BASE_YYYY}
</if>
ORDER BY A.BASE_YYYY, A.VENDOR_CODE, A.CONTRACT_CODE, CAL.BASE_YYYYMMDD
</select>

<select id="select_tbl_working_daily_approval_dt_cnt" resultType="double">
/* oracle.yp_zwc_ipt2.select_tbl_working_daily_report_dt_cnt */
SELECT COUNT(*)
FROM (
	SELECT
		  a.BASE_YYYY, a.VENDOR_CODE, a.CONTRACT_CODE, a.BASE_YYYYMMDD, a.WORKTYPE_CODE
		, COUNT( CASE WHEN a.DATA_TYPE = 'A' THEN 1 END ) AS MANHOUR
		, COUNT( CASE WHEN a.DATA_TYPE = 'M' THEN 1 END ) AS COLLECTION_MANHOUR
	FROM TBL_WORKING_DAILY_REPORT_NEW a -- 확정된 협력사 도급일보
	WHERE 1=1
	AND a.BASE_YYYY = #{BASE_YYYY}
	AND a.VENDOR_CODE = #{VENDOR_CODE}
	AND a.CONTRACT_CODE = #{CONTRACT_CODE}
	AND a.BASE_YYYYMMDD = #{BASE_YYYYMMDD}
	AND a.CONFIRM_YN = 'Y' -- 확정된 데이터로 제한
	GROUP BY a.BASE_YYYY, a.VENDOR_CODE, a.CONTRACT_CODE, a.BASE_YYYYMMDD, a.WORKTYPE_CODE
) a
LEFT OUTER JOIN TBL_WORKING_DAILY_REPORT_DT B
	ON A.BASE_YYYY = B.BASE_YYYY
	AND A.VENDOR_CODE = B.VENDOR_CODE
	AND A.CONTRACT_CODE = B.CONTRACT_CODE
	AND A.WORKTYPE_CODE = B.WORKTYPE_CODE
	AND A.BASE_YYYYMMDD = B.BASE_YYYYMMDD
INNER JOIN TBL_WORKING_SUBC C
	ON A.BASE_YYYY = C.BASE_YYYY
	AND A.VENDOR_CODE = C.VENDOR_CODE
	AND A.CONTRACT_CODE = C.CONTRACT_CODE
LEFT OUTER JOIN TBL_WORKING_DAILY_REPORT E
	ON B.BASE_YYYY = E.BASE_YYYY
	AND B.BASE_YYYYMMDD = E.BASE_YYYYMMDD
	AND B.VENDOR_CODE = E.VENDOR_CODE
	AND B.CONTRACT_CODE = E.CONTRACT_CODE
</select>

<select id="select_tbl_working_daily_approval_dt" resultType="HashMap">
/* oracle.yp_zwc_ipt2.select_tbl_working_daily_report_dt */
SELECT
	  e.TEAM_LEADER_CONFIRM
	, a.BASE_YYYY
	, c.CONTRACT_NAME
	, a.VENDOR_CODE
	, a.CONTRACT_CODE
	, a.WORKTYPE_CODE
	, ( SELECT S.CODE_NAME FROM TBL_WORKING_MASTER S WHERE SUBSTR(S.CODE, 1, 1) = 'W' AND S.CODE = A.WORKTYPE_CODE ) AS WORKTYPE_NAME
	, a.BASE_YYYYMMDD
	, NVL( b.MANHOUR, a.MANHOUR ) AS MANHOUR
	, NVL( b.COLLECTION_MANHOUR, a.COLLECTION_MANHOUR ) AS COLLECTION_MANHOUR
	, NVL( b.WORKLOAD, 0 ) AS WORKLOAD
	, b.NOTE
	, a.EXTENSION_HOUR
	, a.HOLIDAY_HOUR
	, a.NIGHT_HOUR
	, a.LATE_HOUR
FROM (
	SELECT
		  a.BASE_YYYY, a.VENDOR_CODE, a.CONTRACT_CODE, a.BASE_YYYYMMDD, a.WORKTYPE_CODE
		, COUNT( CASE WHEN a.DATA_TYPE = 'A' THEN 1 END ) AS MANHOUR
		, COUNT( CASE WHEN a.DATA_TYPE = 'M' THEN 1 END ) AS COLLECTION_MANHOUR
		, SUM( a.EXTENSION_HOUR ) AS EXTENSION_HOUR
		, SUM( a.HOLIDAY_HOUR ) AS HOLIDAY_HOUR
		, SUM( a.NIGHT_HOUR ) AS NIGHT_HOUR
		, SUM( a.LATE_HOUR ) AS LATE_HOUR
	FROM TBL_WORKING_DAILY_REPORT_NEW a -- 확정된 협력사 도급일보
	WHERE 1=1
	AND a.BASE_YYYY = #{BASE_YYYY}
	AND a.VENDOR_CODE = #{VENDOR_CODE}
	AND a.CONTRACT_CODE = #{CONTRACT_CODE}
	AND a.BASE_YYYYMMDD = #{BASE_YYYYMMDD}
	AND a.CONFIRM_YN = 'Y' -- 확정된 데이터로 제한
	GROUP BY a.BASE_YYYY, a.VENDOR_CODE, a.CONTRACT_CODE, a.BASE_YYYYMMDD, a.WORKTYPE_CODE
) a
LEFT OUTER JOIN TBL_WORKING_DAILY_REPORT_DT B
	ON A.BASE_YYYY = B.BASE_YYYY
	AND A.VENDOR_CODE = B.VENDOR_CODE
	AND A.CONTRACT_CODE = B.CONTRACT_CODE
	AND A.WORKTYPE_CODE = B.WORKTYPE_CODE
	AND A.BASE_YYYYMMDD = B.BASE_YYYYMMDD
INNER JOIN TBL_WORKING_SUBC C
	ON A.BASE_YYYY = C.BASE_YYYY
	AND A.VENDOR_CODE = C.VENDOR_CODE
	AND A.CONTRACT_CODE = C.CONTRACT_CODE
LEFT OUTER JOIN TBL_WORKING_DAILY_REPORT E
	ON B.BASE_YYYY = E.BASE_YYYY
	AND B.BASE_YYYYMMDD = E.BASE_YYYYMMDD
	AND B.VENDOR_CODE = E.VENDOR_CODE
	AND B.CONTRACT_CODE = E.CONTRACT_CODE
ORDER BY TO_NUMBER(REGEXP_REPLACE(a.WORKTYPE_CODE, '[^0-9]'))
</select>

<update id="merge_tbl_working_daily_approval">
/* oracle.yp_zwc_ipt2.merge_tbl_working_daily_approval */
MERGE INTO TBL_WORKING_DAILY_REPORT A
USING (
	SELECT
		#{BASE_YYYY} AS BASE_YYYY,
		#{VENDOR_CODE} AS VENDOR_CODE,
		#{CONTRACT_CODE} AS CONTRACT_CODE,
		#{BASE_YYYYMMDD_VIEW} AS BASE_YYYYMMDD,
		#{GUBUN} AS GUBUN,
		#{WORKLOAD_DT} AS WORKLOAD_DT,
		#{COLLECTION_WORKLOAD} AS COLLECTION_WORKLOAD,
		#{WORKLOAD} AS WORKLOAD,
		#{EXTENSION_HOUR} AS EXTENSION_HOUR,
		#{HOLIDAY_HOUR} AS HOLIDAY_HOUR,
		#{NIGHT_HOUR} AS NIGHT_HOUR,
		#{LATE_HOUR} AS LATE_HOUR,
		#{s_emp_code} AS REG_EMP,
		SYSDATE AS REG_DATE,
		#{s_emp_code} AS UPD_EMP,
		SYSDATE AS UPD_DATE
	FROM DUAL
) B
ON (
		A.BASE_YYYY = B.BASE_YYYY
	AND A.CONTRACT_CODE = B.CONTRACT_CODE
	AND A.VENDOR_CODE = B.VENDOR_CODE
	AND A.BASE_YYYYMMDD = B.BASE_YYYYMMDD
)
WHEN NOT MATCHED THEN
INSERT (
	BASE_YYYY,
	CONTRACT_CODE,
	VENDOR_CODE,
	BASE_YYYYMMDD,
	GUBUN,
<choose>
	<when test='GUBUN != null and "1".equalsIgnoreCase( GUBUN )'>
	/* 2021-03-24 jamerl - 조용래 : 휴일 저장시 투입공수, 공수, 작업량 0 처리 */
	MANHOUR,
	COLLECTION_MANHOUR,
	WORKLOAD_DT,
	COLLECTION_WORKLOAD,
	WORKLOAD,
	</when>
	<otherwise>
	WORKLOAD_DT,
	COLLECTION_WORKLOAD,
	WORKLOAD,
	</otherwise>
</choose>
	EXTENSION_HOUR,
	HOLIDAY_HOUR,
	NIGHT_HOUR,
	LATE_HOUR,
	REG_EMP,
	REG_DATE
) VALUES (
	B.BASE_YYYY,
	B.CONTRACT_CODE,
	B.VENDOR_CODE,
	B.BASE_YYYYMMDD,
	B.GUBUN,
<choose>
	<when test='GUBUN != null and "1".equalsIgnoreCase( GUBUN )'>
	/* 2021-03-24 jamerl - 조용래 : 휴일 저장시 투입공수, 공수, 작업량 0 처리 */
	0,
	0,
	0,
	0,
	0,
	</when>
	<otherwise>
	B.WORKLOAD_DT,
	B.COLLECTION_WORKLOAD,
	B.WORKLOAD_DT + B.COLLECTION_WORKLOAD,
	</otherwise>
</choose>
	B.EXTENSION_HOUR,
	B.HOLIDAY_HOUR,
	B.NIGHT_HOUR,
	B.LATE_HOUR,
	B.REG_EMP,
	B.REG_DATE
)
WHEN MATCHED THEN
UPDATE SET
	GUBUN = B.GUBUN,
<choose>
	<when test='GUBUN != null and "1".equalsIgnoreCase( GUBUN )'>
	/* 2021-03-24 jamerl - 조용래 : 휴일 저장시 투입공수, 공수, 작업량 0 처리 */
	MANHOUR = 0,
	COLLECTION_MANHOUR = 0,
	WORKLOAD_DT = 0,
	COLLECTION_WORKLOAD = 0,
	WORKLOAD = 0,
	</when>
	<otherwise>
	WORKLOAD_DT = b.WORKLOAD_DT,
	COLLECTION_WORKLOAD = b.COLLECTION_WORKLOAD,
	WORKLOAD = b.WORKLOAD_DT + b.COLLECTION_WORKLOAD,
	</otherwise>
</choose>
	EXTENSION_HOUR = B.EXTENSION_HOUR,
	HOLIDAY_HOUR = B.HOLIDAY_HOUR,
	NIGHT_HOUR = B.NIGHT_HOUR,
	LATE_HOUR = B.LATE_HOUR,
	UPD_EMP = B.UPD_EMP,
	UPD_DATE = B.UPD_DATE
</update>

<select id="pre_update_tbl_working_daily_approval" resultType="int">
/* oracle.yp_zwc_ipt.pre_update_tbl_working_daily_approval */
SELECT COUNT(*) AS CNT
FROM TBL_WORKING_DAILY_REPORT A
WHERE 1=1
AND A.BASE_YYYY = #{BASE_YYYY}
AND A.CONTRACT_CODE = #{CONTRACT_CODE}
AND A.VENDOR_CODE = #{VENDOR_CODE}
AND A.BASE_YYYYMMDD = #{BASE_YYYYMMDD}
</select>

<update id="merge_tbl_working_daily_approval_dt">
/* oracle.yp_zwc_ipt.merge_tbl_working_daily_approval_dt */
MERGE INTO TBL_WORKING_DAILY_REPORT_DT A
USING (
	SELECT
		#{BASE_YYYY} AS BASE_YYYY,
		#{CONTRACT_CODE} AS CONTRACT_CODE,
		#{VENDOR_CODE} AS VENDOR_CODE,
		#{BASE_YYYYMMDD} AS BASE_YYYYMMDD,
		#{WORKTYPE_CODE} AS WORKTYPE_CODE,
		#{WORKER} AS WORKER,
		#{MANHOUR} AS MANHOUR,
		#{COLLECTION_MANHOUR} AS COLLECTION_MANHOUR,
		#{WORKLOAD} AS WORKLOAD,
		#{NOTE} AS NOTE,
		#{EXTENSION_HOUR} AS EXTENSION_HOUR,
		#{HOLIDAY_HOUR} AS HOLIDAY_HOUR,
		#{NIGHT_HOUR} AS NIGHT_HOUR,
		#{LATE_HOUR} AS LATE_HOUR,
		#{s_emp_code} AS REG_EMP,
		SYSDATE AS REG_DATE,
		#{s_emp_code} AS UPD_EMP,
		SYSDATE AS UPD_DATE
	FROM DUAL
) B
ON (
		A.BASE_YYYY = B.BASE_YYYY
	AND A.CONTRACT_CODE = B.CONTRACT_CODE
	AND A.VENDOR_CODE = B.VENDOR_CODE
	AND A.BASE_YYYYMMDD = B.BASE_YYYYMMDD
	AND A.WORKTYPE_CODE = B.WORKTYPE_CODE
)
WHEN NOT MATCHED THEN
INSERT (
	BASE_YYYY,
	CONTRACT_CODE,
	VENDOR_CODE,
	BASE_YYYYMMDD,
	WORKTYPE_CODE,
	WORKER,
	MANHOUR,
	COLLECTION_MANHOUR,
	WORKLOAD,
	NOTE,
	EXTENSION_HOUR,
	HOLIDAY_HOUR,
	NIGHT_HOUR,
	LATE_HOUR,
	REG_EMP,
	REG_DATE
) VALUES (
	B.BASE_YYYY,
	B.CONTRACT_CODE,
	B.VENDOR_CODE,
	B.BASE_YYYYMMDD,
	B.WORKTYPE_CODE,
	B.WORKER,
	B.MANHOUR,
	B.COLLECTION_MANHOUR,
	B.WORKLOAD,
	B.NOTE,
	B.EXTENSION_HOUR,
	B.HOLIDAY_HOUR,
	B.NIGHT_HOUR,
	B.LATE_HOUR,
	B.REG_EMP,
	B.REG_DATE
)
WHEN MATCHED THEN
UPDATE SET
	WORKER = B.WORKER,
	MANHOUR = B.MANHOUR,
	COLLECTION_MANHOUR = B.COLLECTION_MANHOUR,
	WORKLOAD = B.WORKLOAD,
	NOTE = B.NOTE,
	EXTENSION_HOUR = B.EXTENSION_HOUR,
	HOLIDAY_HOUR = B.HOLIDAY_HOUR,
	NIGHT_HOUR = B.NIGHT_HOUR,
	LATE_HOUR = B.LATE_HOUR,
	UPD_EMP = B.UPD_EMP,
	UPD_DATE = B.UPD_DATE
</update>

<update id="update_tbl_working_daily_approval">
/* oracle.yp_zwc_ipt.update_tbl_working_daily_report */
UPDATE TBL_WORKING_DAILY_REPORT A SET
	  /* 2021-03-24 jamerl - 조용래 : 휴일 저장시 투입공수, 공수, 작업량 0 처리 */
	  A.MANHOUR = CASE WHEN A.GUBUN = '0' THEN #{SUM_MANHOUR} ELSE 0 END
	, A.COLLECTION_MANHOUR = CASE WHEN A.GUBUN = '0' THEN #{SUM_COLLECTION_MANHOUR} ELSE 0 END
	, A.WORKLOAD_DT = CASE WHEN A.GUBUN = '0' THEN #{SUM_WORKLOAD_DT} ELSE 0 END
	, A.WORKLOAD = CASE WHEN A.GUBUN = '0' THEN #{SUM_WORKLOAD_DT} ELSE 0 END + A.COLLECTION_WORKLOAD
	, A.EXTENSION_HOUR = CASE WHEN A.GUBUN = '0' THEN #{SUM_EXTENSION_HOUR} ELSE 0 END
	, A.HOLIDAY_HOUR = CASE WHEN A.GUBUN = '0' THEN #{SUM_HOLIDAY_HOUR} ELSE 0 END
	, A.NIGHT_HOUR = CASE WHEN A.GUBUN = '0' THEN #{SUM_NIGHT_HOUR} ELSE 0 END
	, A.LATE_HOUR = CASE WHEN A.GUBUN = '0' THEN #{SUM_LATE_HOUR} ELSE 0 END
WHERE 1=1
AND A.BASE_YYYY = #{BASE_YYYY}
AND A.CONTRACT_CODE = #{CONTRACT_CODE}
AND A.VENDOR_CODE = #{VENDOR_CODE}
AND A.BASE_YYYYMMDD = #{BASE_YYYYMMDD}
</update>

<select id="pre_select_tbl_working_monthly_approval" resultType="integer">
/* oracle.yp_zwc_ipt.pre_select_tbl_working_monthly_approval */
SELECT COUNT(*) AS CNT
FROM TBL_WORKING_MONTHLY_REPORT A
WHERE 1=1
AND A.CHECK_YYYYMM = #{CHECK_YYYYMM}
AND A.BASE_YYYY = #{BASE_YYYY}
AND A.VENDOR_CODE = #{VENDOR_CODE}
AND A.CONTRACT_CODE = #{CONTRACT_CODE}
AND NVL(A.STATUS, 'NULL') NOT IN ('5', '7', 'NULL') -- 반려, 신규 이외는 재집계 불가
</select>

<delete id="delete_tbl_working_monthly_approval">
/* oracle.yp_zwc_ipt.delete_tbl_working_monthly_approval */
DELETE TBL_WORKING_MONTHLY_REPORT A
WHERE 1=1
AND A.CHECK_YYYYMM = #{CHECK_YYYYMM}
AND A.BASE_YYYY = #{BASE_YYYY}
AND A.VENDOR_CODE = #{VENDOR_CODE}
AND A.CONTRACT_CODE = #{CONTRACT_CODE}
</delete>

<update id="update_tbl_working_daily_approval_tlc">
/* oracle.yp_zwc_ipt.update_tbl_working_daily_approval_tlc */
UPDATE TBL_WORKING_DAILY_REPORT SET
	<choose>
		<when test='"Y".equalsIgnoreCase( TEAM_LEADER_CONFIRM_STR )'>
	TEAM_LEADER_CONFIRM_DT = SYSDATE,
		</when>
		<otherwise>
	TEAM_LEADER_CONFIRM_DT = NULL,
		</otherwise>
	</choose>
	TEAM_LEADER_CONFIRM = #{TEAM_LEADER_CONFIRM_STR}
WHERE 1=1
AND BASE_YYYY = #{BASE_YYYY}
AND CONTRACT_CODE = #{CONTRACT_CODE}
AND VENDOR_CODE = #{VENDOR_CODE}
AND BASE_YYYYMMDD = #{BASE_YYYYMMDD}
</update>

<select id="select_tbl_working_monthly_report_cnt" resultType="double">
/* oracle.yp_zwc_ipt2.select_tbl_working_monthly_report_cnt */
SELECT COUNT(*) AS CNT
FROM TBL_WORKING_SUBC A /* 계약 */
LEFT OUTER JOIN (
	SELECT
		B.BASE_YYYY, B.VENDOR_CODE, B.CONTRACT_CODE,
		SUM(NVL(B.EXTENSION_HOUR, 0)) AS EXTENSION_HOUR,
		SUM(NVL(B.NIGHT_HOUR, 0)) AS NIGHT_HOUR,
		SUM(NVL(B.SATURDAY_HOUR, 0)) AS SATURDAY_HOUR,
		SUM(NVL(B.HOLIDAY_HOUR, 0)) AS HOLIDAY_HOUR,
		SUM(NVL(B.LATE_HOUR, 0)) AS LATE_HOUR,
		SUM(NVL(B.MANHOUR, 0)) AS MANHOUR,
		SUM(NVL(B.COLLECTION_MANHOUR, 0)) AS COLLECTION_MANHOUR,
		SUM(NVL(B.WORKLOAD, 0)) AS WORKLOAD
	FROM TBL_WORKING_DAILY_REPORT B
	WHERE 1=1
	AND B.BASE_YYYY = SUBSTR(#{BASE_YYYY}, 1, 4)
<if test="VENDOR_CODE != null">
	AND B.VENDOR_CODE = #{VENDOR_CODE}
</if>
	AND SUBSTR(B.BASE_YYYYMMDD, 1, 6) = REPLACE(#{BASE_YYYY}, '/', '')
<if test="CONTRACT_CODE != null">
	AND B.CONTRACT_CODE = #{CONTRACT_CODE} AND B.BASE_YYYY = #{CONTRACT_BASE_YYYY}
</if>
	GROUP BY B.BASE_YYYY, B.VENDOR_CODE, B.CONTRACT_CODE
) B /* 연장, 야간, 토요, 휴일 */
	ON A.BASE_YYYY = B.BASE_YYYY
	AND A.VENDOR_CODE = B.VENDOR_CODE
	AND A.CONTRACT_CODE = B.CONTRACT_CODE
INNER JOIN TBL_WORKING_SUBC_CTN D
	ON A.BASE_YYYY = D.BASE_YYYY
	AND A.VENDOR_CODE = D.VENDOR_CODE
	AND A.CONTRACT_CODE = D.CONTRACT_CODE
LEFT OUTER JOIN TBL_WORKING_MONTHLY_REPORT Z
	ON A.BASE_YYYY = Z.BASE_YYYY
	AND A.VENDOR_CODE = Z.VENDOR_CODE
	AND A.CONTRACT_CODE = Z.CONTRACT_CODE
	AND Z.CHECK_YYYYMM = #{BASE_YYYY}
WHERE 1=1
AND A.BASE_YYYY = SUBSTR(#{BASE_YYYY}, 1, 4) -- 조회조건 시작일자 4자리 잘라서 사용
<if test="VENDOR_CODE != null">
AND A.VENDOR_CODE = #{VENDOR_CODE}
</if>
<if test="CONTRACT_CODE != null">
AND A.CONTRACT_CODE = #{CONTRACT_CODE} AND A.BASE_YYYY = #{CONTRACT_BASE_YYYY}
</if>
<!-- 계약등록시 부서와 로그인시 부서 체계가 서로 상이함 - 정해지기 전까지 주석처리 -->
<if test="DEPT_CODE != null">
AND A.DEPT_CODE = #{DEPT_CODE}
</if>
</select>

<select id="select_tbl_working_monthly_report" resultType="HashMap">
/* oracle.yp_zwc_ipt2.select_tbl_working_monthly_report */
SELECT
	X.*,
	/* 2021-03-03 jamerl - 조용래 : 지급액 재계산은 별도의 버튼 이벤트를 통해 산출하도록 변경 */
	NVL(X.PAY_AMOUNT_VIEW, 0) AS PAY_AMOUNT
	/*
	NVL(X.PAY_AMOUNT_VIEW, 
		NVL(X.SUBCONTRACTING_COST, 0) + 
		NVL(EXTENSION_AMOUNT, 0) + 
		NVL(NIGHT_AMOUNT, 0) + 
		NVL(SATURDAY_AMOUNT, 0) + 
		NVL(HOLIDAY_AMOUNT, 0) + 
		NVL(REWARD_AMOUNT, 0) + 
		NVL(ADDITIONAL_AMOUNT, 0) 
		- NVL(PENALTY_AMOUNT, 0) -- 패널티는 빼기
	) AS PAY_AMOUNT
	*/
FROM (
	SELECT
		B.TLC_YN, /* 2021-03-09 jamerl - 조용래 : 도급일보 승인받지 않은 데이터(TEAM_LEADER_CONFIRM : N) 존재시 조회제거 */
		Z.CHECK_YYYYMM 			AS CHECK_YYYYMM,
		A.BASE_YYYY 			AS BASE_YYYY,
		A.VENDOR_CODE 			AS VENDOR_CODE,
		(SELECT S.CODE_NAME FROM TBL_WORKING_MASTER S WHERE SUBSTR(S.CODE, 1, 1) = 'V' AND S.CODE = A.VENDOR_CODE) AS VENDOR_NAME,
		A.UNIT_CODE AS UNIT_CODE,
		(SELECT S.CODE_NAME FROM TBL_WORKING_MASTER S WHERE SUBSTR(S.CODE, 1, 1) = 'U' AND S.CODE = A.UNIT_CODE) AS UNIT_NAME,
		A.CONTRACT_CODE 		AS CONTRACT_CODE,
		A.CONTRACT_NAME 		AS CONTRACT_NAME,
		A.DEPT_CODE AS DEPT_CODE,
		A.DEPT_NAME AS DEPT_NAME,
		B.COLLECTION_MANHOUR 	AS MANHOUR,
		D.UNIT_PRICE 			AS UNIT_PRICE,
		NVL(Z.UNIT_PRICE, 0) 	AS UNIT_PRICE_V, /* 2021-08-02 jamerl - 조용래 : 집계된 단가 출력 */
		D.MONTH_STANDARD_AMOUNT AS MONTH_STANDARD_AMOUNT,
		A.GUBUN_CODE			AS GUBUN_CODE,
		CASE 
			WHEN A.GUBUN_CODE = '2' AND A.UNIT_CODE = 'U7' THEN B.COLLECTION_MANHOUR /* 2020-11-06 jamerl - 조용래 : 구분 인력, 단위 공 케이스에 [공수] 출력 적용 */
			ELSE B.WORKLOAD /* 2020-11-06 jamerl - 조용래 : 나머지 케이스는 모두 [작업량] 출력 적용 */
		END AS QUANTITY,
		Z.QUANTITY_CHANGED		AS QUANTITY_CHANGED,
		/*
		ROUND(NVL(Z.SUBCONTRACTING_COST, D.UNIT_PRICE * 
			CASE
				WHEN A.GUBUN_CODE = '2' AND A.UNIT_CODE != 'U7' THEN D.MONTH_STANDARD_AMOUNT -- [단가 X 월도급비]
				WHEN A.GUBUN_CODE = '2' AND A.UNIT_CODE = 'U7' THEN B.COLLECTION_MANHOUR -- 2020-11-06 jamerl - 조용래 : 구분 인력, 단위 공 케이스에 [단가 X 공수] 수식 적용
				ELSE B.WORKLOAD -- [단가 * 작업량]
			END
		), 0) AS SUBCONTRACTING_COST,
		*/
		ROUND(NVL(Z.SUBCONTRACTING_COST, 0), 0) AS SUBCONTRACTING_COST_V, /* 2021-03-03 jamerl - 조용래 : 집계된 월도급비 출력 */
		ROUND(
			D.UNIT_PRICE * 
			CASE
				WHEN A.GUBUN_CODE = '2' AND A.UNIT_CODE != 'U7' THEN D.MONTH_STANDARD_AMOUNT /* [단가 X 월도급비] */
				WHEN A.GUBUN_CODE = '2' AND A.UNIT_CODE = 'U7' THEN B.COLLECTION_MANHOUR /* 2020-11-06 jamerl - 조용래 : 구분 인력, 단위 공 케이스에 [단가 X 공수] 수식 적용 */
				ELSE B.WORKLOAD /* [단가 * 작업량] */
			END
		, 0) AS SUBCONTRACTING_COST, -- 2021-02-02 jamerl - 조용래 : 기초 데이터를 이용한 수식으로 값이 출력되도록 요청
		B.EXTENSION_HOUR 		AS EXTENSION_HOUR,
		-- NVL(Z.EXTENSION_AMOUNT, B.EXTENSION_HOUR * D.OVERTIME_EXTENSION) AS EXTENSION_AMOUNT,
		B.EXTENSION_HOUR * D.OVERTIME_EXTENSION AS EXTENSION_AMOUNT, -- 2021-02-02 jamerl - 조용래 : 기초 데이터를 이용한 수식으로 값이 출력되도록 요청
		B.NIGHT_HOUR 			AS NIGHT_HOUR,
		-- NVL(Z.NIGHT_AMOUNT, B.NIGHT_HOUR * D.OVERTIME_NIGHT) AS NIGHT_AMOUNT,
		B.NIGHT_HOUR * D.OVERTIME_NIGHT AS NIGHT_AMOUNT, -- 2021-02-02 jamerl - 조용래 : 기초 데이터를 이용한 수식으로 값이 출력되도록 요청
		B.SATURDAY_HOUR 		AS SATURDAY_MANHOUR,
		-- NVL(Z.SATURDAY_AMOUNT, B.SATURDAY_HOUR * D.OVERTIME_SATURDAY) AS SATURDAY_AMOUNT,
		B.SATURDAY_HOUR * D.OVERTIME_SATURDAY AS SATURDAY_AMOUNT, -- 2021-02-02 jamerl - 조용래 : 기초 데이터를 이용한 수식으로 값이 출력되도록 요청
		B.HOLIDAY_HOUR 			AS HOLIDAY_MANHOUR,
		-- NVL(Z.HOLIDAY_AMOUNT, B.HOLIDAY_HOUR * D.OVERTIME_HOLIDAY) AS HOLIDAY_AMOUNT,
		B.HOLIDAY_HOUR * D.OVERTIME_HOLIDAY AS HOLIDAY_AMOUNT, -- 2021-02-02 jamerl - 조용래 : 기초 데이터를 이용한 수식으로 값이 출력되도록 요청
		B.LATE_HOUR 			AS LATE_HOUR, /* 2021-11-02 jamerl - 조용래 : 단순 화면출력용, 도급비 계산에 미사용 */
		Z.REWARD_RATE, Z.REWARD_AMOUNT, 
		Z.REWARD_REASON 		AS REWARD_REASON,
		Z.ADDITIONAL_AMOUNT 	AS ADDITIONAL_AMOUNT,
		Z.ADDITIONAL_BASIS 		AS ADDITIONAL_BASIS,
		Z.ADDITIONAL_REASON 	AS ADDITIONAL_REASON,
		Z.PENALTY_AMOUNT 		AS PENALTY_AMOUNT,
		Z.PENALTY_BASIS 		AS PENALTY_BASIS,
		Z.PENALTY_REASON 		AS PENALTY_REASON,
		Z.PAY_AMOUNT 			AS PAY_AMOUNT_VIEW,
		Z.STATUS,
		F_GETCODENAME('YP_APPR_STATUS', Z.STATUS) AS STATUS_TXT
	FROM TBL_WORKING_SUBC A /* 계약 */
	LEFT OUTER JOIN (
		SELECT
			MIN(B.TEAM_LEADER_CONFIRM) AS TLC_YN, /* 2021-03-09 jamerl - 조용래 : 도급일보 승인받지 않은 데이터(TEAM_LEADER_CONFIRM : N) 존재시 조회제거 */
			B.BASE_YYYY, B.VENDOR_CODE, B.CONTRACT_CODE,
			SUM(NVL(B.EXTENSION_HOUR, 0)) AS EXTENSION_HOUR,
			SUM(NVL(B.NIGHT_HOUR, 0)) AS NIGHT_HOUR,
			SUM(NVL(B.SATURDAY_HOUR, 0)) AS SATURDAY_HOUR,
			SUM(NVL(B.HOLIDAY_HOUR, 0)) AS HOLIDAY_HOUR,
			SUM(NVL(B.LATE_HOUR, 0)) AS LATE_HOUR,
			SUM(NVL(B.MANHOUR, 0)) AS MANHOUR,
			SUM(NVL(B.COLLECTION_MANHOUR, 0)) AS COLLECTION_MANHOUR,
			SUM(NVL(B.WORKLOAD, 0)) AS WORKLOAD
		FROM TBL_WORKING_DAILY_REPORT B
		WHERE 1=1
		AND B.BASE_YYYY = SUBSTR(#{BASE_YYYY}, 1, 4)
	<if test="VENDOR_CODE != null">
		AND B.VENDOR_CODE = #{VENDOR_CODE}
	</if>
		AND SUBSTR(B.BASE_YYYYMMDD, 1, 6) = REPLACE(#{BASE_YYYY}, '/', '')
	<if test="CONTRACT_CODE != null">
		AND B.CONTRACT_CODE = #{CONTRACT_CODE} AND B.BASE_YYYY = #{CONTRACT_BASE_YYYY}
	</if>
		GROUP BY B.BASE_YYYY, B.VENDOR_CODE, B.CONTRACT_CODE
	) B /* 연장, 야간, 토요, 휴일 */
		ON A.BASE_YYYY = B.BASE_YYYY
		AND A.VENDOR_CODE = B.VENDOR_CODE
		AND A.CONTRACT_CODE = B.CONTRACT_CODE
	INNER JOIN TBL_WORKING_SUBC_CTN D
		ON A.BASE_YYYY = D.BASE_YYYY
		AND A.VENDOR_CODE = D.VENDOR_CODE
		AND A.CONTRACT_CODE = D.CONTRACT_CODE
	LEFT OUTER JOIN TBL_WORKING_MONTHLY_REPORT Z
		ON A.BASE_YYYY = Z.BASE_YYYY
		AND A.VENDOR_CODE = Z.VENDOR_CODE
		AND A.CONTRACT_CODE = Z.CONTRACT_CODE
		AND Z.CHECK_YYYYMM = REPLACE(#{BASE_YYYY}, '/', '')
	WHERE 1=1
	AND A.BASE_YYYY = SUBSTR(#{BASE_YYYY}, 1, 4) -- 조회조건 시작일자 4자리 잘라서 사용
	AND B.TLC_YN = 'Y' /* 2021-03-09 jamerl - 조용래 : 도급일보 승인받지 않은 데이터(TEAM_LEADER_CONFIRM : N) 존재시 조회제거 */
	<if test="VENDOR_CODE != null">
	AND A.VENDOR_CODE = #{VENDOR_CODE}
	</if>
	<if test="CONTRACT_CODE != null">
	AND A.CONTRACT_CODE = #{CONTRACT_CODE} AND A.BASE_YYYY = #{CONTRACT_BASE_YYYY}
	</if>
	<!-- 계약등록시 부서와 로그인시 부서 체계가 서로 상이함 - 정해지기 전까지 주석처리 -->
	<if test="DEPT_CODE != null">
	AND A.DEPT_CODE = #{DEPT_CODE}
	</if>
	<choose>
		<when test='GUBUN_CODE_AGGREGATION != null and "0".equalsIgnoreCase( GUBUN_CODE_AGGREGATION )'>
	AND A.GUBUN_CODE = '3' -- 저장품(0)
		</when>
		<when test='GUBUN_CODE_AGGREGATION != null and "1".equalsIgnoreCase( GUBUN_CODE_AGGREGATION )'>
	AND A.GUBUN_CODE <![CDATA[<>]]> '3' -- 저장품 외(1)
		</when>
	</choose>
) X
ORDER BY X.CHECK_YYYYMM, X.BASE_YYYY, X.VENDOR_CODE, X.CONTRACT_CODE
</select>

<select id="grid_ipt2_contract_bill_cnt" resultType="double">
/* oracle.yp_zwc_ipt2.grid_ipt2_contract_bill_cnt */
SELECT COUNT(*)
FROM (
	SELECT
		B.TLC_YN, /* 2021-03-09 jamerl - 조용래 : 도급일보 승인받지 않은 데이터(TEAM_LEADER_CONFIRM : N) 존재시 조회제거 */
		Z.CHECK_YYYYMM 			AS CHECK_YYYYMM,
		A.BASE_YYYY 			AS BASE_YYYY,
		A.VENDOR_CODE 			AS VENDOR_CODE,
		(SELECT S.CODE_NAME FROM TBL_WORKING_MASTER S WHERE SUBSTR(S.CODE, 1, 1) = 'V' AND S.CODE = A.VENDOR_CODE) AS VENDOR_NAME,
		A.UNIT_CODE AS UNIT_CODE,
		(SELECT S.CODE_NAME FROM TBL_WORKING_MASTER S WHERE SUBSTR(S.CODE, 1, 1) = 'U' AND S.CODE = A.UNIT_CODE) AS UNIT_NAME,
		A.CONTRACT_CODE 		AS CONTRACT_CODE,
		A.CONTRACT_NAME 		AS CONTRACT_NAME,
		A.DEPT_CODE AS DEPT_CODE,
		A.DEPT_NAME AS DEPT_NAME,
		B.COLLECTION_MANHOUR 	AS MANHOUR,
		D.UNIT_PRICE 			AS UNIT_PRICE,
		NVL(Z.UNIT_PRICE, 0) 	AS UNIT_PRICE_V, /* 2021-08-02 jamerl - 조용래 : 집계된 단가 출력 */
		D.MONTH_STANDARD_AMOUNT AS MONTH_STANDARD_AMOUNT,
		A.GUBUN_CODE			AS GUBUN_CODE,
		CASE 
			WHEN A.GUBUN_CODE = '2' AND A.UNIT_CODE = 'U7' THEN B.COLLECTION_MANHOUR /* 2020-11-06 jamerl - 조용래 : 구분 인력, 단위 공 케이스에 [공수] 출력 적용 */
			ELSE B.WORKLOAD /* 2020-11-06 jamerl - 조용래 : 나머지 케이스는 모두 [작업량] 출력 적용 */
		END AS QUANTITY,
		Z.QUANTITY_CHANGED		AS QUANTITY_CHANGED,
		ROUND(NVL(Z.SUBCONTRACTING_COST, 0), 0) AS SUBCONTRACTING_COST_V, /* 2021-03-03 jamerl - 조용래 : 집계된 월도급비 출력 */
		ROUND(
			D.UNIT_PRICE * 
			CASE
				WHEN A.GUBUN_CODE = '2' AND A.UNIT_CODE != 'U7' THEN D.MONTH_STANDARD_AMOUNT /* [단가 X 월도급비] */
				WHEN A.GUBUN_CODE = '2' AND A.UNIT_CODE = 'U7' THEN B.COLLECTION_MANHOUR /* 2020-11-06 jamerl - 조용래 : 구분 인력, 단위 공 케이스에 [단가 X 공수] 수식 적용 */
				ELSE B.WORKLOAD /* [단가 * 작업량] */
			END
		, 0) AS SUBCONTRACTING_COST, -- 2021-02-02 jamerl - 조용래 : 기초 데이터를 이용한 수식으로 값이 출력되도록 요청
		B.EXTENSION_HOUR 		AS EXTENSION_HOUR,
		B.EXTENSION_HOUR * D.OVERTIME_EXTENSION AS EXTENSION_AMOUNT, -- 2021-02-02 jamerl - 조용래 : 기초 데이터를 이용한 수식으로 값이 출력되도록 요청
		B.NIGHT_HOUR 			AS NIGHT_HOUR,
		B.NIGHT_HOUR * D.OVERTIME_NIGHT AS NIGHT_AMOUNT, -- 2021-02-02 jamerl - 조용래 : 기초 데이터를 이용한 수식으로 값이 출력되도록 요청
		B.SATURDAY_HOUR 		AS SATURDAY_MANHOUR,
		B.SATURDAY_HOUR * D.OVERTIME_SATURDAY AS SATURDAY_AMOUNT, -- 2021-02-02 jamerl - 조용래 : 기초 데이터를 이용한 수식으로 값이 출력되도록 요청
		B.HOLIDAY_HOUR 			AS HOLIDAY_MANHOUR,
		B.HOLIDAY_HOUR * D.OVERTIME_HOLIDAY AS HOLIDAY_AMOUNT, -- 2021-02-02 jamerl - 조용래 : 기초 데이터를 이용한 수식으로 값이 출력되도록 요청
		B.LATE_HOUR 			AS LATE_HOUR, /* 2021-11-02 jamerl - 조용래 : 단순 화면출력용, 도급비 계산에 미사용 */
		Z.REWARD_RATE, Z.REWARD_AMOUNT, 
		Z.REWARD_REASON 		AS REWARD_REASON,
		Z.ADDITIONAL_AMOUNT 	AS ADDITIONAL_AMOUNT,
		Z.ADDITIONAL_BASIS 		AS ADDITIONAL_BASIS,
		Z.ADDITIONAL_REASON 	AS ADDITIONAL_REASON,
		Z.PENALTY_AMOUNT 		AS PENALTY_AMOUNT,
		Z.PENALTY_BASIS 		AS PENALTY_BASIS,
		Z.PENALTY_REASON 		AS PENALTY_REASON,
		Z.PAY_AMOUNT 			AS PAY_AMOUNT_VIEW,
		Z.STATUS,
		F_GETCODENAME('YP_APPR_STATUS', Z.STATUS) AS STATUS_TXT
	FROM TBL_WORKING_SUBC A /* 계약 */
	LEFT OUTER JOIN (
		SELECT
			MIN(B.TEAM_LEADER_CONFIRM) AS TLC_YN, /* 2021-03-09 jamerl - 조용래 : 도급일보 승인받지 않은 데이터(TEAM_LEADER_CONFIRM : N) 존재시 조회제거 */
			B.BASE_YYYY, B.VENDOR_CODE, B.CONTRACT_CODE,
			SUM(NVL(B.EXTENSION_HOUR, 0)) AS EXTENSION_HOUR,
			SUM(NVL(B.NIGHT_HOUR, 0)) AS NIGHT_HOUR,
			SUM(NVL(B.SATURDAY_HOUR, 0)) AS SATURDAY_HOUR,
			SUM(NVL(B.HOLIDAY_HOUR, 0)) AS HOLIDAY_HOUR,
			SUM(NVL(B.LATE_HOUR, 0)) AS LATE_HOUR,
			SUM(NVL(B.MANHOUR, 0)) AS MANHOUR,
			SUM(NVL(B.COLLECTION_MANHOUR, 0)) AS COLLECTION_MANHOUR,
			SUM(NVL(B.WORKLOAD, 0)) AS WORKLOAD
		FROM TBL_WORKING_DAILY_REPORT B
		WHERE 1=1
		AND B.VENDOR_CODE = #{VENDOR_CODE}
		AND SUBSTR(B.BASE_YYYYMMDD, 1, 6) = REPLACE(#{BASE_YYYY}, '/', '')
		GROUP BY B.BASE_YYYY, B.VENDOR_CODE, B.CONTRACT_CODE
	) B /* 연장, 야간, 토요, 휴일 */
		ON A.BASE_YYYY = B.BASE_YYYY
		AND A.VENDOR_CODE = B.VENDOR_CODE
		AND A.CONTRACT_CODE = B.CONTRACT_CODE
	INNER JOIN TBL_WORKING_SUBC_CTN D
		ON A.BASE_YYYY = D.BASE_YYYY
		AND A.VENDOR_CODE = D.VENDOR_CODE
		AND A.CONTRACT_CODE = D.CONTRACT_CODE
	LEFT OUTER JOIN TBL_WORKING_MONTHLY_REPORT Z
		ON A.BASE_YYYY = Z.BASE_YYYY
		AND A.VENDOR_CODE = Z.VENDOR_CODE
		AND A.CONTRACT_CODE = Z.CONTRACT_CODE
		AND Z.CHECK_YYYYMM = REPLACE(#{BASE_YYYY}, '/', '')
	WHERE 1=1
	AND A.BASE_YYYY = SUBSTR(#{BASE_YYYY}, 1, 4) -- 조회조건 시작일자 4자리 잘라서 사용
	AND B.TLC_YN = 'Y' /* 2021-03-09 jamerl - 조용래 : 도급일보 승인받지 않은 데이터(TEAM_LEADER_CONFIRM : N) 존재시 조회제거 */
	AND A.VENDOR_CODE = #{VENDOR_CODE}
	<choose>
		<when test='GUBUN_CODE_AGGREGATION != null and "0".equalsIgnoreCase( GUBUN_CODE_AGGREGATION )'>
	AND A.GUBUN_CODE = '3' -- 저장품(0)
		</when>
		<when test='GUBUN_CODE_AGGREGATION != null and "1".equalsIgnoreCase( GUBUN_CODE_AGGREGATION )'>
	AND A.GUBUN_CODE <![CDATA[<>]]> '3' -- 저장품 외(1)
		</when>
	</choose>
) X
</select>

<select id="grid_ipt2_contract_bill" resultType="HashMap">
/* oracle.yp_zwc_ipt2.grid_ipt2_contract_bill */
SELECT
	  #{BASE_YYYY} AS BASE_YYYY
	, #{VENDOR_CODE} AS VENDOR_CODE
	, #{GUBUN_CODE_AGGREGATION} AS GUBUN_CODE_AGGREGATION
	, X.CONTRACT_CODE
	, X.CONTRACT_NAME
	, X.UNIT_NAME
	, NVL( X.QUANTITY_CHANGED, X.QUANTITY ) AS QUANTITY
	, NVL( X.UNIT_PRICE, 0) AS UNIT_PRICE
	, NVL( X.REWARD_AMOUNT, 0) AS REWARD_AMOUNT
	, NVL( X.ADDITIONAL_AMOUNT, 0) AS ADDITIONAL_AMOUNT
	, NVL( X.PENALTY_AMOUNT, 0) AS PENALTY_AMOUNT
	, NVL( X.EXTENSION_AMOUNT, 0) AS EXTENSION_AMOUNT
	, NVL( X.HOLIDAY_AMOUNT, 0) AS HOLIDAY_AMOUNT
	, NVL( X.NIGHT_AMOUNT, 0) AS NIGHT_AMOUNT
	, NVL( X.LATE_HOUR, 0) AS LATE_HOUR
	, NVL(X.PAY_AMOUNT_VIEW, 0) AS PAY_AMOUNT
	, (SELECT S.ENT_NAME FROM TBL_ENTERPRISE S WHERE S.VENDOR_CODE = #{VENDOR_CODE}) AS P1
	, (SELECT S.REPRESENTATIVE FROM TBL_ENTERPRISE S WHERE S.VENDOR_CODE = #{VENDOR_CODE}) AS P2
FROM (
	SELECT
		B.TLC_YN, /* 2021-03-09 jamerl - 조용래 : 도급일보 승인받지 않은 데이터(TEAM_LEADER_CONFIRM : N) 존재시 조회제거 */
		Z.CHECK_YYYYMM 			AS CHECK_YYYYMM,
		A.BASE_YYYY 			AS BASE_YYYY,
		A.VENDOR_CODE 			AS VENDOR_CODE,
		(SELECT S.CODE_NAME FROM TBL_WORKING_MASTER S WHERE SUBSTR(S.CODE, 1, 1) = 'V' AND S.CODE = A.VENDOR_CODE) AS VENDOR_NAME,
		A.UNIT_CODE AS UNIT_CODE,
		(SELECT S.CODE_NAME FROM TBL_WORKING_MASTER S WHERE SUBSTR(S.CODE, 1, 1) = 'U' AND S.CODE = A.UNIT_CODE) AS UNIT_NAME,
		A.CONTRACT_CODE 		AS CONTRACT_CODE,
		A.CONTRACT_NAME 		AS CONTRACT_NAME,
		A.DEPT_CODE AS DEPT_CODE,
		A.DEPT_NAME AS DEPT_NAME,
		B.COLLECTION_MANHOUR 	AS MANHOUR,
		D.UNIT_PRICE 			AS UNIT_PRICE,
		NVL(Z.UNIT_PRICE, 0) 	AS UNIT_PRICE_V, /* 2021-08-02 jamerl - 조용래 : 집계된 단가 출력 */
		D.MONTH_STANDARD_AMOUNT AS MONTH_STANDARD_AMOUNT,
		A.GUBUN_CODE			AS GUBUN_CODE,
		CASE 
			WHEN A.GUBUN_CODE = '2' AND A.UNIT_CODE = 'U7' THEN B.COLLECTION_MANHOUR /* 2020-11-06 jamerl - 조용래 : 구분 인력, 단위 공 케이스에 [공수] 출력 적용 */
			ELSE B.WORKLOAD /* 2020-11-06 jamerl - 조용래 : 나머지 케이스는 모두 [작업량] 출력 적용 */
		END AS QUANTITY,
		Z.QUANTITY_CHANGED		AS QUANTITY_CHANGED,
		ROUND(NVL(Z.SUBCONTRACTING_COST, 0), 0) AS SUBCONTRACTING_COST_V, /* 2021-03-03 jamerl - 조용래 : 집계된 월도급비 출력 */
		ROUND(
			D.UNIT_PRICE * 
			CASE
				WHEN A.GUBUN_CODE = '2' AND A.UNIT_CODE != 'U7' THEN D.MONTH_STANDARD_AMOUNT /* [단가 X 월도급비] */
				WHEN A.GUBUN_CODE = '2' AND A.UNIT_CODE = 'U7' THEN B.COLLECTION_MANHOUR /* 2020-11-06 jamerl - 조용래 : 구분 인력, 단위 공 케이스에 [단가 X 공수] 수식 적용 */
				ELSE B.WORKLOAD /* [단가 * 작업량] */
			END
		, 0) AS SUBCONTRACTING_COST, -- 2021-02-02 jamerl - 조용래 : 기초 데이터를 이용한 수식으로 값이 출력되도록 요청
		B.EXTENSION_HOUR 		AS EXTENSION_HOUR,
		B.EXTENSION_HOUR * D.OVERTIME_EXTENSION AS EXTENSION_AMOUNT, -- 2021-02-02 jamerl - 조용래 : 기초 데이터를 이용한 수식으로 값이 출력되도록 요청
		B.NIGHT_HOUR 			AS NIGHT_HOUR,
		B.NIGHT_HOUR * D.OVERTIME_NIGHT AS NIGHT_AMOUNT, -- 2021-02-02 jamerl - 조용래 : 기초 데이터를 이용한 수식으로 값이 출력되도록 요청
		B.SATURDAY_HOUR 		AS SATURDAY_MANHOUR,
		B.SATURDAY_HOUR * D.OVERTIME_SATURDAY AS SATURDAY_AMOUNT, -- 2021-02-02 jamerl - 조용래 : 기초 데이터를 이용한 수식으로 값이 출력되도록 요청
		B.HOLIDAY_HOUR 			AS HOLIDAY_MANHOUR,
		B.HOLIDAY_HOUR * D.OVERTIME_HOLIDAY AS HOLIDAY_AMOUNT, -- 2021-02-02 jamerl - 조용래 : 기초 데이터를 이용한 수식으로 값이 출력되도록 요청
		B.LATE_HOUR 			AS LATE_HOUR, /* 2021-11-02 jamerl - 조용래 : 단순 화면출력용, 도급비 계산에 미사용 */
		Z.REWARD_RATE, Z.REWARD_AMOUNT, 
		Z.REWARD_REASON 		AS REWARD_REASON,
		Z.ADDITIONAL_AMOUNT 	AS ADDITIONAL_AMOUNT,
		Z.ADDITIONAL_BASIS 		AS ADDITIONAL_BASIS,
		Z.ADDITIONAL_REASON 	AS ADDITIONAL_REASON,
		Z.PENALTY_AMOUNT 		AS PENALTY_AMOUNT,
		Z.PENALTY_BASIS 		AS PENALTY_BASIS,
		Z.PENALTY_REASON 		AS PENALTY_REASON,
		Z.PAY_AMOUNT 			AS PAY_AMOUNT_VIEW,
		Z.STATUS,
		F_GETCODENAME('YP_APPR_STATUS', Z.STATUS) AS STATUS_TXT
	FROM TBL_WORKING_SUBC A /* 계약 */
	LEFT OUTER JOIN (
		SELECT
			MIN(B.TEAM_LEADER_CONFIRM) AS TLC_YN, /* 2021-03-09 jamerl - 조용래 : 도급일보 승인받지 않은 데이터(TEAM_LEADER_CONFIRM : N) 존재시 조회제거 */
			B.BASE_YYYY, B.VENDOR_CODE, B.CONTRACT_CODE,
			SUM(NVL(B.EXTENSION_HOUR, 0)) AS EXTENSION_HOUR,
			SUM(NVL(B.NIGHT_HOUR, 0)) AS NIGHT_HOUR,
			SUM(NVL(B.SATURDAY_HOUR, 0)) AS SATURDAY_HOUR,
			SUM(NVL(B.HOLIDAY_HOUR, 0)) AS HOLIDAY_HOUR,
			SUM(NVL(B.LATE_HOUR, 0)) AS LATE_HOUR,
			SUM(NVL(B.MANHOUR, 0)) AS MANHOUR,
			SUM(NVL(B.COLLECTION_MANHOUR, 0)) AS COLLECTION_MANHOUR,
			SUM(NVL(B.WORKLOAD, 0)) AS WORKLOAD
		FROM TBL_WORKING_DAILY_REPORT B
		WHERE 1=1
		AND B.VENDOR_CODE = #{VENDOR_CODE}
		AND SUBSTR(B.BASE_YYYYMMDD, 1, 6) = REPLACE(#{BASE_YYYY}, '/', '')
		GROUP BY B.BASE_YYYY, B.VENDOR_CODE, B.CONTRACT_CODE
	) B /* 연장, 야간, 토요, 휴일 */
		ON A.BASE_YYYY = B.BASE_YYYY
		AND A.VENDOR_CODE = B.VENDOR_CODE
		AND A.CONTRACT_CODE = B.CONTRACT_CODE
	INNER JOIN TBL_WORKING_SUBC_CTN D
		ON A.BASE_YYYY = D.BASE_YYYY
		AND A.VENDOR_CODE = D.VENDOR_CODE
		AND A.CONTRACT_CODE = D.CONTRACT_CODE
	LEFT OUTER JOIN TBL_WORKING_MONTHLY_REPORT Z
		ON A.BASE_YYYY = Z.BASE_YYYY
		AND A.VENDOR_CODE = Z.VENDOR_CODE
		AND A.CONTRACT_CODE = Z.CONTRACT_CODE
		AND Z.CHECK_YYYYMM = REPLACE(#{BASE_YYYY}, '/', '')
	WHERE 1=1
	AND A.BASE_YYYY = SUBSTR(#{BASE_YYYY}, 1, 4) -- 조회조건 시작일자 4자리 잘라서 사용
	AND B.TLC_YN = 'Y' /* 2021-03-09 jamerl - 조용래 : 도급일보 승인받지 않은 데이터(TEAM_LEADER_CONFIRM : N) 존재시 조회제거 */
	AND A.VENDOR_CODE = #{VENDOR_CODE}
	<choose>
		<when test='GUBUN_CODE_AGGREGATION != null and "0".equalsIgnoreCase( GUBUN_CODE_AGGREGATION )'>
	AND A.GUBUN_CODE = '3' -- 저장품(0)
		</when>
		<when test='GUBUN_CODE_AGGREGATION != null and "1".equalsIgnoreCase( GUBUN_CODE_AGGREGATION )'>
	AND A.GUBUN_CODE <![CDATA[<>]]> '3' -- 저장품 외(1)
		</when>
	</choose>
) X
ORDER BY X.CHECK_YYYYMM, X.BASE_YYYY, X.VENDOR_CODE, X.CONTRACT_CODE
</select>

<select id="pre_select_ipt2_contract_bill_exist" resultType="integer">
/* oracle.yp_zwc_ipt2.pre_select_ipt2_contract_bill_exist - 도급비집계 데이터가 존재해야 첨부 가능 */
SELECT COUNT(*) AS CNT
FROM TBL_WORKING_SUBC_COST_COUNT A
WHERE 1=1
AND A.CHECK_YYYYMM = REPLACE(#{BASE_YYYY}, '/', '')
AND A.VENDOR_CODE = #{VENDOR_CODE}
AND A.GUBUN_CODE = #{GUBUN_CODE_AGGREGATION}
</select>

<select id="pre_select_ipt2_contract_bill_status" resultType="integer">
/* oracle.yp_zwc_ipt2.pre_select_ipt2_contract_bill_status - 도급비집계 데이터의 결재상태가 미결재만 첨부 가능 */
SELECT COUNT(*) AS CNT
FROM TBL_WORKING_SUBC_COST_COUNT A
WHERE 1=1
AND A.CHECK_YYYYMM = REPLACE(#{BASE_YYYY}, '/', '')
AND A.VENDOR_CODE = #{VENDOR_CODE}
AND A.GUBUN_CODE = #{GUBUN_CODE_AGGREGATION}
AND NVL(A.STATUS, 'NULL') NOT IN ('5', '7', 'NULL') -- 반려, 신규 이외는 도급비청구서 첨부 불가
</select>

<update id="update_zwc_ipt2_contract_bill_upload">
/* oracle.yp_zwc_ipt2.update_zwc_ipt2_contract_bill_upload - 도급비집계 도급비청구서 첨부파일 입력 */
UPDATE TBL_WORKING_SUBC_COST_COUNT A SET
	  A.ATTACH_YN = 'Y'
	, A.ATTACH_URL = #{ATTACH_URL}
	, A.ATTACH_DT = SYSDATE
	, A.ATTACH_EMP = #{s_emp_code}
WHERE 1=1
AND A.CHECK_YYYYMM = REPLACE(#{BASE_YYYY}, '/', '')
AND A.VENDOR_CODE = #{VENDOR_CODE}
AND A.GUBUN_CODE = #{GUBUN_CODE_AGGREGATION}
</update>

<select id="select_zwc_ipt2_contract_bill_upload" resultType="HashMap">
/* oracle.yp_zwc_ipt2.select_zwc_ipt2_contract_bill_upload - 도급비청구서 파일정보 가져오기 */
SELECT
	  MAX( A.ATTACH_YN ) AS ATTACH_YN
	, MAX( A.ATTACH_URL ) AS ATTACH_URL
	, COUNT(*) AS CNT
FROM TBL_WORKING_SUBC_COST_COUNT A
WHERE 1=1
AND A.CHECK_YYYYMM = REPLACE(#{BASE_YYYY}, '/', '')
AND A.VENDOR_CODE = #{VENDOR_CODE}
AND A.GUBUN_CODE = #{GUBUN_CODE_AGGREGATION}
</select>

</mapper>