<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="oracle.yp_zwc_rpt">

<select id="select_vendor_name" resultType="String">
/* oracle.yp_zwc_rpt.select_vendor_name */
SELECT A.CODE_NAME AS VENDOR_NAME
FROM TBL_WORKING_MASTER A
WHERE 1=1
AND SUBSTR(A.CODE, 1, 1) = 'V'
AND A.CODE = #{RECEIVE_VENDOR_CODE}
AND A.ENTERPRISE_GUBUN IN ('1', '2') -- 조업 및 정비 거래처
</select>

<select id="select_cb_working_master_v" resultType="HashMap">
/* oracle.yp_zwc_rpt.select_cb_working_master_v */
SELECT
	A.CODE,
	A.CODE_NAME
FROM TBL_WORKING_MASTER A
WHERE 1=1
AND A.USE_YN = 'Y'
AND SUBSTR(A.CODE, 1, 1) = 'V'
AND A.ENTERPRISE_GUBUN IN ('1', '2') -- 조업 및 정비 거래처
ORDER BY A.BASE_YYYY, TO_NUMBER(REGEXP_REPLACE(A.CODE, '[^0-9]'))
</select>

<delete id="delete_subc_cost_adjust">
/* oracle.yp_zwc_rpt.delete_subc_cost_adjust */
DELETE TBL_WORKING_SUBC_COST_ADJUST
WHERE 1=1
AND BASE_YYYY = #{BASE_YYYY}
AND VENDOR_CODE = #{VENDOR_CODE}
</delete>

<update id="merge_subc_cost_adjust">
/* oracle.yp_zwc_rpt.merge_subc_cost_adjust */
MERGE INTO TBL_WORKING_SUBC_COST_ADJUST A
USING (
	SELECT 
		-- E.GUBUN_NAME,
		E.BASE_YYYY,
		E.CONTRACT_CODE,
	    E.VENDOR_CODE,
		-- E.CONTRACT_NAME,
		-- E.DEPT_CODE,
		-- E.DEPT_NAME,
		-- E.UNIT_NAME,
		NVL(F.P_ADJUST_MAN_QTY,0) AS CURRENT_MAN_QTY, --현행 인원
		NVL(F.P_ADJUST_UNIT_PRICE,0) AS CURRENT_UNIT_PRICE,  --현행 단가
		NVL(F.P_ADJUST_QUANTITY,0) AS CURRENT_QUANTITY,  --현행 물량
		NVL(F.P_ADJUST_SUBCONTRACTING_COST,0) AS CURRENT_SUBCONTRACTING_COST, --현행 월도급비
		NVL(E.ADJUST_MAN_QTY,0) AS ADJUST_MAN_QTY,  --조정안 인원
		NVL(E.ADJUST_UNIT_PRICE,0) AS ADJUST_UNIT_PRICE, --조정안 단가
		NVL(E.ADJUST_QUANTITY,0) AS ADJUST_QUANTITY, --조정안 물량
		NVL(E.ADJUST_SUBCONTRACTING_COST,0) AS ADJUST_SUBCONTRACTING_COST, --조정안 월도급비
		-- (올해-전년)/올래*100, 제수가 0입니다는 decode를 사용하여 처리  
		--DECODE(NVL(E.ADJUST_SUBCONTRACTING_COST,0),0,0,NULL,0, NVL(E.ADJUST_SUBCONTRACTING_COST,0)-NVL(F.P_ADJUST_SUBCONTRACTING_COST,0)/NVL(E.ADJUST_SUBCONTRACTING_COST,0) * 100) AS VARIATION_RATE
		#{s_emp_code} AS REG_EMP,
		#{s_emp_code} AS UPD_EMP,
		sysdate AS REG_DATE,
		sysdate AS UPD_DATE
	FROM (
	-- 해당년도 도급비는 등록된 계약, 계약금액을 참조하여 데이터를 생성
	    SELECT 
		    F_GETCODENAME('YP_SUBC_GUBUN', A.GUBUN_CODE) AS GUBUN_NAME,
			A.BASE_YYYY,
			A.CONTRACT_CODE ,
			A.VENDOR_CODE,
			A.CONTRACT_NAME,
			A.DEPT_CODE,
			A.DEPT_NAME, -- 팀별
			F_YP_GETMSTNM(A.UNIT_CODE, NULL) AS UNIT_NAME, -- 단위
			NVL(D.MAN_QTY,0) AS ADJUST_MAN_QTY, -- 조정안 인원
		    NVL(C.UNIT_PRICE,0) AS ADJUST_UNIT_PRICE, -- 단가
			NVL(C.MONTH_STANDARD_AMOUNT,0) AS ADJUST_QUANTITY, -- 물량
			NVL(C.MONTH_STANDARD_AMOUNT * C.UNIT_PRICE,0) AS ADJUST_SUBCONTRACTING_COST  --월도급비
		FROM TBL_WORKING_SUBC A
		LEFT OUTER JOIN TBL_WORKING_SUBC_CTN C
			ON A.BASE_YYYY = C.BASE_YYYY 
			AND A.CONTRACT_CODE  = C.CONTRACT_CODE 
			AND A.VENDOR_CODE  = C.VENDOR_CODE 
		LEFT OUTER JOIN (
			SELECT 
				B.BASE_YYYY,
				B.CONTRACT_CODE ,
				B.VENDOR_CODE,
				SUM(B.MAN_QTY) AS MAN_QTY
			FROM TBL_WORKING_SUBC_CTN_DT B
			WHERE B.BASE_YYYY = #{BASE_YYYY}  --입력파라미터
			AND B.VENDOR_CODE = #{VENDOR_CODE}  --입력파라미터
			GROUP BY B.BASE_YYYY, B.CONTRACT_CODE, B.VENDOR_CODE
		) D
			ON A.BASE_YYYY = D.BASE_YYYY
			AND A.CONTRACT_CODE = D.CONTRACT_CODE
			AND A.VENDOR_CODE = D.VENDOR_CODE
		WHERE A.BASE_YYYY = #{BASE_YYYY}  --입력파라미터
		AND A.VENDOR_CODE = #{VENDOR_CODE}  --입력파라미터
		
		UNION ALL 
		
		-- 인력계약은 야간, 연장, 토요, 휴일 수당 라인 추가
	    SELECT 
		    F_GETCODENAME('YP_SUBC_GUBUN', A.GUBUN_CODE) AS GUBUN_NAME,
			A.BASE_YYYY,
			A.CONTRACT_CODE || '-01' AS CONTRACT_CODE,
			A.VENDOR_CODE,
			A.CONTRACT_NAME || '-야간수당',
			A.DEPT_CODE,
			A.DEPT_NAME, -- 팀별
			F_YP_GETMSTNM(A.UNIT_CODE, NULL) AS UNIT_NAME, -- 단위
			0 AS ADJUST_MAN_QTY, -- 조정안 인원
		    NVL(C.OVERTIME_NIGHT,0) AS ADJUST_UNIT_PRICE, -- 단가
			0 AS ADJUST_QUANTITY, -- 물량
			0 AS ADJUST_SUBCONTRACTING_COST  --월도급비
		FROM TBL_WORKING_SUBC A
		LEFT OUTER JOIN TBL_WORKING_SUBC_CTN C
			ON A.BASE_YYYY = C.BASE_YYYY 
			AND A.CONTRACT_CODE  = C.CONTRACT_CODE 
			AND A.VENDOR_CODE  = C.VENDOR_CODE 
		WHERE A.BASE_YYYY = #{BASE_YYYY}  --입력파라미터
		AND A.VENDOR_CODE = #{VENDOR_CODE}  --입력파라미터
		AND C.OVERTIME_NIGHT >= 0
		AND A.GUBUN_CODE = '2'
		AND A.WORKING_GUBUN = 'N'
		
		UNION ALL 
		
		SELECT 
		    F_GETCODENAME('YP_SUBC_GUBUN', A.GUBUN_CODE) AS GUBUN_NAME,
			A.BASE_YYYY,
			A.CONTRACT_CODE || '-02' AS CONTRACT_CODE,
			A.VENDOR_CODE,
			A.CONTRACT_NAME || '-연장수당',
			A.DEPT_CODE,
			A.DEPT_NAME, -- 팀별
			F_YP_GETMSTNM(A.UNIT_CODE, NULL) AS UNIT_NAME, -- 단위
			0 AS ADJUST_MAN_QTY, -- 조정안 인원
		    NVL(C.OVERTIME_EXTENSION,0) AS ADJUST_UNIT_PRICE, -- 단가
			0 AS ADJUST_QUANTITY, -- 물량
			0 AS ADJUST_SUBCONTRACTING_COST  --월도급비
		FROM TBL_WORKING_SUBC A
		LEFT OUTER JOIN TBL_WORKING_SUBC_CTN C
			ON A.BASE_YYYY = C.BASE_YYYY 
			AND A.CONTRACT_CODE  = C.CONTRACT_CODE 
			AND A.VENDOR_CODE  = C.VENDOR_CODE 
		WHERE A.BASE_YYYY = #{BASE_YYYY}  --입력파라미터
		AND A.VENDOR_CODE = #{VENDOR_CODE}  --입력파라미터
		AND C.OVERTIME_EXTENSION >= 0
		AND A.GUBUN_CODE = '2'
		AND A.WORKING_GUBUN = 'N'
		
		UNION ALL 
		
		SELECT 
		    F_GETCODENAME('YP_SUBC_GUBUN', A.GUBUN_CODE) AS GUBUN_NAME,
			A.BASE_YYYY,
			A.CONTRACT_CODE || '-03' AS CONTRACT_CODE,
			A.VENDOR_CODE,
			A.CONTRACT_NAME || '-휴일수당',
			A.DEPT_CODE,
			A.DEPT_NAME, -- 팀별
			F_YP_GETMSTNM(A.UNIT_CODE, NULL) AS UNIT_NAME, -- 단위
			0 AS ADJUST_MAN_QTY, -- 조정안 인원
		    NVL(C.OVERTIME_HOLIDAY,0) AS ADJUST_UNIT_PRICE, -- 단가
			0 AS ADJUST_QUANTITY, -- 물량
			0 AS ADJUST_SUBCONTRACTING_COST  --월도급비
		FROM TBL_WORKING_SUBC A
		LEFT OUTER JOIN TBL_WORKING_SUBC_CTN C
			ON A.BASE_YYYY = C.BASE_YYYY 
			AND A.CONTRACT_CODE  = C.CONTRACT_CODE 
			AND A.VENDOR_CODE  = C.VENDOR_CODE 
		WHERE A.BASE_YYYY = #{BASE_YYYY}
		AND A.VENDOR_CODE = #{VENDOR_CODE}
		AND C.OVERTIME_HOLIDAY >= 0
		AND A.GUBUN_CODE = '2'
		AND A.WORKING_GUBUN = 'N'
		
		UNION ALL 
		
		SELECT 
		    F_GETCODENAME('YP_SUBC_GUBUN', A.GUBUN_CODE) AS GUBUN_NAME,
			A.BASE_YYYY,
			A.CONTRACT_CODE || '-04' AS CONTRACT_CODE,
			A.VENDOR_CODE,
			A.CONTRACT_NAME || '-토요수당',
			A.DEPT_CODE,
			A.DEPT_NAME, -- 팀별
			F_YP_GETMSTNM(A.UNIT_CODE, NULL) AS UNIT_NAME, -- 단위
			0 AS ADJUST_MAN_QTY, -- 조정안 인원
		    NVL(C.OVERTIME_SATURDAY,0) AS ADJUST_UNIT_PRICE, -- 단가
			0 AS ADJUST_QUANTITY, -- 물량
			0 AS ADJUST_SUBCONTRACTING_COST  --월도급비
		FROM TBL_WORKING_SUBC A
		LEFT OUTER JOIN TBL_WORKING_SUBC_CTN C
			ON A.BASE_YYYY = C.BASE_YYYY 
			AND A.CONTRACT_CODE  = C.CONTRACT_CODE 
			AND A.VENDOR_CODE  = C.VENDOR_CODE 
		WHERE A.BASE_YYYY = #{BASE_YYYY}  --입력파라미터
		AND A.VENDOR_CODE = #{VENDOR_CODE}  --입력파라미터
		AND C.OVERTIME_SATURDAY >= 0
		AND A.GUBUN_CODE = '2'
		AND A.WORKING_GUBUN = 'N'
	) E 
	LEFT OUTER JOIN (
		-- 해당년도의 전년도 도급비는 도급비 조정안의 팀원, 단가, 물량, 월도급비을 참조
	     SELECT 
		    F_GETCODENAME('YP_SUBC_GUBUN', A.GUBUN_CODE) AS GUBUN_NAME,
			#{BASE_YYYY} AS BASE_YYYY,  -- 조인을 걸기위해 입력파라미터의 연도를 강제로 준다
			A.CONTRACT_CODE ,
			A.VENDOR_CODE,
			A.CONTRACT_NAME,
			A.DEPT_CODE,
			A.DEPT_NAME, -- 팀별
			F_YP_GETMSTNM(A.UNIT_CODE, NULL) AS UNIT_NAME, -- 단위
			NVL(C.ADJUST_MAN_QTY,0) AS  P_ADJUST_MAN_QTY, -- 조정안 인원
		    NVL(C.ADJUST_UNIT_PRICE,0) AS P_ADJUST_UNIT_PRICE, -- 단가
			NVL(C.ADJUST_QUANTITY,0) AS P_ADJUST_QUANTITY, -- 물량
			NVL(C.ADJUST_SUBCONTRACTING_COST,0) AS P_ADJUST_SUBCONTRACTING_COST  --월도급비
		FROM TBL_WORKING_SUBC A
		LEFT OUTER JOIN
			(
			      SELECT
			    	#{BASE_YYYY} AS BASE_YYYY,   -- 조인을 걸기위해 입력파라미터의 연도를 강제로 준다
					A.CONTRACT_CODE ,
					A.VENDOR_CODE,
					A.ADJUST_MAN_QTY,
					A.ADJUST_UNIT_PRICE,
					A.ADJUST_QUANTITY,
					A.ADJUST_SUBCONTRACTING_COST
			    FROM TBL_WORKING_SUBC_COST_ADJUST A
			    WHERE A.BASE_YYYY = #{BEFORE_BASE_YYYY}  -- 입력파라미터 년도 -1 처리
			    AND A.VENDOR_CODE = #{VENDOR_CODE} --입력파라미터
			) C
		ON A.BASE_YYYY = C.BASE_YYYY
		AND A.CONTRACT_CODE = C.CONTRACT_CODE
		AND A.VENDOR_CODE = C.VENDOR_CODE
		WHERE A.BASE_YYYY = #{BEFORE_BASE_YYYY}  -- 입력파라미터 년도 -1 처리
		AND A.VENDOR_CODE = #{VENDOR_CODE}  --입력파라미터
	) F
		ON E.BASE_YYYY = F.BASE_YYYY
		AND E.CONTRACT_CODE = F.CONTRACT_CODE
		AND E.VENDOR_CODE = E.VENDOR_CODE
	) B
ON (	A.BASE_YYYY = B.BASE_YYYY
	AND A.VENDOR_CODE = B.VENDOR_CODE
	AND A.CONTRACT_CODE = B.CONTRACT_CODE
)
WHEN NOT MATCHED THEN
INSERT (
	BASE_YYYY,
	CONTRACT_CODE,
	VENDOR_CODE,
	CURRENT_MAN_QTY,
	CURRENT_UNIT_PRICE,
	CURRENT_QUANTITY,
	CURRENT_SUBCONTRACTING_COST,
	ADJUST_MAN_QTY,
	ADJUST_UNIT_PRICE,
	ADJUST_QUANTITY,
	ADJUST_SUBCONTRACTING_COST,
	REG_EMP,
	UPD_EMP,
	REG_DATE,
	UPD_DATE
) VALUES (
	B.BASE_YYYY,
	B.CONTRACT_CODE,
	B.VENDOR_CODE,
	B.CURRENT_MAN_QTY,
	B.CURRENT_UNIT_PRICE,
	B.CURRENT_QUANTITY,
	B.CURRENT_SUBCONTRACTING_COST,
	B.ADJUST_MAN_QTY,
	B.ADJUST_UNIT_PRICE,
	B.ADJUST_QUANTITY,
	B.ADJUST_SUBCONTRACTING_COST,
	B.REG_EMP,
	B.UPD_EMP,
	B.REG_DATE,
	B.UPD_DATE
)
WHEN MATCHED THEN
UPDATE SET 
	CURRENT_MAN_QTY = B.CURRENT_MAN_QTY,
	CURRENT_UNIT_PRICE = B.CURRENT_UNIT_PRICE,
	CURRENT_QUANTITY = B.CURRENT_QUANTITY,
	CURRENT_SUBCONTRACTING_COST = B.CURRENT_SUBCONTRACTING_COST,
	ADJUST_MAN_QTY = B.ADJUST_MAN_QTY,
	ADJUST_UNIT_PRICE = B.ADJUST_UNIT_PRICE,
	ADJUST_QUANTITY = B.ADJUST_QUANTITY,
	ADJUST_SUBCONTRACTING_COST = B.ADJUST_SUBCONTRACTING_COST,
	UPD_EMP = B.UPD_EMP,
	UPD_DATE = B.UPD_DATE
</update>

<select id="select_zwc_rpt_intervention_list" resultType="java.util.LinkedHashMap">
/* oracle.yp_zwc_rpt.select_zwc_rpt_intervention_list */
SELECT
	BASE_YYYY,
    VENDOR_CODE,
    VENDOR_NAME,
    WORKING_GUBUN,
    GUBUN_CODE,
    GUBUN_NAME,
    CONTRACT_NAME,
    CONTRACT_CODE,
    CONTRACT_TYPE,
    DEPT_NAME, -- 팀별
    NVL(UNIT_NAME,' ') AS UNIT_NAME, -- 단위
    CURRENT_MAN_QTY,
    CURRENT_UNIT_PRICE,
    CURRENT_QUANTITY,
    CURRENT_SUBCONTRACTING_COST,
    ADJUST_MAN_QTY,
    ADJUST_UNIT_PRICE,
    ADJUST_QUANTITY,
    ADJUST_SUBCONTRACTING_COST,
    NVL(VARIATION_RATE,0) AS VARIATION_RATE,
    NVL(NOTE,' ') AS NOTE
FROM(
    SELECT
        B.WORKING_GUBUN,
        B.GUBUN_CODE,
        F_GETCODENAME('YP_SUBC_GUBUN', B.GUBUN_CODE) AS GUBUN_NAME,
        A.BASE_YYYY,
        A.CONTRACT_CODE,
        B.CONTRACT_NAME ||
        CASE SUBSTR(A.CONTRACT_CODE, -3)
        	WHEN '-01' THEN '-야간수당'
        	WHEN '-02' THEN '-연장수당'
        	WHEN '-03' THEN '-휴일수당'
        	WHEN '-04' THEN '-토요수당'
        END
        AS CONTRACT_NAME,
        CASE SUBSTR(A.CONTRACT_CODE, -3)
        	WHEN '-01' THEN 1
        	WHEN '-02' THEN 2
        	WHEN '-03' THEN 3
        	WHEN '-04' THEN 4
        	ELSE 0
        END AS CONTRACT_TYPE,
        A.VENDOR_CODE,
        C.CODE_NAME AS VENDOR_NAME,
        B.DEPT_NAME, -- 팀별
        F_YP_GETMSTNM(B.UNIT_CODE, NULL) AS UNIT_NAME, -- 단위
        A.CURRENT_MAN_QTY,
        A.CURRENT_UNIT_PRICE,
        A.CURRENT_QUANTITY,
        A.CURRENT_SUBCONTRACTING_COST,
        A.ADJUST_MAN_QTY,
        A.ADJUST_UNIT_PRICE,
        A.ADJUST_QUANTITY,
        A.ADJUST_SUBCONTRACTING_COST,
        A.VARIATION_RATE,
        A.NOTE,
        A.BASE_CONTRACT_CODE
    FROM(
        SELECT 
            BASE_YYYY,
            CONTRACT_CODE,
            VENDOR_CODE,
            CURRENT_MAN_QTY,
            CURRENT_UNIT_PRICE,
            CURRENT_QUANTITY,
            CURRENT_SUBCONTRACTING_COST,
            ADJUST_MAN_QTY,
            ADJUST_UNIT_PRICE,
            ADJUST_QUANTITY,
            ADJUST_SUBCONTRACTING_COST,
            VARIATION_RATE,
            NOTE,
            CASE WHEN instr(CONTRACT_CODE,'-') > 0 THEN substr(CONTRACT_CODE,1,(instr(CONTRACT_CODE,'-')-1)) ELSE CONTRACT_CODE END AS BASE_CONTRACT_CODE 
        FROM TBL_WORKING_SUBC_COST_ADJUST 
    ) A
    LEFT OUTER JOIN TBL_WORKING_SUBC B
	    ON A.BASE_YYYY = B.BASE_YYYY 
	    AND A.BASE_CONTRACT_CODE  = B.CONTRACT_CODE 
	    AND A.VENDOR_CODE  = B.VENDOR_CODE 
    LEFT OUTER JOIN TBL_WORKING_MASTER C
    	ON A.VENDOR_CODE = C.CODE
    WHERE 1=1
    <if test='BASE_YYYY != null'>
	AND A.BASE_YYYY =  #{BASE_YYYY}
	</if>
	<if test='VENDOR_CODE != null'>
	AND A.VENDOR_CODE =  #{VENDOR_CODE}
	</if>
    ORDER BY GUBUN_NAME, CONTRACT_CODE, DEPT_NAME
)
</select>

<select id="select_zwc_rpt_gubun_list" resultType="java.util.LinkedHashMap">
/* oracle.yp_zwc_rpt.select_zwc_rpt_gubun_list */
SELECT
<!-- 	C.BASE_CONTRACT_CODE, -->
    C.GUBUN_NAME,
    COUNT(*) AS cnt
FROM(
	SELECT
	    GUBUN_NAME,
	    CONTRACT_NAME,
	    BASE_CONTRACT_CODE,
	    DEPT_NAME, -- 팀별
	    NVL(UNIT_NAME,' ') AS UNIT_NAME, -- 단위
	    CURRENT_MAN_QTY,
	    CURRENT_UNIT_PRICE,
	    CURRENT_QUANTITY,
	    CURRENT_SUBCONTRACTING_COST,
	    ADJUST_MAN_QTY,
	    ADJUST_UNIT_PRICE,
	    ADJUST_QUANTITY,
	    ADJUST_SUBCONTRACTING_COST,
	    NVL(VARIATION_RATE,0) AS VARIATION_RATE,
	    NVL(NOTE,' ') AS NOTE
	FROM(
	    SELECT
	        F_GETCODENAME('YP_SUBC_GUBUN', B.GUBUN_CODE) AS GUBUN_NAME,
	        A.BASE_YYYY,
	        A.CONTRACT_CODE,
	        B.CONTRACT_NAME ||
	        CASE SUBSTR(A.CONTRACT_CODE, -3)
	        	WHEN '-01' THEN '-야간수당'
	        	WHEN '-02' THEN '-연장수당'
	        	WHEN '-03' THEN '-휴일수당'
	        	WHEN '-04' THEN '-토요수당'
	        END
	        AS CONTRACT_NAME,
	        A.VENDOR_CODE,
	        B.DEPT_NAME, -- 팀별
	        F_YP_GETMSTNM(B.UNIT_CODE, NULL) AS UNIT_NAME, -- 단위
	        A.CURRENT_MAN_QTY,
	        A.CURRENT_UNIT_PRICE,
	        A.CURRENT_QUANTITY,
	        A.CURRENT_SUBCONTRACTING_COST,
	        A.ADJUST_MAN_QTY,
	        A.ADJUST_UNIT_PRICE,
	        A.ADJUST_QUANTITY,
	        A.ADJUST_SUBCONTRACTING_COST,
	        A.VARIATION_RATE,
	        A.NOTE,
	        A.BASE_CONTRACT_CODE
	    FROM(
	        SELECT 
	            BASE_YYYY,
	            CONTRACT_CODE,
	            VENDOR_CODE,
	            CURRENT_MAN_QTY,
	            CURRENT_UNIT_PRICE,
	            CURRENT_QUANTITY,
	            CURRENT_SUBCONTRACTING_COST,
	            ADJUST_MAN_QTY,
	            ADJUST_UNIT_PRICE,
	            ADJUST_QUANTITY,
	            ADJUST_SUBCONTRACTING_COST,
	            VARIATION_RATE,
	            NOTE,
	            CASE WHEN instr(CONTRACT_CODE,'-') > 0 THEN substr(CONTRACT_CODE,1,(instr(CONTRACT_CODE,'-')-1)) ELSE CONTRACT_CODE END AS BASE_CONTRACT_CODE 
	        FROM TBL_WORKING_SUBC_COST_ADJUST 
	    ) A
	    LEFT OUTER JOIN TBL_WORKING_SUBC B
	    ON A.BASE_YYYY = B.BASE_YYYY 
	    AND A.BASE_CONTRACT_CODE  = B.CONTRACT_CODE 
	    AND A.VENDOR_CODE  = B.VENDOR_CODE 
	    WHERE 1=1
	    <if test='BASE_YYYY != null'>
		AND A.BASE_YYYY =  #{BASE_YYYY}
		</if>
		<if test='VENDOR_CODE != null'>
		AND A.VENDOR_CODE =  #{VENDOR_CODE}
		</if>
	    ORDER BY BASE_YYYY, TO_NUMBER(REGEXP_REPLACE(VENDOR_CODE, '[^0-9]')), CONTRACT_CODE
	)
)C
GROUP BY C.GUBUN_NAME
ORDER BY C.GUBUN_NAME
</select>

<update id="zwc_rpt_subc_cost_adjust_save">
/* oracle.yp_zwc_rpt.zwc_rpt_subc_cost_adjust_save */
UPDATE TBL_WORKING_SUBC_COST_ADJUST SET 
	NOTE = #{NOTE},
	UPD_EMP = #{s_emp_code},
	UPD_DATE = sysdate
WHERE 1=1
AND BASE_YYYY = #{BASE_YYYY}
AND VENDOR_CODE = #{VENDOR_CODE}
AND CONTRACT_CODE = #{CONTRACT_CODE}
</update>

<update id="zwc_rpt_subc_cost_adjust_save2">
/* oracle.yp_zwc_rpt.zwc_rpt_subc_cost_adjust_save2 */
UPDATE TBL_WORKING_SUBC_COST_ADJUST SET 
	ADJUST_QUANTITY = #{ADJUST_QUANTITY},
	ADJUST_SUBCONTRACTING_COST = #{ADJUST_SUBCONTRACTING_COST},
	UPD_EMP = #{s_emp_code},
	UPD_DATE = sysdate
WHERE 1=1
AND BASE_YYYY = #{BASE_YYYY}
AND VENDOR_CODE = #{VENDOR_CODE}
AND CONTRACT_CODE = #{CONTRACT_CODE}
</update>

<delete id="delete_zwc_rpt_subc_cost_basis">
/* oracle.yp_zwc_rpt.delete_zwc_rpt_subc_cost_basis */
DELETE TBL_WORKING_SUBC_COST_BASIS
WHERE 1=1
AND BASE_YYYY = #{BASE_YYYY}
AND VENDOR_CODE = #{VENDOR_CODE}
</delete>

<update id="merge_zwc_rpt_subc_cost_basis">
/* oracle.yp_zwc_rpt.merge_zwc_rpt_subc_cost_basis */
MERGE INTO TBL_WORKING_SUBC_COST_BASIS A
USING (
	-- 근무형태별 단가, 계약의 인원 수를 구하여 금액 산출
	SELECT 
	    D.BASE_YYYY,
	    D.CONTRACT_CODE,
	    D.VENDOR_CODE,
	    GUBUN_CODE,
	    D.GUBUN_NAME,
		D.UNIT_PRICE,
		D.MAN_QTY,
		D.AMOUNT,
		#{s_emp_code} AS REG_EMP,
		#{s_emp_code} AS UPD_EMP,
		sysdate AS REP_DATE,
		sysdate AS UPD_DATE
	FROM 
	(
		SELECT 	
	        A.BASE_YYYY,
	        A.CONTRACT_CODE,
	        A.VENDOR_CODE,
	        C.WORKTYPE_CODE AS GUBUN_CODE,
			F_YP_GETMSTNM(C.WORKTYPE_CODE,'-') AS GUBUN_NAME,
			NVL(B.FINAL_UNIT_PRICE,0) AS UNIT_PRICE,
			NVL(C.MAN_QTY,0) AS MAN_QTY,
			NVL(B.FINAL_UNIT_PRICE,0) * NVL(C.MAN_QTY,0) AS AMOUNT
		FROM TBL_WORKING_SUBC A
<!-- 		LEFT OUTER JOIN TBL_WORKING_SUBC_CTN B  -->
<!-- 			ON A.BASE_YYYY = B.BASE_YYYY  -->
<!-- 			AND A.CONTRACT_CODE = B.CONTRACT_CODE  -->
<!-- 			AND A.VENDOR_CODE = B.VENDOR_CODE  -->
		LEFT OUTER JOIN TBL_WORKING_SUBC_CTN_DT C
			ON A.BASE_YYYY = C.BASE_YYYY 
			AND A.CONTRACT_CODE = C.CONTRACT_CODE 
			AND A.VENDOR_CODE = C.VENDOR_CODE
		LEFT OUTER JOIN TBL_WORKING_ENT_UNIT_PRICE B
			ON C.BASE_YYYY = B.BASE_YYYY
			AND C.VENDOR_CODE = B.VENDOR_CODE
			AND C.WORKTYPE_CODE = B.WORKTYPE_CODE
		WHERE A.BASE_YYYY = #{BASE_YYYY} -- 년도 조건
		AND A.VENDOR_CODE = #{VENDOR_CODE} -- 업체 조건
		--AND A.CONTRACT_NAME LIKE '%테스트 계약4%' -- 계약명 조건
		AND C.MAN_QTY > 0
		ORDER BY C.WORKTYPE_CODE 
	) D
	UNION ALL 
	-- 보호구의 단가(월금액), 계약의 인원 수를 구하여 금액 산출
	SELECT
	    C.BASE_YYYY,
	    C.CONTRACT_CODE,
	    C.VENDOR_CODE,
	    'Z90' AS GUBUN_CODE,
		'보호구' AS GUBUN_NAME,
		D.MONTH_AMOUNT AS UNIT_PRICE,
		C.MAN_QTY,
		D.MONTH_AMOUNT * C.MAN_QTY AS AMOUNT,
		#{s_emp_code} AS REG_EMP,
		#{s_emp_code} AS UPD_EMP,
		sysdate AS REP_DATE,
		sysdate AS UPD_DATE
	FROM 
	(
		SELECT 
			A.BASE_YYYY, 
			A.CONTRACT_CODE, 
			A.VENDOR_CODE,
			SUM(NVL(B.MAN_QTY,0)) AS MAN_QTY
		FROM TBL_WORKING_SUBC A
		LEFT OUTER JOIN TBL_WORKING_SUBC_CTN_DT B
		ON A.BASE_YYYY = B.BASE_YYYY 
		AND A.CONTRACT_CODE = B.CONTRACT_CODE 
		AND A.VENDOR_CODE = B.VENDOR_CODE
		WHERE A.BASE_YYYY = #{BASE_YYYY}-- 년도 조건
		AND A.VENDOR_CODE = #{VENDOR_CODE} -- 업체 조건
		--AND A.CONTRACT_NAME LIKE '%테스트 계약4%' -- 계약명 조건
		AND B.MAN_QTY > 0
		GROUP BY A.BASE_YYYY, A.CONTRACT_CODE, A.VENDOR_CODE
	) C LEFT OUTER JOIN 
	(
		SELECT
			A.BASE_YYYY, 
			A.CONTRACT_CODE, 
			A.VENDOR_CODE,
			NVL(A.MONTH_AMOUNT,0) AS MONTH_AMOUNT
		FROM TBL_WORKING_PTC A
		WHERE A.BASE_YYYY = #{BASE_YYYY}-- 년도 조건
		AND A.VENDOR_CODE = #{VENDOR_CODE}-- 업체 조건
		
	) D
	ON C.BASE_YYYY = D.BASE_YYYY
	AND C.CONTRACT_CODE = D.CONTRACT_CODE
	AND C.VENDOR_CODE = D.VENDOR_CODE
	UNION ALL 
	-- 유해인자의 단가(월금액), 계약의 인원 수를 구하여 금액 산출
	SELECT
	    C.BASE_YYYY,
	    C.CONTRACT_CODE,
	    C.VENDOR_CODE,
	    'Z91' AS GUBUN_CODE,
		'건강검진비' AS GUBUN_NAME,
		D.MONTH_AMOUNT AS UNIT_PRICE,
		C.MAN_QTY,
		D.MONTH_AMOUNT * C.MAN_QTY AS AMOUNT,
		#{s_emp_code} AS REG_EMP,
		#{s_emp_code} AS UPD_EMP,
		sysdate AS REP_DATE,
		sysdate AS UPD_DATE
	FROM 
	(
		SELECT 
			A.BASE_YYYY, 
			A.CONTRACT_CODE, 
			A.VENDOR_CODE,
			SUM(NVL(B.MAN_QTY,0)) AS MAN_QTY
		FROM TBL_WORKING_SUBC A
		LEFT OUTER JOIN TBL_WORKING_SUBC_CTN_DT B
		ON A.BASE_YYYY = B.BASE_YYYY 
		AND A.CONTRACT_CODE = B.CONTRACT_CODE 
		AND A.VENDOR_CODE = B.VENDOR_CODE
		WHERE A.BASE_YYYY = #{BASE_YYYY}   -- 년도 조건
		AND A.VENDOR_CODE = #{VENDOR_CODE}  -- 업체 조건
		--AND A.CONTRACT_NAME LIKE '%테스트 계약4%'  -- 계약명 조건
		AND B.MAN_QTY > 0
		GROUP BY A.BASE_YYYY, A.CONTRACT_CODE, A.VENDOR_CODE
	) C LEFT OUTER JOIN 
	(
		SELECT
			A.BASE_YYYY, 
			A.CONTRACT_CODE, 
			A.VENDOR_CODE,
			NVL(A.MONTH_AMOUNT,0) AS MONTH_AMOUNT
		FROM TBL_WORKING_NFT A
		WHERE A.BASE_YYYY = #{BASE_YYYY} -- 년도 조건
		AND A.VENDOR_CODE = #{VENDOR_CODE} -- 업체 조건
		
	) D
	ON C.BASE_YYYY = D.BASE_YYYY
	AND C.CONTRACT_CODE = D.CONTRACT_CODE
	AND C.VENDOR_CODE = D.VENDOR_CODE
	UNION ALL 
	-- 기타수당 산출
	SELECT
	    C.BASE_YYYY,
	    C.CONTRACT_CODE,
	    C.VENDOR_CODE,
	    'Z92' AS GUBUN_CODE,
	   '기타수당' AS GUBUN_NAME,
	   C.EXTRA_PAY AS UNIT_PRICE,
	   C.MAN_QTY,
	   C.EXTRA_PAY AS AMOUNT,
	   #{s_emp_code} AS REG_EMP,
	   #{s_emp_code} AS UPD_EMP,
	   sysdate AS REP_DATE,
	   sysdate AS UPD_DATE
	FROM 
	(
	   SELECT 
	      A.BASE_YYYY, 
	      A.CONTRACT_CODE, 
	      A.VENDOR_CODE,
	      SUM(B.EXTRA_PAY) AS EXTRA_PAY,
	      0 AS MAN_QTY
	   FROM TBL_WORKING_SUBC A
	   LEFT OUTER JOIN TBL_WORKING_SUBC_CTN B
	   ON A.BASE_YYYY = B.BASE_YYYY 
	   AND A.CONTRACT_CODE = B.CONTRACT_CODE 
	   AND A.VENDOR_CODE = B.VENDOR_CODE
	   WHERE A.BASE_YYYY = #{BASE_YYYY}   -- 년도 조건
	   AND A.VENDOR_CODE = #{VENDOR_CODE}  -- 업체 조건
	   AND B.EXTRA_PAY > 0
	   --AND A.CONTRACT_NAME LIKE '%테스트 계약4%'  -- 계약명 조건
	   GROUP BY A.BASE_YYYY, A.CONTRACT_CODE, A.VENDOR_CODE
	) C 
) B
ON (
		A.BASE_YYYY = B.BASE_YYYY
	AND A.VENDOR_CODE = B.VENDOR_CODE
	AND A.CONTRACT_CODE = B.CONTRACT_CODE
	AND A.GUBUN_NAME = B.GUBUN_NAME
)

WHEN NOT MATCHED THEN
INSERT (
	BASE_YYYY,
	CONTRACT_CODE,
	VENDOR_CODE,
	GUBUN_CODE,
	GUBUN_NAME,
	UNIT_PRICE,
	MAN_QTY,
	AMOUNT,
	REG_EMP,
	UPD_EMP,
	REP_DATE,
	UPD_DATE
) VALUES (
	B.BASE_YYYY,
	B.CONTRACT_CODE,
	B.VENDOR_CODE,
	B.GUBUN_CODE,
	B.GUBUN_NAME,
	B.UNIT_PRICE,
	B.MAN_QTY,
	B.AMOUNT,
	B.REG_EMP,
	B.UPD_EMP,
	B.REP_DATE,
	B.UPD_DATE
)
WHEN MATCHED THEN
UPDATE SET 
	GUBUN_CODE = B.GUBUN_CODE,
	UNIT_PRICE = B.UNIT_PRICE,
	MAN_QTY = B.MAN_QTY,
	AMOUNT = B.AMOUNT,
	UPD_EMP = B.UPD_EMP,
	UPD_DATE = B.UPD_DATE
</update>

<select id="zwc_rpt_select_contract_name" resultType="HashMap">
/* oracle.yp_zwc_rpt.zwc_rpt_select_contract_name */
SELECT 
    CONTRACT_NAME
FROM TBL_WORKING_SUBC
WHERE 1=1
AND BASE_YYYY = #{BASE_YYYY}
AND VENDOR_CODE = #{VENDOR_CODE}
ORDER BY CONTRACT_CODE
</select>

<select id="select_reason_list" resultType="java.util.LinkedHashMap">
/* oracle.yp_zwc_rpt.select_reason_list */
SELECT
    BASE_YYYY,
    CONTRACT_CODE,
    VENDOR_CODE,
    GUBUN_NAME,
    TO_CHAR(UNIT_PRICE, 'FM9,999,999,999,999,999') AS UNIT_PRICE,
    MAN_QTY,
    TO_CHAR(AMOUNT, 'FM9,999,999,999,999,999') AS AMOUNT,
    NVL(NOTE,' ') AS NOTE
FROM(
    SELECT 
        A.BASE_YYYY,
        A.CONTRACT_CODE,
        B.CONTRACT_NAME,
        A.VENDOR_CODE,
        A.GUBUN_CODE,
        A.GUBUN_NAME,
        A.UNIT_PRICE,
        A.MAN_QTY,
        A.AMOUNT,
        A.NOTE
    FROM TBL_WORKING_SUBC_COST_BASIS A
    LEFT OUTER JOIN TBL_WORKING_SUBC B 
        ON A.BASE_YYYY = B.BASE_YYYY 
        AND A.CONTRACT_CODE = B.CONTRACT_CODE 
        AND A.VENDOR_CODE = B.VENDOR_CODE )
WHERE 1=1
AND BASE_YYYY = #{BASE_YYYY}
AND VENDOR_CODE = #{VENDOR_CODE}
AND CONTRACT_NAME LIKE '%' ||  #{CONTRACT_NAME} || '%'
ORDER BY TO_NUMBER(REGEXP_REPLACE(GUBUN_CODE, '[^0-9]'))
</select>

<update id="zwc_rpt_reason_save">
/* oracle.yp_zwc_rpt.zwc_rpt_reason_save */
UPDATE TBL_WORKING_SUBC_COST_BASIS SET 
	NOTE = #{NOTE},
	UPD_EMP = #{s_emp_code},
	UPD_DATE = sysdate
WHERE 1=1
AND BASE_YYYY = #{BASE_YYYY}
AND VENDOR_CODE = #{VENDOR_CODE}
AND CONTRACT_CODE = #{CONTRACT_CODE}
AND GUBUN_NAME = #{GUBUN_NAME}
</update>

<select id="select_pop_reason_list" resultType="java.util.LinkedHashMap">
/* oracle.yp_zwc_rpt.select_pop_reason_list */
SELECT
    BASE_YYYY,
    CONTRACT_CODE,
    VENDOR_CODE,
    GUBUN_NAME,
    UNIT_PRICE,
    MAN_QTY,
    AMOUNT,
    NVL(NOTE,' ') AS NOTE
FROM(
    SELECT 
        A.BASE_YYYY,
        A.CONTRACT_CODE,
        B.CONTRACT_NAME,
        A.VENDOR_CODE,
        A.GUBUN_CODE,
        A.GUBUN_NAME,
        A.UNIT_PRICE,
        A.MAN_QTY,
        A.AMOUNT,
        A.NOTE
    FROM TBL_WORKING_SUBC_COST_BASIS A
    LEFT OUTER JOIN TBL_WORKING_SUBC B 
        ON A.BASE_YYYY = B.BASE_YYYY 
        AND A.CONTRACT_CODE = B.CONTRACT_CODE 
        AND A.VENDOR_CODE = B.VENDOR_CODE )
WHERE 1=1
AND BASE_YYYY = #{BASE_YYYY}
AND VENDOR_CODE = #{VENDOR_CODE}
AND CONTRACT_CODE = #{CONTRACT_CODE}
ORDER BY TO_NUMBER(REGEXP_REPLACE(GUBUN_CODE, '[^0-9]'))
</select>

<delete id="delete_tbl_working_subc_pst_adj">
/* oracle.yp_zwc_rpt.delete_tbl_working_subc_pst_adj */
DELETE TBL_WORKING_SUBC_PST_ADJ
WHERE 1=1
AND BASE_YYYY = #{BASE_YYYY}
<if test="VENDOR_CODE != null">
AND VENDOR_CODE = #{VENDOR_CODE}
</if>
</delete>

<insert id="insert_tbl_working_subc_pst_adj">
/* oracle.yp_zwc_rpt.insert_tbl_working_subc_pst_adj */
INSERT INTO TBL_WORKING_SUBC_PST_ADJ (
	BASE_YYYY,
	VENDOR_CODE,
	CURRENT_MAN_QTY,
	CURRENT_SUBCONTRACTING_COST,
	ADJUST_MAN_QTY,
	ADJUST_SUBCONTRACTING_COST,
	VARIATION_MAN_QTY,
	VARIATION_SUBCONTRACTING_COST,
	VARIATION_RATE,
	REG_EMP,
	REG_DATE
)
SELECT
	BASE_YYYY, 
	VENDOR_CODE, 
	SUM(CURRENT_MAN_QTY) AS CURRENT_MAN_QTY, 
	SUM(CURRENT_SUBCONTRACTING_COST) AS CURRENT_SUBCONTRACTING_COST, 
	SUM(ADJUST_MAN_QTY) AS ADJUST_MAN_QTY, 
	SUM(ADJUST_SUBCONTRACTING_COST) AS ADJUST_SUBCONTRACTING_COST, 
	SUM(ADJUST_MAN_QTY) - SUM(CURRENT_MAN_QTY) AS VARIATION_MAN_QTY, 
	SUM(ADJUST_SUBCONTRACTING_COST) - SUM(CURRENT_SUBCONTRACTING_COST) AS VARIATION_SUBCONTRACTING_COST,  
	ROUND(
		CASE
			WHEN SUM(CURRENT_SUBCONTRACTING_COST) = 0 THEN 0
			ELSE ((SUM(ADJUST_SUBCONTRACTING_COST) - SUM(CURRENT_SUBCONTRACTING_COST)) / SUM(CURRENT_SUBCONTRACTING_COST))
		END * 100
	, 0) AS VARIATION_RATE,
	#{s_emp_code},
	SYSDATE
FROM(
	SELECT
		B.WORKING_GUBUN, 
		B.GUBUN_CODE, 
		F_GETCODENAME('YP_SUBC_GUBUN', B.GUBUN_CODE) AS GUBUN_NAME, 
		A.BASE_YYYY, 
		A.CONTRACT_CODE, 
		B.CONTRACT_NAME ||
		CASE SUBSTR(A.CONTRACT_CODE, -3)
			WHEN '-01' THEN '-야간수당'
			WHEN '-02' THEN '-연장수당'
			WHEN '-03' THEN '-휴일수당'
			WHEN '-04' THEN '-토요수당'
		END
		AS CONTRACT_NAME, 
		CASE SUBSTR(A.CONTRACT_CODE, -3)
			WHEN '-01' THEN 1
			WHEN '-02' THEN 2
			WHEN '-03' THEN 3
			WHEN '-04' THEN 4
			ELSE 0
		END AS CONTRACT_TYPE, 
		A.VENDOR_CODE, 
		C.CODE_NAME AS VENDOR_NAME, 
		B.DEPT_NAME, -- 팀별
		F_YP_GETMSTNM(B.UNIT_CODE, NULL) AS UNIT_NAME, -- 단위
		A.CURRENT_MAN_QTY, 
		A.CURRENT_UNIT_PRICE, 
		A.CURRENT_QUANTITY, 
		A.CURRENT_SUBCONTRACTING_COST, 
		A.ADJUST_MAN_QTY, 
		A.ADJUST_UNIT_PRICE, 
		A.ADJUST_QUANTITY, 
		A.ADJUST_SUBCONTRACTING_COST, 
		A.VARIATION_RATE, 
		A.NOTE, 
		A.BASE_CONTRACT_CODE
	FROM(
		SELECT 
			BASE_YYYY, 
			CONTRACT_CODE, 
			VENDOR_CODE, 
			CURRENT_MAN_QTY, 
			CURRENT_UNIT_PRICE, 
			CURRENT_QUANTITY, 
			CURRENT_SUBCONTRACTING_COST, 
			ADJUST_MAN_QTY, 
			ADJUST_UNIT_PRICE, 
			ADJUST_QUANTITY, 
			ADJUST_SUBCONTRACTING_COST, 
			VARIATION_RATE, 
			NOTE, 
			CASE WHEN INSTR(CONTRACT_CODE, '-') > 0 THEN SUBSTR(CONTRACT_CODE, 1, (INSTR(CONTRACT_CODE, '-')-1)) ELSE CONTRACT_CODE END AS BASE_CONTRACT_CODE 
		FROM TBL_WORKING_SUBC_COST_ADJUST 
	) A
	LEFT OUTER JOIN TBL_WORKING_SUBC B
		ON A.BASE_YYYY = B.BASE_YYYY 
		AND A.BASE_CONTRACT_CODE = B.CONTRACT_CODE 
		AND A.VENDOR_CODE = B.VENDOR_CODE 
	LEFT OUTER JOIN TBL_WORKING_MASTER C
		ON A.VENDOR_CODE = C.CODE
	WHERE 1=1
	AND A.BASE_YYYY = #{BASE_YYYY}
	<if test="VENDOR_CODE != null">
	AND A.VENDOR_CODE = #{VENDOR_CODE}
	</if>
)
GROUP BY BASE_YYYY, VENDOR_CODE
</insert>

<select id="select_tbl_working_subc_pst_adj" resultType="java.util.LinkedHashMap">
/* oracle.yp_zwc_rpt.select_tbl_working_subc_pst_adj */
SELECT
	A.BASE_YYYY,
	A.VENDOR_CODE,
	(SELECT S.CODE_NAME FROM TBL_WORKING_MASTER S WHERE SUBSTR(S.CODE, 1, 1) = 'V' AND S.CODE = A.VENDOR_CODE) AS VENDOR_NAME,
	A.CURRENT_MAN_QTY,
	A.CURRENT_SUBCONTRACTING_COST,
	A.ADJUST_MAN_QTY,
	A.ADJUST_SUBCONTRACTING_COST,
	A.VARIATION_MAN_QTY,
	A.VARIATION_SUBCONTRACTING_COST,
	A.VARIATION_RATE,
	A.NOTE
FROM TBL_WORKING_SUBC_PST_ADJ A
WHERE 1=1
AND A.BASE_YYYY = #{BASE_YYYY}
<if test="VENDOR_CODE != null">
AND A.VENDOR_CODE = #{VENDOR_CODE}
</if>
</select>

<update id="update_tbl_working_subc_pst_adj">
/* oracle.yp_zwc_rpt.update_tbl_working_subc_pst_adj */
UPDATE TBL_WORKING_SUBC_PST_ADJ A SET
	A.NOTE = #{NOTE},
	A.UPD_EMP = #{s_emp_code},
	A.UPD_DATE = SYSDATE
WHERE 1=1
AND A.BASE_YYYY = #{BASE_YYYY}
AND A.VENDOR_CODE = #{VENDOR_CODE}
</update>
</mapper>