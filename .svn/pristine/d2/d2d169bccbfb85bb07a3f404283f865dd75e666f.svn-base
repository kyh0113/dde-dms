<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="oracle.yp_zwc_eai">
<!-- 전자결재 도급월보 테스트 데이터 조회 -->
<select id="working_monthly_report_test" resultType="java.util.LinkedHashMap">
/* oracle.yp_zwc_eai.working_monthly_report_test */
SELECT X.*
FROM (
	SELECT
		'English Vnedor Name' AS VENDOR_NAME,
		#{BASE_YYYY} || ' ' || #{DEPT_CODE} || ' ' || '14001' || ' ' || 'Contract(English)' AS CONTRACT_NAME,
		NVL(TO_CHAR(31), '0') AS OPERATE_DAY,
		NVL(TO_CHAR(124), '0') AS MANHOUR,
		NVL(TO_CHAR(4), '0') AS QUANTITY,
		NVL(TO_CHAR(3190900), '0') AS UNIT_PRICE,
		NVL(TO_CHAR(12763600), '0') AS SUBCONTRACTING_COST,
		NVL(TO_CHAR(3185040), '0') AS SATURDAY_AMOUNT,
		NVL(TO_CHAR(3185040), '0') AS HOLIDAY_AMOUNT,
		NVL(TO_CHAR(432750), '0') AS EXTENSION_AMOUNT,
		NVL(TO_CHAR(143960), '0') AS NIGHT_AMOUNT,
		NVL(TO_CHAR(NULL), '0') AS REWARD_AMOUNT,
		NVL(TO_CHAR(NULL), '0') AS ADD_AMOUNT,
		NVL(TO_CHAR(NULL), '0') AS PENALTY_AMOUNT,
		NVL(TO_CHAR(17812350), '0') AS PAY_AMOUNT,
		'NONE KOREAN TEST' AS MEMO
	FROM DUAL A
	WHERE 1=1
	
	UNION ALL
	
	SELECT
		'한글 거래처명' AS VENDOR_NAME,
		#{BASE_YYYY} || ' ' || #{DEPT_CODE} || ' ' || '14001' || ' ' || '계약명(한글)' AS CONTRACT_NAME,
		NVL(TO_CHAR(31), '0') AS OPERATE_DAY,
		NVL(TO_CHAR(124), '0') AS MANHOUR,
		NVL(TO_CHAR(4), '0') AS QUANTITY,
		NVL(TO_CHAR(3190900), '0') AS UNIT_PRICE,
		NVL(TO_CHAR(12763600), '0') AS SUBCONTRACTING_COST,
		NVL(TO_CHAR(3185040), '0') AS SATURDAY_AMOUNT,
		NVL(TO_CHAR(3185040), '0') AS HOLIDAY_AMOUNT,
		NVL(TO_CHAR(432750), '0') AS EXTENSION_AMOUNT,
		NVL(TO_CHAR(143960), '0') AS NIGHT_AMOUNT,
		NVL(TO_CHAR(NULL), '0') AS REWARD_AMOUNT,
		NVL(TO_CHAR(NULL), '0') AS ADD_AMOUNT,
		NVL(TO_CHAR(NULL), '0') AS PENALTY_AMOUNT,
		NVL(TO_CHAR(17812350), '0') AS PAY_AMOUNT,
		'한글 테스트' AS MEMO
	FROM DUAL A
	WHERE 1=1
) X
WHERE 1=1
</select>

<!-- 전자결재 도급월보 조회 -->
<select id="working_monthly_report" resultType="java.util.LinkedHashMap">
/* oracle.yp_zwc_eai.working_monthly_report - 전자결재 도급월보 조회 */
SELECT
	(SELECT S.CODE_NAME FROM TBL_WORKING_MASTER S WHERE SUBSTR(S.CODE, 1, 1) = 'V' AND S.CODE = A.VENDOR_CODE) AS VENDOR_NAME,
	B.CONTRACT_NAME AS CONTRACT_NAME,
	NVL(TO_CHAR((
		SELECT COUNT(*) AS CNT
		FROM TBL_WORKING_DAILY_REPORT_DT C
		WHERE 1=1
		AND A.BASE_YYYY = C.BASE_YYYY
		AND A.VENDOR_CODE = C.VENDOR_CODE
		AND A.CONTRACT_CODE = C.CONTRACT_CODE
		AND SUBSTR(C.BASE_YYYYMMDD, 1, 6) = #{BASE_YYYY}
		AND NVL(C.MANHOUR, 0) + NVL(C.COLLECTION_MANHOUR, 0) > 0
	)), '0') AS OPERATE_DAY,
	NVL(TO_CHAR(A.MANHOUR), '0') AS MANHOUR,
	NVL(TO_CHAR(A.QUANTITY_CHANGED), NVL(TO_CHAR(A.QUANTITY), '0')) AS QUANTITY,
	NVL(TO_CHAR(A.UNIT_PRICE, 'FM9,999,999,999,999,999,999,999,999'), '0') AS UNIT_PRICE,
	NVL(TO_CHAR(A.SUBCONTRACTING_COST, 'FM9,999,999,999,999,999,999,999,999'), '0') AS SUBCONTRACTING_COST,
	NVL(TO_CHAR(A.SATURDAY_AMOUNT, 'FM9,999,999,999,999,999,999,999,999'), '0') AS SATURDAY_AMOUNT,
	NVL(TO_CHAR(A.HOLIDAY_AMOUNT, 'FM9,999,999,999,999,999,999,999,999'), '0') AS HOLIDAY_AMOUNT,
	NVL(TO_CHAR(A.EXTENSION_AMOUNT, 'FM9,999,999,999,999,999,999,999,999'), '0') AS EXTENSION_AMOUNT,
	NVL(TO_CHAR(A.NIGHT_AMOUNT, 'FM9,999,999,999,999,999,999,999,999'), '0') AS NIGHT_AMOUNT,
	NVL(TO_CHAR(A.REWARD_AMOUNT, 'FM9,999,999,999,999,999,999,999,999'), '0') AS REWARD_AMOUNT,
	NVL(TO_CHAR(A.ADDITIONAL_AMOUNT, 'FM9,999,999,999,999,999,999,999,999'), '0') AS ADD_AMOUNT,
	NVL(TO_CHAR(A.PENALTY_AMOUNT, 'FM9,999,999,999,999,999,999,999,999'), '0') AS PENALTY_AMOUNT,
	NVL(TO_CHAR(A.PAY_AMOUNT, 'FM9,999,999,999,999,999,999,999,999'), '0') AS PAY_AMOUNT,
	' ' AS MEMO
FROM TBL_WORKING_MONTHLY_REPORT A
INNER JOIN TBL_WORKING_SUBC B
	ON A.BASE_YYYY = B.BASE_YYYY
	AND A.VENDOR_CODE = B.VENDOR_CODE
	AND A.CONTRACT_CODE = B.CONTRACT_CODE
	AND B.DEPT_CODE = #{DEPT_CODE}
WHERE 1=1
AND A.CHECK_YYYYMM = #{BASE_YYYY}
ORDER BY A.CHECK_YYYYMM, A.BASE_YYYY, A.VENDOR_CODE, A.CONTRACT_CODE
</select>

<update id="working_monthly_report_status">
/* oracle.yp_zwc_eai.working_monthly_report_status - 전자결재 상태 적용 - 도급월보  */
MERGE INTO TBL_WORKING_MONTHLY_REPORT A
USING TBL_WORKING_SUBC B
ON (
		A.BASE_YYYY = B.BASE_YYYY
	AND A.VENDOR_CODE = B.VENDOR_CODE
	AND A.CONTRACT_CODE = B.CONTRACT_CODE
	AND A.CHECK_YYYYMM = #{BASE_YYYY}
	AND B.DEPT_CODE = #{DEPT_CODE}
)
WHEN MATCHED THEN
UPDATE SET 
	EA_DOC_NO = #{DOC_NO},
	EA_FORM_ID = #{FORM_ID},
	EA_GW_ID = #{GW_ID},
	STATUS = #{DOC_STATUS},
	EA_DATE = #{DATE}
</update>

<!-- 전자결재 도급비 조정(안) 조회 -->
<select id="working_subc_pst_adj" resultType="java.util.LinkedHashMap">
/* oracle.yp_zwc_eai.working_subc_pst_adj - 전자결재 도급비 조정(안) 조회 */
SELECT
	A.BASE_YYYY, A.VENDOR_CODE,
	(SELECT S.CODE_NAME FROM TBL_WORKING_MASTER S WHERE SUBSTR(S.CODE, 1, 1) = 'V' AND S.CODE = A.VENDOR_CODE) AS VENDOR_NAME,
	TO_CHAR(NVL(A.CURRENT_MAN_QTY, 0)) AS CURRENT_MAN_QTY,
	TO_CHAR(NVL(A.CURRENT_SUBCONTRACTING_COST, 0), 'FM9,999,999,999,999,999,999,999,999') AS CURRENT_SUBCONTRACTING_COST,
	TO_CHAR(NVL(A.ADJUST_MAN_QTY, 0)) AS ADJUST_MAN_QTY,
	TO_CHAR(NVL(A.ADJUST_SUBCONTRACTING_COST, 0), 'FM9,999,999,999,999,999,999,999,999') AS ADJUST_SUBCONTRACTING_COST,
	TO_CHAR(NVL(A.VARIATION_MAN_QTY, 0)) AS VARIATION_MAN_QTY,
	TO_CHAR(NVL(A.VARIATION_SUBCONTRACTING_COST, 0), 'FM9,999,999,999,999,999,999,999,999') AS VARIATION_SUBCONTRACTING_COST,
	TO_CHAR(NVL(A.VARIATION_RATE, 0)) AS VARIATION_RATE,
	NVL(A.NOTE, ' ') AS NOTE
FROM TBL_WORKING_SUBC_PST_ADJ A
WHERE 1=1
AND A.BASE_YYYY = #{BASE_YYYY}
</select>

<update id="working_subc_pst_adj_status">
/* oracle.yp_zwc_eai.working_subc_pst_adj_status - 전자결재 상태 적용 - 도급비 조정(안)  */
UPDATE TBL_WORKING_SUBC_PST_ADJ A SET 
	EA_DOC_NO = #{DOC_NO},
	EA_FORM_ID = #{FORM_ID},
	EA_GW_ID = #{GW_ID},
	STATUS = #{DOC_STATUS},
	EA_DATE = #{DATE}
WHERE 1=1
AND A.BASE_YYYY = #{BASE_YYYY}
</update>

<!-- 전자결재 도급비 조회 -->
<select id="working_subc_cost_count" resultType="java.util.LinkedHashMap">
/* oracle.yp_zwc_eai.working_subc_cost_count - 전자결재 도급비 조회 */
SELECT 
	B.CODE_NAME AS VENDOR_NAME,
	B.CODE AS VENDOR_CODE,
	B.REPRESENTATIVE AS REPRESENTATIVE,
	TO_CHAR(NVL(AMOUNT1, 0), 'FM9,999,999,999,999,999,999,999,999') AS AMOUNT1,
	TO_CHAR(NVL(AMOUNT2, 0), 'FM9,999,999,999,999,999,999,999,999') AS AMOUNT2,
	TO_CHAR(NVL(AMOUNT3, 0), 'FM9,999,999,999,999,999,999,999,999') AS AMOUNT3,
	TO_CHAR(NVL(SUB_TOTAL, 0), 'FM9,999,999,999,999,999,999,999,999') AS SUB_TOTAL,
	TO_CHAR(NVL(VAT, 0), 'FM9,999,999,999,999,999,999,999,999') AS VAT,
	TO_CHAR(NVL(TOTAL, 0), 'FM9,999,999,999,999,999,999,999,999') AS TOTAL,
	TO_CHAR(NVL(SAVE_MONEY_AMOUNT, 0), 'FM9,999,999,999,999,999,999,999,999') AS SAVE_MONEY_AMOUNT,
	TO_CHAR(NVL(PAY_AMOUNT, 0), 'FM9,999,999,999,999,999,999,999,999') AS PAY_AMOUNT,
	TO_CHAR(NVL(LAST_MONTH_SUBCONTRACTING_COST, 0), 'FM9,999,999,999,999,999,999,999,999') AS LAST_MONTH_SUBCONTRACTING_COST,
	TO_CHAR(NVL(VARIATION, 0), 'FM9,999,999,999,999,999,999,999,999') AS VARIATION,
	TO_CHAR(NVL(MAN_MONTH, 0)) AS MAN_MONTH
FROM TBL_WORKING_SUBC_COST_COUNT A
LEFT OUTER JOIN TBL_WORKING_MASTER B
	ON A.VENDOR_CODE = B.CODE
WHERE 1=1
AND CHECK_YYYYMM = #{CHECK_YYYYMM}
AND GUBUN_CODE = #{GUBUN_CODE}
</select>

<update id="working_subc_cost_count_status">
/* oracle.yp_zwc_eai.working_subc_cost_count_status - 전자결재 상태 적용 - 도급비  */
UPDATE TBL_WORKING_SUBC_COST_COUNT A SET 
	EA_DOC_NO = #{DOC_NO},
	EA_FORM_ID = #{FORM_ID},
	EA_GW_ID = #{GW_ID},
	STATUS = #{DOC_STATUS},
	EA_DATE = #{DATE}
WHERE 1=1
AND CHECK_YYYYMM = REPLACE(#{CHECK_YYYYMM},'/','')
AND GUBUN_CODE = #{GUBUN_CODE}
</update>

<!-- 전자결재 소급비 조회 -->
<select id="working_reto_cost_count" resultType="java.util.LinkedHashMap">
/* oracle.yp_zwc_eai.working_reto_cost_count -전자결재 소급비 조회 */
SELECT 
	B.CODE_NAME AS VENDOR_NAME,
	B.REPRESENTATIVE AS REPRESENTATIVE,
	A.GUBUN_CODE,
	TO_CHAR(NVL(AMOUNT1, 0), 'FM9,999,999,999,999,999,999,999,999') AS AMOUNT1,
	TO_CHAR(NVL(AMOUNT2, 0), 'FM9,999,999,999,999,999,999,999,999') AS AMOUNT2,
	TO_CHAR(NVL(AMOUNT3, 0), 'FM9,999,999,999,999,999,999,999,999') AS AMOUNT3,
	TO_CHAR(NVL(SUB_TOTAL, 0), 'FM9,999,999,999,999,999,999,999,999') AS SUB_TOTAL,
	TO_CHAR(NVL(VAT, 0), 'FM9,999,999,999,999,999,999,999,999') AS VAT,
	TO_CHAR(NVL(TOTAL, 0), 'FM9,999,999,999,999,999,999,999,999') AS TOTAL,
	TO_CHAR(NVL(SAVE_MONEY_AMOUNT, 0), 'FM9,999,999,999,999,999,999,999,999') AS SAVE_MONEY_AMOUNT,
	TO_CHAR(NVL(RETROACT_AMOUNT, 0), 'FM9,999,999,999,999,999,999,999,999') AS RETROACT_AMOUNT,
	TO_CHAR(NVL(DIFF_AMOUNT, 0), 'FM9,999,999,999,999,999,999,999,999') AS DIFF_AMOUNT,
	TO_CHAR(NVL(PRE_RETROACT_AMOUNT, 0), 'FM9,999,999,999,999,999,999,999,999') AS PRE_RETROACT_AMOUNT
FROM TBL_WORKING_RETO_COST_COUNT A
LEFT OUTER JOIN TBL_WORKING_MASTER B
	ON A.VENDOR_CODE = B.CODE
WHERE 1=1
AND CHECK_YYYY = #{CHECK_YYYY}
AND GUBUN_CODE = #{GUBUN_CODE}
</select>

<update id="working_reto_cost_count_status">
/* oracle.yp_zwc_eai.working_reto_cost_count_status - 전자결재 상태 적용 - 소급비  */
UPDATE TBL_WORKING_RETO_COST_COUNT A SET 
	EA_DOC_NO = #{DOC_NO},
	EA_FORM_ID = #{FORM_ID},
	EA_GW_ID = #{GW_ID},
	STATUS = #{DOC_STATUS},
	EA_DATE = #{DATE}
WHERE 1=1
AND CHECK_YYYY = #{CHECK_YYYY}
AND GUBUN_CODE = #{GUBUN_CODE}
</update>

<update id="construction_chk_rpt_status">
/* oracle.yp_zwc_eai.construction_chk_rpt_status - 전자결재 상태 적용 - 정비용역 검수보고서  */
UPDATE TBL_CONSTRUCTION_CHK_RPT A SET 
	EA_DOC_NO = #{DOC_NO},
	EA_FORM_ID = #{FORM_ID},
	EA_GW_ID = #{GW_ID},
	STATUS = #{DOC_STATUS},
	EA_DATE = #{DATE}
WHERE 1=1
AND REPORT_CODE = #{REPORT_CODE}
</update>

<!-- 전자결재 소급비 조회 -->
<select id="construction_chk_rpt" resultType="java.util.LinkedHashMap">
/* oracle.yp_zwc_eai.construction_chk_rpt -전자결재 정비용역 검수보고서 조회 */
SELECT
	#{DEPT_NAME} AS DEPT_NAME, -- 상신자 부서
	A.INSPECTOR AS INSPECTOR, -- 검수자
	(SELECT S.CODE_NAME FROM TBL_WORKING_MASTER S WHERE SUBSTR(S.CODE, 1, 1) = 'V' AND S.CODE = B.VENDOR_CODE) AS VENDOR_NAME, -- 업체명
	B.PAY_STANDARD AS PAY_STANDARD, -- 계약구분(1:공사, 2:작업, 3:월정액)
	A.CHECK_BASE_DATE AS CHECK_BASE_DATE, -- 검수기준일
	TO_CHAR(TO_DATE(A.SUBCONTRACT_START_DATE, 'YYYY/MM/DD'), 'YYYY/MM/DD') AS SUBCONTRACT_START_DATE, -- 용역기간 시작일
	TO_CHAR(TO_DATE(A.SUBCONTRACT_END_DATE, 'YYYY/MM/DD'), 'YYYY/MM/DD') AS SUBCONTRACT_END_DATE, -- 용역기간 종료일
	TO_CHAR(NVL(A.SUBCONTRACT_AMOUNT, 0), 'FM9,999,999,999,999,999,999,999,999') AS SUBCONTRACT_AMOUNT, -- 금액
	A.REPORT_CODE AS REPORT_CODE -- 검수보고서번호
FROM TBL_CONSTRUCTION_CHK_RPT A
INNER JOIN TBL_CONSTRUCTION_SUBC B
	ON A.VENDOR_CODE = B.VENDOR_CODE
	AND A.CONTRACT_CODE = B.CONTRACT_CODE
WHERE 1=1
AND A.REPORT_CODE = #{REPORT_CODE}
</select>

<insert id="working_eai_log">
/* oracle.yp_zwc_eai.working_eai_log - 로깅  */
INSERT INTO TBL_EAI_LOG (
	SEQ,
	EA_DOC_NO,
	EA_FORM_ID,
	EA_GW_ID,
	EA_DOC_STATUS,
	EA_DATE,
	EA_PKSTR,
	EA_RESULT,
	EA_MESSAGE
)
SELECT
	NVL(MAX(A.SEQ), 0) + 1 AS SEQ,
	#{DOC_NO},
	#{FORM_ID},
	#{GW_ID},
	#{DOC_STATUS},
	#{DATE},
	#{PKSTR},
	#{RESULT},
	#{MESSAGE}
FROM TBL_EAI_LOG A
WHERE 1=1
</insert>

<select id="wsd_edoc_write" resultType="java.util.LinkedHashMap">
/* oracle.yp_zwc_eai.wsd_edoc_write -전자결재 작업표준서 */
SELECT A.TYPE1
	,A.TYPE2
	,A.CODE
	,A.DOC_TITLE
	,A.REG_DATE
	,A.REG_EMP
	,B.VERSION
	,B.IMG_URL
    ,B.IMG_NAME
FROM TBL_WORK_DOC A , TBL_WORK_DOC_VERSION B
WHERE A.CODE = B.CODE
  AND A.CODE = #{CODE}
  AND B.VERSION = #{VERSION}
</select>

</mapper>